<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MathCo Realtime Sales Reporting</title>
  <style>
    :root {
      --bg0: #f5f7fb;
      --bg1: #e9eef7;
      --ink: #142033;
      --muted: #51617a;
      --brand: #0b5fff;
      --card: #ffffff;
      --line: #d7dfeb;
      --accent: #e8f0ff;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Avenir Next", "Segoe UI", "Helvetica Neue", sans-serif;
      color: var(--ink);
      background:
        radial-gradient(1200px 600px at 10% -10%, #dce9ff 0%, transparent 60%),
        radial-gradient(1000px 500px at 100% 0%, #eef3ff 0%, transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height: 100vh;
    }

    .wrap {
      max-width: 1500px;
      margin: 24px auto;
      padding: 0 16px 28px;
      width: 100%;
    }

    .panel {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      box-shadow: 0 10px 26px rgba(21, 41, 74, 0.08);
      overflow: hidden;
    }

    .tabs {
      display: flex;
      gap: 8px;
      padding: 10px 12px;
      border-bottom: 1px solid var(--line);
      background: #f7faff;
      overflow-x: auto;
      overflow-y: hidden;
      flex-wrap: nowrap;
      scrollbar-width: thin;
    }

    .tab-btn {
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 7px 10px;
      background: #fff;
      color: #264069;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      flex: 0 0 auto;
    }

    .tab-btn.active {
      background: #0b5fff;
      color: #fff;
      border-color: #0b5fff;
    }

    .view {
      display: none;
    }

    .view.active {
      display: block;
    }

    .head {
      padding: 16px 18px;
      border-bottom: 1px solid var(--line);
      display: flex;
      gap: 16px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    h1 {
      margin: 0;
      font-size: 20px;
      letter-spacing: 0.2px;
    }

    .sub {
      color: var(--muted);
      font-size: 13px;
      margin-top: 4px;
    }

    .controls {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    label {
      font-size: 12px;
      color: var(--muted);
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      letter-spacing: 0.2px;
      text-transform: uppercase;
    }

    select {
      min-width: 240px;
      padding: 9px 10px;
      border-radius: 8px;
      border: 1px solid var(--line);
      font-size: 14px;
      background: #fff;
      color: var(--ink);
    }

    .stage-filter {
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #fff;
      padding: 8px 10px;
      min-width: 290px;
      max-width: 460px;
    }

    .stage-filter-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }

    .stage-filter-actions {
      display: flex;
      gap: 6px;
    }

    .stage-filter-actions button {
      border: 1px solid var(--line);
      border-radius: 7px;
      background: #f7faff;
      color: #264069;
      font-size: 11px;
      padding: 4px 7px;
      cursor: pointer;
    }

    .stage-options {
      max-height: 120px;
      overflow: auto;
      display: grid;
      gap: 4px;
    }

    .stage-option {
      display: flex;
      align-items: center;
      gap: 7px;
      color: #23344f;
      font-size: 12px;
    }

    .stage-option input {
      margin: 0;
    }

    .stats {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .chip {
      border: 1px solid var(--line);
      background: #fff;
      border-radius: 999px;
      padding: 7px 12px;
      font-size: 12px;
      color: #24324d;
    }

    .chip strong {
      color: var(--brand);
      margin-left: 4px;
    }

    .table-wrap {
      overflow: auto;
      max-height: 74vh;
    }

    table {
      width: max-content;
      min-width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 12px;
    }

    th, td {
      border-right: 1px solid var(--line);
      border-bottom: 1px solid var(--line);
      padding: 6px 9px;
      white-space: nowrap;
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    thead th {
      position: sticky;
      top: 0;
      z-index: 3;
      background: #f7faff;
      color: #1f2c45;
      font-weight: 700;
    }

    th:first-child, td:first-child {
      position: sticky;
      left: 0;
      z-index: 2;
      background: #fbfdff;
      text-align: left;
      font-weight: 600;
      min-width: 220px;
      max-width: 320px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    thead th:first-child { z-index: 4; background: #f1f6ff; }

    tbody tr:nth-child(even) td { background: #fcfdff; }

    tbody tr.total-row td {
      background: var(--accent);
      font-weight: 700;
    }

    tfoot td {
      background: #edf3ff;
      font-weight: 700;
    }

    td.clickable {
      cursor: pointer;
      transition: background 120ms ease;
    }

    td.clickable:hover {
      background: #e9f1ff !important;
    }

    td.carry-in {
      background: #fff1d6 !important;
      color: #5f3b00;
      font-weight: 700;
    }

    td.carry-in::after {
      content: " *";
      color: #8b4b00;
      font-weight: 800;
    }

    .detail-panel {
      margin: 14px 16px 16px;
      border: 1px solid var(--line);
      border-radius: 10px;
      overflow: hidden;
      background: #fff;
    }

    .detail-head {
      padding: 10px 12px;
      border-bottom: 1px solid var(--line);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      background: #f7faff;
    }

    .detail-title {
      font-size: 13px;
      font-weight: 700;
      color: #1f2c45;
    }

    .detail-meta {
      font-size: 12px;
      color: var(--muted);
    }

    .detail-wrap {
      max-height: 34vh;
      overflow: auto;
    }

    .detail-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 12px;
    }

    .detail-table th, .detail-table td {
      padding: 7px 10px;
      border-bottom: 1px solid #e7edf7;
      text-align: left;
      white-space: nowrap;
    }

    .detail-table th {
      position: sticky;
      top: 0;
      z-index: 1;
      background: #fbfdff;
      color: #294066;
    }

    .row-label {
      cursor: pointer;
    }

    .row-label:hover {
      background: #e9f1ff !important;
    }

    .funnel-wrap {
      padding: 14px 16px 16px;
      display: grid;
      grid-template-columns: repeat(2, minmax(320px, 1fr));
      gap: 12px;
    }

    .funnel-card {
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #fff;
      overflow: hidden;
    }

    .funnel-title {
      padding: 10px 12px;
      font-size: 13px;
      font-weight: 700;
      color: #1f2c45;
      border-bottom: 1px solid var(--line);
      background: #f9fbff;
    }

    .funnel-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .funnel-table th, .funnel-table td {
      padding: 7px 10px;
      border-bottom: 1px solid #e7edf7;
      text-align: left;
      white-space: nowrap;
    }

    .funnel-table th:nth-child(2), .funnel-table td:nth-child(2),
    .funnel-table th:nth-child(3), .funnel-table td:nth-child(3) {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    .funnel-foot {
      padding: 8px 10px;
      font-size: 12px;
      color: var(--muted);
      background: #fbfdff;
    }

    .funnel-controls {
      padding: 10px 16px 0;
      display: flex;
      align-items: flex-start;
      gap: 12px;
      flex-wrap: wrap;
    }

    .funnel-time {
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #fff;
      padding: 8px 10px;
      min-width: 280px;
    }

    .funnel-time-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }

    .funnel-time-value {
      font-size: 12px;
      color: #23406b;
      font-weight: 700;
    }

    .funnel-time input[type="range"] {
      width: 100%;
    }

    .funnel-filter {
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #fff;
      padding: 8px 10px;
      min-width: 320px;
      max-width: 520px;
    }

    .funnel-filter-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }

    .funnel-filter-actions {
      display: flex;
      gap: 6px;
    }

    .funnel-filter-actions button {
      border: 1px solid var(--line);
      border-radius: 7px;
      background: #f7faff;
      color: #264069;
      font-size: 11px;
      padding: 4px 7px;
      cursor: pointer;
    }

    .funnel-options {
      max-height: 120px;
      overflow: auto;
      display: grid;
      gap: 4px;
    }

    .funnel-option {
      display: flex;
      align-items: center;
      gap: 7px;
      color: #23344f;
      font-size: 12px;
    }

    .score-wrap {
      padding: 14px 16px 16px;
      display: grid;
      grid-template-columns: repeat(2, minmax(320px, 1fr));
      gap: 12px;
    }

    .score-card {
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #fff;
      overflow: hidden;
    }

    .score-head {
      padding: 10px 12px;
      border-bottom: 1px solid var(--line);
      background: #f9fbff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .score-name {
      font-size: 13px;
      font-weight: 700;
      color: #1f2c45;
    }

    .score-kpis {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 6px;
      padding: 10px 12px;
    }

    .score-mid {
      display: grid;
      grid-template-columns: 1.35fr 1fr;
      gap: 8px;
      padding: 10px 12px;
      border-bottom: 1px solid #e7edf7;
    }

    .kpi {
      border: 1px solid #e4ebf8;
      border-radius: 8px;
      padding: 7px 8px;
      background: #fcfdff;
    }

    .kpi.clickable-kpi {
      cursor: pointer;
      transition: background 120ms ease, border-color 120ms ease;
    }

    .kpi.clickable-kpi:hover {
      background: #eef4ff;
      border-color: #c8d8fa;
    }

    .kpi-label {
      font-size: 11px;
      color: var(--muted);
    }

    .kpi-value {
      font-size: 15px;
      font-weight: 700;
      color: #16305b;
      margin-top: 3px;
    }

    .funnel-shape {
      border: 1px solid #e4ebf8;
      border-radius: 8px;
      padding: 8px;
      background: #fcfdff;
    }

    .funnel-shape-title {
      font-size: 11px;
      color: #4b5f81;
      font-weight: 700;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.2px;
    }

    .funnel-shape-row {
      display: grid;
      grid-template-columns: minmax(150px, 210px) 1fr 42px;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
    }

    .funnel-shape-row:last-child {
      margin-bottom: 0;
    }

    .funnel-shape-label {
      font-size: 11px;
      color: #3f5477;
      font-weight: 700;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .funnel-shape-track {
      height: 12px;
      background: #edf2fb;
      border-radius: 999px;
      overflow: hidden;
    }

    .funnel-shape-fill {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, #6f96ff, #0b5fff);
    }

    .funnel-shape-value {
      font-size: 11px;
      color: #2e4266;
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    @media (max-width: 560px) {
      .funnel-shape-row {
        grid-template-columns: minmax(120px, 1fr) 1fr 38px;
      }
    }

    .score-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .score-table th, .score-table td {
      padding: 7px 10px;
      border-bottom: 1px solid #e7edf7;
      text-align: left;
      white-space: nowrap;
    }

    .score-table th:nth-child(2), .score-table td:nth-child(2) {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    .industry-wrap {
      padding: 14px 16px 16px;
      display: grid;
      grid-template-columns: repeat(2, minmax(320px, 1fr));
      gap: 12px;
    }

    .industry-card {
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #fff;
      overflow: hidden;
    }

    .industry-head {
      padding: 10px 12px;
      border-bottom: 1px solid var(--line);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      background: #f9fbff;
    }

    .industry-name {
      font-size: 13px;
      font-weight: 700;
      color: #1f2c45;
    }

    .industry-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .industry-table th, .industry-table td {
      padding: 7px 10px;
      border-bottom: 1px solid #e7edf7;
      text-align: left;
      vertical-align: top;
    }

    .industry-table th:nth-child(2), .industry-table td:nth-child(2) {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    .pill-list {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      max-width: 100%;
    }

    .pill {
      border: 1px solid #dce6f8;
      background: #f7faff;
      border-radius: 999px;
      padding: 2px 7px;
      font-size: 11px;
      color: #23406b;
      white-space: nowrap;
    }

    .wl-wrap {
      padding: 14px 16px 16px;
      display: grid;
      gap: 12px;
    }

    .wl-controls {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: end;
    }

    .wl-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 10px;
      overflow: hidden;
    }

    .wl-table th, .wl-table td {
      padding: 7px 10px;
      border-bottom: 1px solid #e7edf7;
      text-align: left;
      white-space: nowrap;
    }

    .wl-table th:nth-child(n+4), .wl-table td:nth-child(n+4) {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    .intro-wrap {
      padding: 14px 16px 16px;
      display: grid;
      gap: 12px;
    }

    .intro-controls {
      display: flex;
      align-items: end;
      gap: 12px;
      flex-wrap: wrap;
    }

    .chart-card {
      border: 1px solid var(--line);
      border-radius: 10px;
      background: linear-gradient(180deg, #ffffff 0%, #fbfdff 100%);
      overflow: hidden;
      padding: 10px;
    }

    .chart-svg {
      width: 100%;
      height: 360px;
      display: block;
    }

    .chart-axis {
      stroke: #b7c6e3;
      stroke-width: 1;
    }

    .chart-grid {
      stroke: #e3ebfb;
      stroke-width: 1;
    }

    .chart-line {
      fill: none;
      stroke: #0b5fff;
      stroke-width: 2.5;
    }

    .chart-point {
      fill: #0b5fff;
    }

    .chart-bar {
      fill: #6f96ff;
      cursor: pointer;
      transition: fill 120ms ease, opacity 120ms ease;
      opacity: 0.92;
    }

    .chart-bar:hover {
      fill: #0b5fff;
      opacity: 1;
    }

    .chart-bar-current {
      fill: #ff8a3d;
    }

    .chart-bar-current:hover {
      fill: #ff6f1a;
    }

    .chart-label {
      fill: #3a5685;
      font-size: 10.5px;
      font-family: "Avenir Next", "Segoe UI", sans-serif;
    }

    .chart-value-label {
      fill: #274777;
      font-size: 10px;
      font-weight: 700;
      font-family: "Avenir Next", "Segoe UI", sans-serif;
    }

    .chart-target {
      stroke: #d64545;
      stroke-width: 2;
      stroke-dasharray: 6 4;
    }

    .chart-target-label {
      fill: #a02f2f;
      font-size: 11px;
      font-family: "Avenir Next", "Segoe UI", sans-serif;
      font-weight: 700;
    }

    .chart-tooltip {
      position: fixed;
      pointer-events: none;
      z-index: 80;
      background: #0f2347;
      color: #fff;
      border-radius: 8px;
      padding: 6px 8px;
      font-size: 11px;
      line-height: 1.25;
      box-shadow: 0 8px 24px rgba(10, 19, 36, 0.28);
      display: none;
      white-space: nowrap;
    }

    .intro-detail {
      border: 1px solid var(--line);
      border-radius: 10px;
      overflow: hidden;
      background: #fff;
    }

    .intro-detail-head {
      padding: 10px 12px;
      border-bottom: 1px solid var(--line);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      background: #f7faff;
    }

    .intro-detail-title {
      font-size: 13px;
      font-weight: 700;
      color: #1f2c45;
    }

    .intro-detail-wrap {
      max-height: 34vh;
      overflow: auto;
    }

    .intro-detail-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .intro-detail-table th, .intro-detail-table td {
      padding: 7px 10px;
      border-bottom: 1px solid #e7edf7;
      text-align: left;
      white-space: nowrap;
    }

    .chat-wrap {
      padding: 14px 16px 16px;
      display: grid;
      gap: 12px;
    }

    .chat-shell {
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #fff;
      overflow: hidden;
    }

    .chat-messages {
      max-height: 54vh;
      overflow: auto;
      padding: 12px;
      background: #f8fbff;
      display: grid;
      gap: 10px;
    }

    .chat-msg {
      max-width: min(860px, 92%);
      border: 1px solid #dce7fb;
      border-radius: 10px;
      padding: 9px 10px;
      font-size: 12px;
      line-height: 1.45;
      white-space: pre-wrap;
    }

    .chat-msg.user {
      margin-left: auto;
      background: #eaf1ff;
      color: #15345f;
    }

    .chat-msg.assistant {
      margin-right: auto;
      background: #fff;
      color: #1d3358;
    }

    .chat-input-row {
      border-top: 1px solid #dce7fb;
      background: #fff;
      padding: 10px;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
    }

    .chat-input-row input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #cfdcf4;
      border-radius: 9px;
      font-size: 13px;
      color: #19345d;
    }

    .chat-input-row button {
      border: 1px solid #0b5fff;
      background: #0b5fff;
      color: #fff;
      border-radius: 9px;
      padding: 10px 14px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
    }

    .chat-suggest {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .chat-suggest button {
      border: 1px solid #d4def2;
      background: #fff;
      color: #214376;
      border-radius: 999px;
      font-size: 12px;
      padding: 6px 10px;
      cursor: pointer;
    }

    .chat-fab {
      position: fixed;
      right: 18px;
      bottom: 18px;
      z-index: 70;
      width: 54px;
      height: 54px;
      border-radius: 50%;
      border: 1px solid #0b5fff;
      background: #0b5fff;
      color: #fff;
      box-shadow: 0 12px 24px rgba(10, 34, 76, 0.28);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }

    .chat-fab img {
      width: 34px;
      height: 34px;
      object-fit: contain;
      display: block;
    }

    .chat-panel {
      position: fixed;
      right: 18px;
      bottom: 82px;
      width: min(480px, calc(100vw - 24px));
      max-height: min(72vh, 720px);
      display: none;
      flex-direction: column;
      z-index: 75;
      border: 1px solid #d9e6ff;
      border-radius: 12px;
      overflow: hidden;
      background: #fff;
      box-shadow: 0 20px 44px rgba(8, 25, 53, 0.28);
    }

    .chat-panel.open {
      display: flex;
    }

    .chat-panel-head {
      padding: 10px 12px;
      background: #f6f9ff;
      border-bottom: 1px solid #dce7fb;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-size: 13px;
      font-weight: 700;
      color: #1f3f75;
    }

    .chat-panel-head button {
      border: 1px solid #cddbf5;
      border-radius: 7px;
      background: #fff;
      color: #1f3f75;
      font-size: 12px;
      padding: 4px 8px;
      cursor: pointer;
    }

    .focus-badge {
      border: 1px solid #f1d8a6;
      background: #fff3db;
      color: #7a4b00;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 11px;
      font-weight: 700;
    }

    .watch-badge {
      border: 1px solid #d7def0;
      background: #eef3ff;
      color: #2c4675;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 11px;
      font-weight: 700;
    }

    .popup {
      position: fixed;
      inset: 0;
      background: rgba(12, 22, 38, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
      padding: 16px;
    }

    .popup.open {
      display: flex;
    }

    .popup-card {
      width: min(980px, 96vw);
      max-height: 84vh;
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 16px 40px rgba(14, 27, 45, 0.28);
    }

    .popup-head {
      padding: 10px 12px;
      border-bottom: 1px solid var(--line);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      background: #f7faff;
    }

    .popup-title {
      font-size: 13px;
      font-weight: 700;
      color: #1f2c45;
    }

    .popup-close {
      border: 1px solid var(--line);
      border-radius: 7px;
      background: #fff;
      color: #264069;
      font-size: 12px;
      padding: 5px 8px;
      cursor: pointer;
    }

    .popup-wrap {
      max-height: 72vh;
      overflow: auto;
    }

    .popup-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .popup-table th, .popup-table td {
      padding: 7px 10px;
      border-bottom: 1px solid #e7edf7;
      text-align: left;
      white-space: nowrap;
    }

    .popup-likelihood-select {
      min-width: 132px;
      font-size: 12px;
      padding: 5px 7px;
      border-radius: 7px;
      border: 1px solid #cfdbf4;
      color: #1f355b;
      background: #fff;
    }

    .likelihood-grid {
      margin-top: 8px;
      display: grid;
      gap: 10px;
      grid-template-columns: repeat(3, minmax(250px, 1fr));
    }

    .likelihood-table-card {
      border: 1px solid #e2eaf9;
      border-radius: 9px;
      overflow: hidden;
      background: #fff;
    }

    .likelihood-table-head {
      padding: 8px 10px;
      border-bottom: 1px solid #e7edf7;
      background: #f8fbff;
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
    }

    .likelihood-table-title {
      font-size: 12px;
      font-weight: 700;
      color: #1f3f75;
    }

    .likelihood-table-meta {
      font-size: 11px;
      color: #34507d;
      font-variant-numeric: tabular-nums;
    }

    .likelihood-table-wrap {
      border-top: 1px solid #e7edf7;
      background: #fcfdff;
      overflow: hidden;
    }

    .likelihood-mini-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      font-size: 12px;
      color: #1e345a;
    }

    .likelihood-mini-table th, .likelihood-mini-table td {
      padding: 7px 8px;
      border-bottom: 1px solid #e8eef8;
      vertical-align: top;
      overflow-wrap: anywhere;
    }

    .likelihood-mini-table th {
      background: #f3f7ff;
      color: #274777;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.2px;
    }

    .likelihood-mini-table td:nth-child(1), .likelihood-mini-table th:nth-child(1) {
      width: 40%;
      white-space: normal;
      word-break: break-word;
      line-height: 1.35;
      font-weight: 600;
    }

    .likelihood-mini-table td:nth-child(2), .likelihood-mini-table th:nth-child(2) {
      width: 28%;
      white-space: normal;
      word-break: break-word;
      line-height: 1.35;
      color: #335484;
    }

    .likelihood-mini-table td:nth-child(3), .likelihood-mini-table th:nth-child(3) {
      width: 16%;
      text-align: right;
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
    }

    .likelihood-mini-table td:nth-child(4), .likelihood-mini-table th:nth-child(4) {
      width: 16%;
      text-align: right;
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
    }

    /* Allow header text to wrap so columns don't overlap. */
    .likelihood-mini-table th {
      white-space: normal;
      word-break: break-word;
      line-height: 1.2;
    }

    /* Override the nowrap from nth-child rules (keep cells nowrap, allow headers to wrap). */
    .likelihood-mini-table th:nth-child(3),
    .likelihood-mini-table th:nth-child(4) {
      white-space: normal;
    }

    .target-controls {
      display: flex;
      align-items: end;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .target-controls > div {
      min-width: 300px;
      flex: 1 1 320px;
    }

    .target-controls input {
      width: 100%;
      min-width: 0;
      padding: 10px 11px;
      border-radius: 8px;
      border: 1px solid var(--line);
      font-size: 14px;
      color: var(--ink);
      background: #fff;
    }

    .target-controls button {
      border: 1px solid #0b5fff;
      border-radius: 8px;
      padding: 10px 12px;
      background: #0b5fff;
      color: #fff;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      height: 40px;
    }

    .target-grid-table {
      width: 100%;
      min-width: 840px;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 12px;
    }

    .target-grid-table th, .target-grid-table td {
      border-right: 1px solid var(--line);
      border-bottom: 1px solid var(--line);
      padding: 7px 8px;
      text-align: left;
      white-space: nowrap;
      background: #fff;
    }

    .target-grid-table th:first-child, .target-grid-table td:first-child {
      border-left: 1px solid var(--line);
      position: sticky;
      left: 0;
      z-index: 1;
      background: #f9fbff;
      font-weight: 700;
    }

    .target-grid-table thead th {
      border-top: 1px solid var(--line);
      background: #f6f9ff;
      color: #1f3f75;
      text-align: center;
    }

    .target-grid-table .target-subhead {
      font-size: 11px;
      font-weight: 600;
      color: #315081;
    }

    .target-grid-table input {
      width: 110px;
      padding: 6px 7px;
      border: 1px solid #d2ddf1;
      border-radius: 6px;
      font-size: 12px;
      color: #1f355b;
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    .target-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 12px;
    }

    .target-table th, .target-table td {
      border-right: 1px solid var(--line);
      border-bottom: 1px solid var(--line);
      padding: 7px 9px;
      text-align: left;
      white-space: nowrap;
    }

    .target-table th:first-child, .target-table td:first-child {
      border-left: 1px solid var(--line);
    }

    .target-table thead th {
      border-top: 1px solid var(--line);
      background: #f6f9ff;
      color: #1f3f75;
    }

    .target-table td:nth-child(3), .target-table td:nth-child(4) {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    .target-table button {
      border: 1px solid #d3dcec;
      border-radius: 6px;
      background: #fff;
      color: #264069;
      font-size: 11px;
      padding: 4px 7px;
      cursor: pointer;
    }

    .footnote {
      padding: 10px 18px 14px;
      font-size: 12px;
      color: var(--muted);
      border-top: 1px solid var(--line);
    }

    .error {
      margin: 12px 0;
      padding: 10px 12px;
      border: 1px solid #f1c6c6;
      border-radius: 10px;
      background: #fff6f6;
      color: #821d1d;
      font-size: 13px;
    }

    .insight {
      margin: 10px 16px 0;
      border: 1px solid #dbe7ff;
      background: linear-gradient(180deg, #f9fbff, #f3f7ff);
      border-radius: 10px;
      padding: 10px 12px;
    }

    .insight-title {
      font-size: 12px;
      font-weight: 700;
      color: #1f3f75;
      text-transform: uppercase;
      letter-spacing: 0.2px;
      margin-bottom: 6px;
    }

    .insight-list {
      margin: 0;
      padding-left: 18px;
      color: #213555;
      font-size: 12px;
      line-height: 1.4;
    }

    .topbar {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      flex-wrap: wrap;
    }

    .topbar-right {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      margin-left: auto;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .brand-mark {
      width: 22px;
      height: 22px;
      flex: 0 0 auto;
      display: block;
      object-fit: contain;
    }

    .brand-name {
      font-weight: 800;
      letter-spacing: 0.2px;
      color: #142033;
      font-size: 13px;
      white-space: nowrap;
    }

    .app-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .topbar-hint {
      display: none;
      color: #6b7ea4;
      font-size: 11px;
      white-space: nowrap;
    }

    .app-version {
      border: 1px solid #d3e0ff;
      background: #eef4ff;
      color: #1f3f75;
      border-radius: 999px;
      padding: 3px 7px;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.2px;
      white-space: nowrap;
    }

    .version-switch {
      display: flex;
      align-items: center;
      gap: 5px;
      color: #274777;
      font-size: 10px;
      font-weight: 700;
    }

    .version-switch select {
      border: 1px solid #d3e0ff;
      border-radius: 8px;
      background: #fff;
      color: #244777;
      font-size: 10px;
      padding: 3px 7px;
      min-width: 150px;
    }

    .profile {
      position: relative;
      display: none;
      align-items: center;
      gap: 8px;
    }

    .profile-btn {
      border: 1px solid #d3e0ff;
      background: #eef4ff;
      border-radius: 999px;
      padding: 4px 6px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      color: #1f3f75;
    }

    .profile-avatar {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: #fff;
      border: 1px solid #c9d8fb;
      display: grid;
      place-items: center;
      font-weight: 900;
      font-size: 12px;
      color: #203a66;
      flex: 0 0 auto;
    }

    .profile-meta {
      display: none;
      flex-direction: column;
      align-items: flex-start;
      line-height: 1.15;
      gap: 1px;
      padding-right: 2px;
    }

    .profile-user {
      font-size: 11px;
      font-weight: 800;
      color: #1a2f52;
      white-space: nowrap;
      max-width: 150px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .profile-role {
      font-size: 10px;
      font-weight: 700;
      color: #5d739d;
      text-transform: uppercase;
      letter-spacing: 0.2px;
      white-space: nowrap;
    }

    .profile-pop {
      position: absolute;
      right: 0;
      top: calc(100% + 8px);
      width: 260px;
      background: #fff;
      border: 1px solid #dbe7ff;
      border-radius: 12px;
      box-shadow: 0 14px 34px rgba(21, 41, 74, 0.14);
      padding: 10px;
      z-index: 50;
      display: none;
    }

    .profile.open .profile-pop { display: block; }

    .profile-pop .row {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
      padding: 6px 8px;
      border-radius: 10px;
    }

    .profile-pop .row.small {
      padding: 2px 8px 8px;
      color: #6b7ea4;
      font-size: 10px;
      font-weight: 700;
    }

    .profile-pop .divider {
      height: 1px;
      background: #e7efff;
      margin: 6px 0;
    }

    .profile-pop button {
      width: 100%;
      border: 1px solid #dbe7ff;
      background: #f7faff;
      color: #1f3f75;
      font-weight: 800;
      font-size: 12px;
      padding: 9px 10px;
      border-radius: 10px;
      cursor: pointer;
      text-align: left;
    }

    .profile-pop button:hover { background: #eef4ff; }

    @media (min-width: 880px) {
      .profile-meta { display: flex; }
    }

    .auth-gate {
      max-width: 520px;
      margin: 30px auto;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      box-shadow: 0 10px 26px rgba(21, 41, 74, 0.08);
      padding: 18px;
    }

    .auth-brand {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 0 0 10px;
    }

    .auth-brand .brand-mark { width: 34px; height: 34px; }
    .auth-brand .brand-name { font-size: 18px; }

    .auth-gate h2 {
      margin: 0 0 6px;
      font-size: 22px;
      color: #1a2f52;
    }

    .auth-gate .sub {
      margin-bottom: 14px;
    }

    .auth-form {
      display: grid;
      gap: 10px;
    }

    .auth-form input, .auth-form select {
      width: 100%;
      min-width: 0;
      padding: 10px 11px;
      border-radius: 8px;
      border: 1px solid var(--line);
      font-size: 14px;
      color: var(--ink);
      background: #fff;
    }

    .auth-form button {
      border: 1px solid #0b5fff;
      border-radius: 8px;
      padding: 10px 12px;
      background: #0b5fff;
      color: #fff;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
    }

    .auth-note {
      margin-top: 10px;
      padding: 9px 10px;
      background: #fff8e6;
      border: 1px solid #ffe3a3;
      border-radius: 8px;
      color: #6a5200;
      font-size: 12px;
      line-height: 1.35;
    }

    .auth-error {
      color: #a11919;
      font-size: 12px;
      margin-top: 8px;
      min-height: 16px;
    }

    .sync-meta {
      margin-top: 6px;
      padding: 8px 10px;
      border: 1px solid #dbe7ff;
      border-radius: 8px;
      background: #f7faff;
      color: #274777;
      font-size: 12px;
      line-height: 1.4;
      white-space: pre-wrap;
      overflow-wrap: anywhere;
      word-break: break-word;
    }

    .admin-wrap {
      padding: 16px;
      display: grid;
      gap: 14px;
      min-width: 0;
    }

    .admin-card {
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #fff;
      padding: 12px;
      min-width: 0;
    }

    .admin-grid {
      display: grid;
      gap: 10px;
      grid-template-columns: repeat(3, minmax(170px, 1fr));
      align-items: end;
      min-width: 0;
    }

    .admin-grid > * {
      min-width: 0;
    }

    .admin-grid input,
    .admin-grid select,
    .admin-grid button {
      width: 100%;
      min-width: 0;
      box-sizing: border-box;
    }

    .admin-grid .span-2 {
      grid-column: span 2;
    }

    .admin-grid button {
      border: 1px solid #0b5fff;
      border-radius: 8px;
      padding: 10px 12px;
      background: #0b5fff;
      color: #fff;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      height: 40px;
    }

    .admin-table {
      width: 100%;
      min-width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 12px;
    }

    .admin-table th, .admin-table td {
      border-right: 1px solid var(--line);
      border-bottom: 1px solid var(--line);
      padding: 7px 9px;
      text-align: left;
      white-space: nowrap;
    }

    .admin-table th:first-child, .admin-table td:first-child {
      border-left: 1px solid var(--line);
    }

    .admin-table thead th {
      border-top: 1px solid var(--line);
      background: #f6f9ff;
      color: #1f3f75;
    }

    .admin-table-wrap {
      overflow: auto;
      max-width: 100%;
    }

    .admin-table button {
      border: 1px solid #d3dcec;
      border-radius: 6px;
      background: #fff;
      color: #264069;
      font-size: 11px;
      padding: 4px 7px;
      cursor: pointer;
    }

    .momentum-wrap {
      padding: 12px 16px 16px;
      display: grid;
      gap: 12px;
    }

    .momentum-cards {
      display: grid;
      grid-template-columns: repeat(2, minmax(280px, 1fr));
      gap: 10px;
    }

    .momentum-card {
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #fff;
      padding: 10px 12px;
      display: grid;
      gap: 6px;
    }

    .momentum-card-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .momentum-seller {
      font-size: 15px;
      font-weight: 700;
      color: #16386a;
    }

    .momentum-status {
      border-radius: 999px;
      padding: 3px 8px;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.2px;
    }

    .momentum-status.positive {
      background: #e9fbef;
      border: 1px solid #b9e8c7;
      color: #1e7a3f;
    }

    .momentum-status.negative {
      background: #ffefef;
      border: 1px solid #f2c5c5;
      color: #ad2d2d;
    }

    .momentum-status.stalled {
      background: #f4f6fb;
      border: 1px solid #dce3f0;
      color: #3d4f70;
    }

    .momentum-kpis {
      display: grid;
      grid-template-columns: repeat(4, minmax(90px, 1fr));
      gap: 6px;
    }

    .momentum-kpi {
      border: 1px solid #dbe4f3;
      border-radius: 8px;
      background: #fbfdff;
      padding: 6px 8px;
      cursor: pointer;
      transition: background 120ms ease;
    }

    .momentum-kpi:hover {
      background: #eef4ff;
    }

    .momentum-kpi.active {
      border-color: #9fbcf6;
      background: #e8f0ff;
    }

    .momentum-card.clickable {
      cursor: pointer;
    }

    .momentum-card.clickable:hover {
      border-color: #afc6f7;
    }

    .momentum-kpi-label {
      color: #587097;
      font-size: 11px;
      margin-bottom: 2px;
    }

    .momentum-kpi-value {
      color: #1c3f70;
      font-size: 15px;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
    }

    .momentum-definition {
      border: 1px solid #dbe7ff;
      background: linear-gradient(180deg, #f9fbff, #f3f7ff);
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 12px;
      color: #1f3558;
      line-height: 1.45;
    }

    .momentum-definition strong {
      color: #173f77;
    }

    .momentum-detail {
      border: 1px solid var(--line);
      border-radius: 10px;
      overflow: hidden;
      background: #fff;
    }

    .momentum-detail-head {
      padding: 10px 12px;
      border-bottom: 1px solid var(--line);
      background: #f8fbff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .momentum-detail-title {
      font-size: 13px;
      font-weight: 700;
      color: #1d3f72;
    }

    .momentum-detail-wrap {
      max-height: 34vh;
      overflow: auto;
    }

    .momentum-detail-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 12px;
    }

    .momentum-detail-table th, .momentum-detail-table td {
      padding: 7px 10px;
      border-bottom: 1px solid #e7edf7;
      white-space: nowrap;
      text-align: left;
    }

    .momentum-detail-table th {
      position: sticky;
      top: 0;
      z-index: 1;
      background: #fbfdff;
      color: #294066;
      font-weight: 700;
    }

    .forecast-wrap {
      padding: 12px 16px 16px;
      display: grid;
      gap: 10px;
    }

    .forecast-table {
      width: 100%;
      min-width: 980px;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 13px;
    }

    .forecast-table th, .forecast-table td {
      border-right: 1px solid #dbe3f1;
      border-bottom: 1px solid #dbe3f1;
      padding: 9px 12px;
      text-align: right;
      white-space: nowrap;
      font-variant-numeric: tabular-nums;
      background: #fff;
    }

    .forecast-table th:first-child, .forecast-table td:first-child {
      text-align: left;
      border-left: 1px solid #dbe3f1;
      min-width: 160px;
    }

    .forecast-table thead th {
      background: #1f3f75;
      color: #fff;
      font-size: 16px;
      font-weight: 800;
      border-top: 1px solid #1f3f75;
      border-color: #3b5f9c;
    }

    .forecast-table tbody tr:nth-child(odd) td {
      background: #fbfcff;
    }

    .forecast-table .risk-row td {
      background: #dbeafe;
      font-weight: 800;
      font-size: 15px;
    }

    .forecast-table .target-row td {
      background: #d8f2ea;
      font-weight: 800;
      font-size: 15px;
    }

    .forecast-table .gap-row td {
      background: #eef3fb;
      font-weight: 800;
      font-size: 15px;
    }

    .forecast-clickable {
      cursor: pointer;
    }

    .forecast-clickable:hover {
      background: #e9f1ff !important;
    }

    .forecast-detail {
      border: 1px solid var(--line);
      border-radius: 10px;
      overflow: hidden;
      background: #fff;
    }

    .forecast-detail-head {
      padding: 10px 12px;
      border-bottom: 1px solid var(--line);
      background: #f8fbff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .forecast-detail-title {
      font-size: 13px;
      font-weight: 700;
      color: #1d3f72;
    }

    .forecast-detail-wrap {
      max-height: 32vh;
      overflow: auto;
    }

    .forecast-detail-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 12px;
    }

    .forecast-detail-table th, .forecast-detail-table td {
      padding: 7px 10px;
      border-bottom: 1px solid #e7edf7;
      white-space: nowrap;
      text-align: left;
    }

    .forecast-detail-table th {
      position: sticky;
      top: 0;
      z-index: 1;
      background: #fbfdff;
      color: #294066;
      font-weight: 700;
    }

    .assumptions-wrap {
      padding: 14px 16px 16px;
      display: grid;
      gap: 12px;
    }

    .assumption-card {
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #fff;
      overflow: hidden;
    }

    .assumption-head {
      padding: 10px 12px;
      border-bottom: 1px solid var(--line);
      background: #f7faff;
      font-size: 13px;
      font-weight: 700;
      color: #1f3f75;
      text-transform: uppercase;
      letter-spacing: 0.2px;
    }

    .assumption-body {
      padding: 10px 12px;
      font-size: 13px;
      color: #1f3353;
      line-height: 1.45;
    }

    .assumption-body code {
      background: #eef4ff;
      border: 1px solid #d7e4ff;
      border-radius: 6px;
      padding: 1px 5px;
      font-size: 12px;
    }

    .cycle-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    .cycle-card {
      border: 1px solid var(--line);
      border-radius: 10px;
      overflow: hidden;
      background: #fff;
    }

    .cycle-card .title {
      padding: 10px 12px;
      border-bottom: 1px solid var(--line);
      background: #f7faff;
      font-size: 13px;
      font-weight: 700;
      color: #1f3f75;
    }

    .cycle-sortable {
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
    }

    .cycle-sortable.active {
      color: #163d7a;
      text-decoration: underline;
      text-underline-offset: 3px;
    }

    .cycle-filter-row th {
      background: #f8fbff;
      padding: 6px 8px;
    }

    .cycle-filter-row input {
      width: 100%;
      box-sizing: border-box;
      border: 1px solid var(--line);
      border-radius: 6px;
      padding: 6px 7px;
      font-size: 12px;
      color: #213a63;
      background: #fff;
    }

    .gap-neg {
      color: #0f6a39;
    }

    .gap-pos {
      color: #b10202;
    }

    @media (max-width: 980px) {
      .wrap {
        margin: 12px auto;
        padding: 0 8px 16px;
      }

      .tabs {
        padding: 8px;
      }

      .admin-grid {
        grid-template-columns: 1fr;
      }

      .admin-grid .span-2 {
        grid-column: span 1;
      }

      .likelihood-grid {
        grid-template-columns: 1fr;
      }

      .momentum-cards {
        grid-template-columns: 1fr;
      }

      .momentum-kpis {
        grid-template-columns: repeat(2, minmax(100px, 1fr));
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div id="error" class="error" style="display:none;"></div>
    <svg width="0" height="0" style="position:absolute; left:-9999px; top:-9999px;" aria-hidden="true" focusable="false">
      <defs>
        <!-- MathCo logo mark (exact geometry from provided asset) -->
        <symbol id="mathco-logo" viewBox="0 0 256 256">
          <rect width="256" height="256" fill="none"/>
          <g fill="none" stroke="#14005f" stroke-linecap="round" stroke-width="24">
            <path d="M128 12v78"/>
            <path d="M18 70l58 32"/>
            <path d="M238 70l-58 32"/>
            <path d="M22 182l92-50"/>
            <path d="M234 182l-92-50"/>
            <path d="M128 244v-52"/>
          </g>
        </symbol>
      </defs>
    </svg>
    <div id="auth-gate" class="auth-gate" style="display:none;">
      <div class="auth-brand">
        <img class="brand-mark" src="assets/mathco-logo.svg" alt="MathCo logo"/>
        <div class="brand-name">MathCo Realtime Sales Reporting</div>
      </div>
      <h2>Sales Dashboard Access</h2>
      <div id="auth-sub" class="sub"></div>
      <form id="auth-login-form" class="auth-form" autocomplete="off" style="display:none;">
        <div>
          <label for="auth-login-user">Username</label>
          <input id="auth-login-user" type="text" placeholder="username" required />
        </div>
        <div>
          <label for="auth-login-pass">Password</label>
          <input id="auth-login-pass" type="password" placeholder="password" required />
        </div>
        <button type="submit">Sign In</button>
      </form>
      <form id="auth-setup-form" class="auth-form" autocomplete="off" style="display:none;">
        <div>
          <label for="auth-setup-user">Admin Username</label>
          <input id="auth-setup-user" type="text" placeholder="your username" required />
        </div>
        <div>
          <label for="auth-setup-pass">Admin Password</label>
          <input id="auth-setup-pass" type="password" placeholder="strong password" required />
        </div>
        <div>
          <label for="auth-setup-pass2">Confirm Password</label>
          <input id="auth-setup-pass2" type="password" placeholder="confirm password" required />
        </div>
        <button type="submit">Create Admin & Continue</button>
      </form>
      <div id="auth-error" class="auth-error"></div>
      <div class="auth-note">
        Sign-in is validated against the shared Supabase backend. First successful login bootstraps admin if no users exist yet.
      </div>
    </div>
    <div class="panel" id="app" style="display:none;">
      <div class="topbar">
        <div class="brand">
          <img class="brand-mark" src="assets/mathco-logo.svg" alt="MathCo logo"/>
          <div class="brand-name">MathCo Realtime Sales Reporting</div>
        </div>
        <div class="topbar-right">
          <label class="version-switch">
            <span>Viewing:</span>
            <select id="version-select"></select>
          </label>
          <div id="profile" class="profile">
            <button id="profile-btn" class="profile-btn" type="button" aria-haspopup="menu" aria-expanded="false">
              <span id="profile-avatar" class="profile-avatar" aria-hidden="true">U</span>
              <span class="profile-meta">
                <span id="profile-user" class="profile-user">user</span>
                <span id="profile-role" class="profile-role">viewer</span>
              </span>
            </button>
            <div id="profile-pop" class="profile-pop" role="menu" aria-label="Profile menu">
              <div class="row">
                <div style="font-weight:900;color:#1a2f52;">MathCo Realtime Sales Reporting</div>
              </div>
              <div class="row small">
                <div>App version</div>
                <div id="profile-version">v-</div>
              </div>
              <div class="divider"></div>
              <button id="profile-admin" type="button" style="display:none;">Admin</button>
              <button id="profile-logout" type="button">Logout</button>
            </div>
          </div>
        </div>
      </div>
      <div class="tabs tabs-main">
        <button id="tab-scorecard" class="tab-btn active" type="button">Weekly Scorecard</button>
        <button id="tab-introtrend" class="tab-btn" type="button">Call Trends</button>
        <button id="tab-forecast" class="tab-btn" type="button">Revenue Forecast</button>
        <button id="tab-appendix" class="tab-btn" type="button" aria-expanded="false">Appendix</button>
        <button id="tab-admin" class="tab-btn" type="button" style="display:none;">Admin</button>
      </div>
      <div id="tabs-appendix" class="tabs tabs-appendix" style="display:none;">
        <button id="tab-crosstab" class="tab-btn" type="button">Crosstab</button>
        <button id="tab-funnel" class="tab-btn" type="button">Funnel Metrics</button>
        <button id="tab-industry" class="tab-btn" type="button">Industry Action</button>
        <button id="tab-winloss" class="tab-btn" type="button">Won/Lost Sources</button>
        <button id="tab-compare" class="tab-btn" type="button">Version Compare</button>
        <button id="tab-momentum" class="tab-btn" type="button">Funnel Momentum</button>
        <button id="tab-cycletime" class="tab-btn" type="button">Cycle Time</button>
        <button id="tab-assumptions" class="tab-btn" type="button">Assumptions & Logic</button>
      </div>

      <div id="view-crosstab" class="view">
        <div class="head">
          <div>
            <h1>Deal Stage x Intro Month Crosstab</h1>
            <div class="sub">Data source: <code>Deals_1770357609.xlsx</code> | Stage from <code>BF</code> | Intro date from <code>AF</code> | Intro Date cutoff: <code>&gt;= 2024-10-01</code> (column <code>AF</code>)</div>
          </div>
          <div class="controls">
            <div>
              <label for="seller">Seller View</label>
              <select id="seller"></select>
            </div>
            <div class="stage-filter">
              <div class="stage-filter-head">
                <label for="stage-options" style="margin:0;">Deal Stage Filter</label>
                <div class="stage-filter-actions">
                  <button type="button" id="stage-matter">Matter Stages</button>
                  <button type="button" id="stage-all">All</button>
                </div>
              </div>
              <div id="stage-options" class="stage-options"></div>
            </div>
            <div class="stats" id="stats"></div>
          </div>
        </div>
        <div class="table-wrap">
          <table id="pivot"></table>
        </div>
        <div class="insight">
          <div class="insight-title">Key Insights</div>
          <ul id="insight-crosstab" class="insight-list"></ul>
        </div>
        <div class="detail-panel">
          <div class="detail-head">
            <div id="detail-title" class="detail-title">Details</div>
            <div id="detail-meta" class="detail-meta">Select any crosstab cell or stage row to load deals.</div>
          </div>
          <div class="detail-wrap">
            <table class="detail-table" id="detail-table">
              <thead>
                <tr>
                  <th>Deal Name</th>
                  <th>Stage</th>
                  <th>Intro Month</th>
                </tr>
              </thead>
              <tbody id="detail-body"></tbody>
            </table>
          </div>
        </div>
        <div class="footnote">Filtered to deals with Intro Date &gt;= 2024-10-01. "All (unique deals)" counts each deal once if any of the target sellers appears in owner. Seller-specific views count deals where owner contains that seller name.</div>
      </div>

      <div id="view-funnel" class="view">
        <div class="head">
          <div>
            <h1>Current Funnel Snapshot</h1>
            <div class="sub">All stages available | Intro Date cutoff <code>&gt;= 2024-10-01</code></div>
          </div>
        </div>
        <div class="funnel-controls">
          <div class="funnel-time">
            <div class="funnel-time-head">
              <label for="funnel-time-slider" style="margin:0;">Intro Cutoff</label>
              <div id="funnel-time-value" class="funnel-time-value">-</div>
            </div>
            <input id="funnel-time-slider" type="range" min="0" max="0" value="0" />
          </div>
          <div class="funnel-filter">
            <div class="funnel-filter-head">
              <label for="funnel-options" style="margin:0;">Funnel Stage Filter</label>
              <div class="funnel-filter-actions">
                <button type="button" id="funnel-core">Core 1-6</button>
                <button type="button" id="funnel-all">All</button>
              </div>
            </div>
            <div id="funnel-options" class="funnel-options"></div>
          </div>
        </div>
        <div class="insight">
          <div class="insight-title">Key Insights</div>
          <ul id="insight-funnel" class="insight-list"></ul>
        </div>
        <div id="funnel-wrap" class="funnel-wrap"></div>
        <div class="footnote">Conversion to next stage is calculated from reached counts across selected stages: <code>Reached(next) / Reached(current)</code>.</div>
      </div>

      <div id="view-scorecard" class="view active">
        <div class="head">
          <div>
            <h1>Weekly Scorecard</h1>
            <div class="sub">Same data rules as crosstab/funnel.</div>
          </div>
          <div class="controls">
            <div>
              <label for="scorecard-seller">Seller View</label>
              <select id="scorecard-seller"></select>
            </div>
          </div>
        </div>
        <div class="insight">
          <div class="insight-title">Key Insights</div>
          <ul id="insight-scorecard" class="insight-list"></ul>
        </div>
        <div id="score-wrap" class="score-wrap"></div>
      </div>

      <div id="view-industry" class="view">
        <div class="head">
          <div>
            <h1>Industry Action by Seller</h1>
            <div class="sub">Where activity is concentrated by industry, logo, and business function for each seller.</div>
          </div>
          <div class="controls">
            <div class="funnel-time" style="min-width:260px;">
              <div class="funnel-time-head">
                <label for="industry-time-slider" style="margin:0;">Intro Cutoff</label>
                <div id="industry-time-value" class="funnel-time-value">-</div>
              </div>
              <input id="industry-time-slider" type="range" min="0" max="0" value="0" />
            </div>
          </div>
        </div>
        <div class="insight">
          <div class="insight-title">Key Insights</div>
          <ul id="insight-industry" class="insight-list"></ul>
        </div>
        <div id="industry-wrap" class="industry-wrap"></div>
        <div class="footnote">Same inclusion rules as other tabs. Top logos/functions are shown per industry row.</div>
      </div>

      <div id="view-winloss" class="view">
        <div class="head">
          <div>
            <h1>Won/Lost Source Analysis</h1>
            <div class="sub">Where wins and losses are concentrated by Industry, Logo, and Business Function.</div>
          </div>
        </div>
        <div class="insight">
          <div class="insight-title">Key Insights</div>
          <ul id="insight-winloss" class="insight-list"></ul>
        </div>
        <div class="wl-wrap">
          <div class="wl-controls">
            <div>
              <label for="wl-seller">Scope</label>
              <select id="wl-seller"></select>
            </div>
            <div class="funnel-time" style="min-width:260px;">
              <div class="funnel-time-head">
                <label for="wl-time-slider" style="margin:0;">Intro Cutoff</label>
                <div id="wl-time-value" class="funnel-time-value">-</div>
              </div>
              <input id="wl-time-slider" type="range" min="0" max="0" value="0" />
            </div>
            <div class="stats" id="wl-stats"></div>
          </div>
          <table class="wl-table" id="wl-table">
            <thead>
              <tr>
                <th>Industry</th>
                <th>Logo</th>
                <th>Business Function</th>
                <th>Won</th>
                <th>Lost</th>
                <th>Total</th>
                <th>Win Rate</th>
                <th>Focus</th>
              </tr>
            </thead>
            <tbody id="wl-body"></tbody>
          </table>
        </div>
        <div class="footnote">Use high-volume high-loss rows as primary strategic focus for next year; defend high-volume high-win rows as repeatable plays.</div>
      </div>

      <div id="view-introtrend" class="view">
        <div class="head">
          <div>
            <h1>Weekly Intro Calls Trend</h1>
            <div class="sub">Uses Intro Meeting Date (<code>AF</code>), excludes deals in <code>No Show/ Reschedule</code>, and follows the same inclusion filters as other tabs.</div>
          </div>
        </div>
        <div class="insight">
          <div class="insight-title">Key Insights</div>
          <ul id="insight-introtrend" class="insight-list"></ul>
        </div>
        <div class="intro-wrap">
          <div class="intro-controls">
            <div>
              <label for="intro-seller">Seller Scope</label>
              <select id="intro-seller"></select>
            </div>
            <div>
              <label for="intro-granularity">Granularity</label>
              <select id="intro-granularity">
                <option value="week">Week</option>
                <option value="month">Month</option>
              </select>
            </div>
            <div class="stats" id="intro-stats"></div>
          </div>
          <div class="chart-card">
            <svg id="intro-chart" class="chart-svg" viewBox="0 0 1000 360" preserveAspectRatio="none"></svg>
          </div>
          <div class="intro-detail">
            <div class="intro-detail-head">
              <div id="intro-detail-title" class="intro-detail-title">Intro Deals</div>
              <div id="intro-detail-meta" class="detail-meta">Click a bar to load deals.</div>
            </div>
            <div class="intro-detail-wrap">
              <table class="intro-detail-table">
                <thead>
                  <tr>
                    <th>Deal</th>
                    <th>Intro Date</th>
                    <th>Stage</th>
                    <th>Seller</th>
                  </tr>
                </thead>
                <tbody id="intro-detail-body"></tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="footnote">Week buckets are Monday-start weeks based on column <code>AF</code>.</div>
      </div>

      <div id="view-compare" class="view">
        <div class="head">
          <div>
            <h1>Version Compare</h1>
            <div class="sub">Compare any two refresh snapshots for stage movement and stuck/help-needed deltas.</div>
          </div>
          <div class="controls">
            <div>
              <label for="compare-left">Left Version</label>
              <select id="compare-left"></select>
            </div>
            <div>
              <label for="compare-right">Right Version</label>
              <select id="compare-right"></select>
            </div>
            <div>
              <label>&nbsp;</label>
              <button id="compare-prev" type="button">Compare vs Previous</button>
            </div>
            <div>
              <label>&nbsp;</label>
              <button id="compare-run" type="button">Run Compare</button>
            </div>
          </div>
        </div>
        <div class="insight">
          <div class="insight-title">Comparison Summary</div>
          <ul id="insight-compare" class="insight-list"></ul>
        </div>
        <div class="table-wrap">
          <table id="compare-stage-table">
            <thead>
              <tr>
                <th>Seller</th>
                <th>Stage</th>
                <th>Left</th>
                <th>Right</th>
                <th>Delta</th>
                <th>% Delta</th>
              </tr>
            </thead>
            <tbody id="compare-stage-body"></tbody>
          </table>
        </div>
        <div class="table-wrap" style="margin-top:10px;">
          <table id="compare-move-table">
            <thead>
              <tr>
                <th>Movement Type</th>
                <th>Deal</th>
                <th>Seller</th>
                <th>Intro Month</th>
                <th>From Stage</th>
                <th>To Stage</th>
              </tr>
            </thead>
            <tbody id="compare-move-body"></tbody>
          </table>
        </div>
      </div>

      <div id="view-momentum" class="view">
        <div class="head">
          <div>
            <h1>Funnel Momentum</h1>
            <div class="sub">Seller-level view of positive, negative, or stalled funnel movement between two refresh versions.</div>
          </div>
          <div class="controls">
            <div>
              <label for="momentum-left">From Version</label>
              <select id="momentum-left"></select>
            </div>
            <div>
              <label for="momentum-right">To Version</label>
              <select id="momentum-right"></select>
            </div>
            <div>
              <label for="momentum-seller">Seller</label>
              <select id="momentum-seller"></select>
            </div>
            <div>
              <label for="momentum-scope">Stage Scope</label>
              <select id="momentum-scope">
                <option value="core">1-6 only</option>
                <option value="all">1-8</option>
              </select>
            </div>
            <div>
              <label>&nbsp;</label>
              <button id="momentum-prev" type="button">Compare vs Previous</button>
            </div>
            <div>
              <label>&nbsp;</label>
              <button id="momentum-run" type="button">Run Momentum</button>
            </div>
          </div>
        </div>
        <div class="insight">
          <div class="insight-title">Momentum Summary</div>
          <ul id="insight-momentum" class="insight-list"></ul>
        </div>
        <div class="momentum-wrap">
          <div id="momentum-cards" class="momentum-cards"></div>
          <div class="table-wrap">
            <table id="momentum-table">
              <thead>
                <tr>
                  <th>Seller</th>
                  <th>Status</th>
                  <th>Momentum Score</th>
                  <th>Forward Points</th>
                  <th>Backward Points</th>
                  <th>New Additions</th>
                  <th>Unchanged</th>
                  <th>Stuck Delta</th>
                  <th>Stage 5-6 Delta</th>
                </tr>
              </thead>
              <tbody id="momentum-body"></tbody>
            </table>
          </div>
          <div class="momentum-detail">
            <div class="momentum-detail-head">
              <div id="momentum-detail-title" class="momentum-detail-title">Moved Deals</div>
              <div id="momentum-detail-meta" class="detail-meta">Click any momentum card KPI to load deals.</div>
            </div>
            <div class="momentum-detail-wrap">
              <table class="momentum-detail-table">
                <thead>
                  <tr>
                    <th>Deal</th>
                    <th>Seller</th>
                    <th>From Stage</th>
                    <th>To Stage</th>
                    <th>Movement</th>
                    <th>Intro Month</th>
                  </tr>
                </thead>
                <tbody id="momentum-detail-body"></tbody>
              </table>
            </div>
          </div>
          <div class="momentum-definition">
            <strong>Definitions:</strong><br/>
            <strong>Forward Points</strong> = total stage jumps forward for stage-changed deals (e.g., 24 = +2).<br/>
            <strong>Backward Points</strong> = total stage jumps backward (e.g., 53 = +2 backward).<br/>
            <strong>New Additions</strong> = deals that were not in the older version and appear in the newer version (in selected stage scope).<br/>
            <strong>Stuck Delta</strong> = change in stuck/help-needed count (positive means worse).<br/>
            <strong>Momentum Score</strong> = Forward  Backward + Additions bonus  Stuck penalty.<br/>
            <strong>Status:</strong> Positive if score &gt; 2, Negative if score &lt; -2, otherwise Stalled.
          </div>
        </div>
      </div>

      <div id="view-forecast" class="view">
        <div class="head">
          <div>
            <h1>Quarterly Revenue Forecast (Risk-Adjusted EV)</h1>
            <div class="sub">EV per deal = Deal Size  P(win | stage). Stages 1-4 use $100,000 default size; stages 5-6 use adjusted deal size from Monday.</div>
          </div>
          <div class="controls">
            <div>
              <label for="forecast-seller">Scope</label>
              <select id="forecast-seller"></select>
            </div>
          </div>
        </div>
        <div class="insight">
          <div class="insight-title">Forecast Summary</div>
          <ul id="insight-forecast" class="insight-list"></ul>
        </div>
        <div class="forecast-wrap">
          <div class="table-wrap">
            <table class="forecast-table" id="forecast-table">
              <thead>
                <tr id="forecast-head-row"></tr>
              </thead>
              <tbody id="forecast-body"></tbody>
            </table>
          </div>
          <div class="forecast-detail">
            <div class="forecast-detail-head">
              <div id="forecast-detail-title" class="forecast-detail-title">Forecast Deal Breakup</div>
              <div id="forecast-detail-meta" class="detail-meta">Click Proposal, Contracting, or Won cells to view deal-level splits.</div>
            </div>
            <div class="forecast-detail-wrap">
              <table class="forecast-detail-table">
                <thead>
                  <tr>
                    <th>Deal</th>
                    <th>Stage</th>
                    <th>Start Date</th>
                    <th>Duration (months)</th>
                    <th>Deal Size</th>
                    <th>Quarter Contribution</th>
                    <th>Basis</th>
                  </tr>
                </thead>
                <tbody id="forecast-detail-body"></tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="footnote">Probabilities: Intro 5%, Qualification 10%, Capabilities 20%, Scoping 50%, Proposal 70%, Contracting 80%. Stage phasing follows the configured quarter splits.</div>
      </div>

      <div id="view-assumptions" class="view">
        <div class="head">
          <div>
            <h1>Assumptions, Logic, and Filters</h1>
            <div class="sub">Reference tab for all business rules and calculations used across this dashboard.</div>
          </div>
        </div>
        <div class="assumptions-wrap">
          <div class="assumption-card">
            <div class="assumption-head">Global Data Filters</div>
            <div class="assumption-body">
              1. Data source is Monday board sync snapshots (versioned).<br/>
              2. Primary date basis is Intro Meeting Date with cutoff <code>2024-10-01</code> unless a tab-specific override is shown.<br/>
              3. Seller scope is based on Deal Owner mapping to configured seller names.<br/>
              4. Active tab views use the currently selected snapshot version.
            </div>
          </div>

          <div class="assumption-card">
            <div class="assumption-head">Stage Mapping</div>
            <div class="assumption-body">
              <code>1. Intro</code>, <code>2. Qualification</code>, <code>3. Capability</code>, <code>4. Problem Scoping</code>, <code>5. Contracting</code>, <code>6. Commercial Proposal</code>, <code>7. Win</code>, <code>8. Loss</code>.<br/>
              Additional non-core stages are included in funnel filters where available.
            </div>
          </div>

          <div class="assumption-card">
            <div class="assumption-head">Weekly Scorecard Logic</div>
            <div class="assumption-body">
              1. KPI groups: stage 1-6, stage 1-2, stage 3-4, stage 5-6, stage 7-8.<br/>
              2. Stuck proxy uses missing next step and SLA-age flags by stage category.<br/>
              3. Seller-tagged close likelihood options are this quarter / next quarter / help needed.<br/>
              4. Deal detail tables include stage, intro month, start date, age, deal size, and reason.
            </div>
          </div>

          <div class="assumption-card">
            <div class="assumption-head">Version Compare & Funnel Momentum</div>
            <div class="assumption-body">
              1. Compare is between any two selected snapshots.<br/>
              2. Funnel momentum status is derived from forward vs backward movement, additions, and stuck delta.<br/>
              3. Movement drilldowns are normalized to deal-level contributions per selected quarter.
            </div>
          </div>

          <div class="assumption-card">
            <div class="assumption-head">Revenue Forecast Calculations</div>
            <div class="assumption-body">
              1. Stage EV = Deal Size  P(win | stage).<br/>
              2. Probabilities: Intro 5%, Qualification 10%, Capabilities 20%, Scoping 50%, Proposal 70%, Contracting 80%.<br/>
              3. For stages 1-4, default deal size is <code>$100,000</code>; for stages 5-6, adjusted Monday deal size is used.<br/>
              4. Proposal and Contracting phasing is shifted to start from the deals start quarter when start date exists.<br/>
              5. Won row uses 100% deal size and is spread by start date + duration (months).<br/>
              6. Revenue from deals containing <code>Gilead</code> or <code>Lundbeck</code> is excluded from <code>Q1 FY27</code> onward.<br/>
              7. Fiscal year is Apr-Mar (e.g., Jan-Mar maps to Q4 of the same fiscal year label).
            </div>
          </div>

          <div class="assumption-card">
            <div class="assumption-head">Targets and Gap</div>
            <div class="assumption-body">
              1. Targets are maintained in shared backend state by seller and quarter, including an Overall scope.<br/>
              2. Gap is computed as <code>Target - Forecast</code> for each quarter.<br/>
              3. Positive gap implies shortfall versus target; negative gap implies forecast above target.
            </div>
          </div>
        </div>
      </div>

      <div id="view-cycletime" class="view">
        <div class="head">
          <div>
            <h1>Closed Deal Cycle Time</h1>
            <div class="sub">Lead time from Intro Date to Start Date for closed deals with both dates present.</div>
          </div>
          <div class="controls">
            <div class="funnel-time" style="min-width: 260px;">
              <div class="funnel-time-head">
                <label for="cycle-time-slider" style="margin:0;">Intro Cutoff</label>
                <div id="cycle-time-value" class="funnel-time-value">-</div>
              </div>
              <input id="cycle-time-slider" type="range" min="0" max="0" value="0" />
            </div>
            <div>
              <label for="cycle-seller">Seller Scope</label>
              <select id="cycle-seller"></select>
            </div>
          </div>
        </div>
        <div class="insight">
          <div class="insight-title">Key Insights</div>
          <ul id="insight-cycletime" class="insight-list"></ul>
        </div>
        <div class="table-wrap">
          <table class="detail-table">
            <thead>
              <tr>
                <th id="cycle-th-deal" class="cycle-sortable" data-cycle-sort="deal">Deal</th>
                <th id="cycle-th-stage" class="cycle-sortable" data-cycle-sort="stage">Stage</th>
                <th id="cycle-th-industry" class="cycle-sortable" data-cycle-sort="industry">Industry</th>
                <th id="cycle-th-seller" class="cycle-sortable" data-cycle-sort="seller">Seller</th>
                <th id="cycle-th-channel" class="cycle-sortable" data-cycle-sort="channel">Channel</th>
                <th id="cycle-th-deal_size" class="cycle-sortable" data-cycle-sort="dealSize">Deal Size</th>
                <th id="cycle-th-intro" class="cycle-sortable" data-cycle-sort="intro">Intro Date</th>
                <th id="cycle-th-start" class="cycle-sortable" data-cycle-sort="start">Start Date</th>
                <th id="cycle-th-days" class="cycle-sortable" data-cycle-sort="days">Days</th>
                <th id="cycle-th-months" class="cycle-sortable" data-cycle-sort="months">Months</th>
              </tr>
              <tr class="cycle-filter-row">
                <th><input id="cycle-filter-deal" data-cycle-filter="deal" placeholder="Filter deal" /></th>
                <th><input id="cycle-filter-stage" data-cycle-filter="stage" placeholder="Filter stage" /></th>
                <th><input id="cycle-filter-industry" data-cycle-filter="industry" placeholder="Filter industry" /></th>
                <th><input id="cycle-filter-seller" data-cycle-filter="seller" placeholder="Filter seller" /></th>
                <th><input id="cycle-filter-channel" data-cycle-filter="channel" placeholder="Filter channel" /></th>
                <th><input id="cycle-filter-deal_size" data-cycle-filter="dealSize" placeholder="e.g. >100000" /></th>
                <th><input id="cycle-filter-intro" data-cycle-filter="intro" placeholder="YYYY-MM or date" /></th>
                <th><input id="cycle-filter-start" data-cycle-filter="start" placeholder="YYYY-MM or date" /></th>
                <th><input id="cycle-filter-days" data-cycle-filter="days" placeholder="e.g. <=120" /></th>
                <th><input id="cycle-filter-months" data-cycle-filter="months" placeholder="e.g. <6" /></th>
              </tr>
            </thead>
            <tbody id="cycle-deals-body"></tbody>
          </table>
        </div>
        <div class="cycle-grid">
          <div class="cycle-card">
            <div class="title">Summary by Industry</div>
            <div class="table-wrap">
              <table class="detail-table">
                <thead>
                  <tr>
                    <th>Industry</th>
                    <th>Deals</th>
                    <th>Avg Days</th>
                    <th>Median Days</th>
                  </tr>
                </thead>
                <tbody id="cycle-industry-body"></tbody>
              </table>
            </div>
          </div>
          <div class="cycle-card">
            <div class="title">Summary by Seller</div>
            <div class="table-wrap">
              <table class="detail-table">
                <thead>
                  <tr>
                    <th>Seller</th>
                    <th>Deals</th>
                    <th>Avg Days</th>
                    <th>Median Days</th>
                  </tr>
                </thead>
                <tbody id="cycle-seller-body"></tbody>
              </table>
            </div>
          </div>
          <div class="cycle-card">
            <div class="title">Summary by Channel</div>
            <div class="table-wrap">
              <table class="detail-table">
                <thead>
                  <tr>
                    <th>Channel</th>
                    <th>Deals</th>
                    <th>Avg Days</th>
                    <th>Median Days</th>
                  </tr>
                </thead>
                <tbody id="cycle-channel-body"></tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="footnote">Current versions created before this feature may show Industry/Channel as blank until you run a fresh Monday sync.</div>
      </div>

      <div id="view-admin" class="view">
        <div class="head">
          <div>
            <h1>Admin: User Credentials</h1>
            <div class="sub">Create credentials, configure targets, and refresh board data from Monday.com.</div>
          </div>
        </div>
        <div class="admin-wrap">
          <div class="admin-card">
            <label style="margin-bottom:8px;">Data Refresh (Monday.com)</label>
            <form id="admin-sync-form" class="admin-grid" autocomplete="off">
              <div class="span-2">
                <label for="admin-monday-board">Board URL / ID</label>
                <input id="admin-monday-board" type="text" placeholder="https://themathcocrmtrial.monday.com/boards/6218900009" />
              </div>
              <div class="span-2">
                <label for="admin-monday-version-name">Snapshot name (optional)</label>
                <input id="admin-monday-version-name" type="text" placeholder="e.g., Week of Feb 10 (post refresh cleanup)" />
              </div>
              <button id="admin-sync-btn" type="submit">Refresh From Monday</button>
            </form>
            <div id="admin-sync-msg" class="auth-error"></div>
            <div id="admin-sync-meta" class="sync-meta">Last sync: -</div>
            <div class="admin-grid" style="margin-top:10px; align-items:end;">
              <div class="span-2">
                <label for="admin-version-rename">Rename selected version</label>
                <input id="admin-version-rename" type="text" placeholder="Displayed in Viewing dropdown (admin only)" />
              </div>
              <button id="admin-version-rename-btn" type="button">Rename Version</button>
            </div>
          </div>
          <div class="admin-card">
            <label style="margin-bottom:8px;">Industry Mapping (Accounts Board)</label>
            <div class="sub" style="margin-bottom:10px;">
              Industry is mirrored from the Accounts board. On refresh, the backend joins Deals -> Account -> Industry.
            </div>
            <div class="sync-meta" style="white-space:pre-wrap;">
              Accounts board: https://themathcocrmtrial.monday.com/boards/6218900019
            </div>
          </div>
          <div class="admin-card">
            <label style="margin-bottom:8px;">Create User</label>
            <form id="admin-user-form" class="admin-grid" autocomplete="off">
              <div>
                <label for="admin-new-user">Username</label>
                <input id="admin-new-user" type="text" placeholder="username" required />
              </div>
              <div>
                <label for="admin-new-pass">Password</label>
                <input id="admin-new-pass" type="password" placeholder="temporary password" required />
              </div>
              <div>
                <label for="admin-new-role">Role</label>
                <select id="admin-new-role">
                  <option value="viewer">viewer</option>
                  <option value="admin">admin</option>
                </select>
              </div>
              <button type="submit">Create / Update User</button>
            </form>
            <div id="admin-msg" class="auth-error"></div>
          </div>
          <div class="admin-card">
            <label style="margin-bottom:8px;">Existing Users</label>
            <div class="admin-table-wrap">
              <table class="admin-table">
                <thead>
                  <tr>
                    <th>Username</th>
                    <th>Role</th>
                    <th>Created</th>
                    <th>Last Login</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody id="admin-users-body"></tbody>
              </table>
            </div>
          </div>
          <div class="admin-card">
            <label style="margin-bottom:8px;">Quarter Targets (Per Seller)</label>
            <form id="admin-target-form" class="target-controls" autocomplete="off">
              <div>
                <label for="admin-target-quarters">Quarter Columns (comma separated)</label>
                <input id="admin-target-quarters" type="text" placeholder="Q4'26, Q1'27" />
              </div>
              <button type="submit">Save All Targets</button>
            </form>
            <div id="admin-target-msg" class="auth-error"></div>
            <div class="admin-table-wrap">
              <table class="target-grid-table">
                <thead>
                  <tr id="admin-target-grid-head-main">
                    <th>Seller</th>
                  </tr>
                  <tr id="admin-target-grid-head-sub">
                    <th class="target-subhead">-</th>
                  </tr>
                </thead>
                <tbody id="admin-target-grid-body"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <button id="chat-fab" class="chat-fab" type="button" title="Ask about your data">
    <img src="./assets/chatbot-icon.svg" alt="Chatbot" />
  </button>
  <div id="chat-panel" class="chat-panel" aria-hidden="true">
    <div class="chat-panel-head">
      <span>Sales Data Chat</span>
      <button id="chat-close" type="button">Close</button>
    </div>
    <div id="chat-messages" class="chat-messages"></div>
    <div class="chat-input-row">
      <input id="chat-input" type="text" placeholder="Ask: How many deals are in contracting for Somya?" />
      <button id="chat-send" type="button">Ask</button>
    </div>
    <div id="chat-suggest" class="chat-suggest" style="padding: 0 10px 10px;"></div>
  </div>
  <div id="chart-tooltip" class="chart-tooltip"></div>
  <div id="kpi-popup" class="popup" aria-hidden="true">
    <div class="popup-card">
      <div class="popup-head">
        <div id="kpi-popup-title" class="popup-title">KPI Details</div>
        <button id="kpi-popup-close" type="button" class="popup-close">Close</button>
      </div>
      <div class="popup-wrap">
        <table class="popup-table">
          <thead>
            <tr>
              <th>Deal</th>
              <th>Stage</th>
              <th>Intro Month</th>
              <th>Start Date</th>
              <th>Age (days)</th>
              <th>Deal Size</th>
              <th>Reason</th>
              <th>Likelihood</th>
            </tr>
          </thead>
          <tbody id="kpi-popup-body"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const money = new Intl.NumberFormat('en-US');
    const moneyUsd = new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD',
      maximumFractionDigits: 0,
    });
    const MATTER_STAGE_ORDER = [
      '1. Intro',
      '2. Qualification',
      '3. Capability',
      '4. Problem Scoping',
      '5. Contracting',
      '6. Commercial Proposal',
      '7. Win',
      '8. Loss'
    ];
    const STAGE_MAP = {
      'Scheduled Intro calls': '1. Intro',
      'Qualification': '2. Qualification',
      'Capabilities showcase': '3. Capability',
      'Problem Scoping': '4. Problem Scoping',
      'Contracting': '5. Contracting',
      'Commercial Proposal': '6. Commercial Proposal',
      'Latent Pool - Monthly': '7. Latent Pool - Monthly',
      'Won': '7. Win',
      'Lost': '8. Loss',
      'Disqualified': '9. Disqualified',
      'No Show/ Reschedule': '10. No Show/ Reschedule',
      'Latent Pool - Bi-monthly': '11. Latent Pool - Bi-monthly',
      'Latent Pool - Half yearly revisit': '12. Latent Pool - Half yearly revisit'
    };
    const FUNNEL_ORDER = [
      '1. Intro',
      '2. Qualification',
      '3. Capability',
      '4. Problem Scoping',
      '5. Contracting',
      '6. Commercial Proposal',
      '7. Latent Pool - Monthly',
      '7. Win',
      '8. Loss',
      '9. Disqualified',
      '10. No Show/ Reschedule',
      '11. Latent Pool - Bi-monthly',
      '12. Latent Pool - Half yearly revisit',
    ];
    const FUNNEL_CORE_SET = new Set([
      '1. Intro',
      '2. Qualification',
      '3. Capability',
      '4. Problem Scoping',
      '5. Contracting',
      '6. Commercial Proposal'
    ]);
    const DEAL_LIKELIHOOD_KEY = 'sales_dashboard_deal_likelihood_v1';
    const QUARTER_TARGETS_KEY = 'sales_dashboard_quarter_targets_v1';
    const SHARED_SETTINGS_KEY = 'sales_dashboard_settings_v1';
    const SHARED_DATASET_CACHE_KEY = 'sales_dashboard_dataset_cache_v1';
    const SUPABASE_URL = 'https://vqksytduqxpfcovijhko.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZxa3N5dGR1cXhwZmNvdmlqaGtvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0MDI0MjIsImV4cCI6MjA4NTk3ODQyMn0.wvUsJcFpCgXB10vuDcXqU_shO5sin-zI96sBIrZH3OY';
    const SUPABASE_FUNCTIONS_URL = 'https://vqksytduqxpfcovijhko.functions.supabase.co';
    // Bump on every publish so we can sanity-check cache and whether we're on the latest build.
    // Format: vMAJOR.MINOR.PATCH+YYYYMMDD.N
    const APP_VERSION = 'v0.7.30+20260209.1';
    const LIKELIHOOD_THIS_Q = 'this_q';
    const LIKELIHOOD_NEXT_Q = 'next_q';
    const LIKELIHOOD_HELP = 'help_needed';
    const MOMENTUM_CORE_STAGE_MAX = 6;
    const MOMENTUM_ALL_STAGE_MAX = 8;
    const FORECAST_QUARTERS = ['Q4 FY26', 'Q1 FY27', 'Q2 FY27', 'Q3 FY27', 'Q4 FY27'];
    const FORECAST_Q1_PLUS_EXCLUDE_DEALS = ['gilead', 'lundbeck'];
    const FORECAST_QUARTER_KEY_MAP = {
      'Q4 FY26': "Q4'26",
      'Q1 FY27': "Q1'27",
      'Q2 FY27': "Q2'27",
      'Q3 FY27': "Q3'27",
      'Q4 FY27': "Q4'27",
    };
    const FORECAST_DEFAULT_OVERALL_TARGETS = {
      'Q4 FY26': 0,
      'Q1 FY27': 1500000,
      'Q2 FY27': 2500000,
      'Q3 FY27': 4000000,
      'Q4 FY27': 4000000,
    };
    const FORECAST_STAGE_CONFIG = [
      {
        label: 'Intro',
        stage: '1. Intro',
        winProb: 0.05,
        phase: { 'Q4 FY26': 0.00, 'Q1 FY27': 0.35, 'Q2 FY27': 0.45, 'Q3 FY27': 0.15, 'Q4 FY27': 0.05 },
      },
      {
        label: 'Qualification',
        stage: '2. Qualification',
        winProb: 0.10,
        phase: { 'Q4 FY26': 0.05, 'Q1 FY27': 0.45, 'Q2 FY27': 0.35, 'Q3 FY27': 0.12, 'Q4 FY27': 0.03 },
      },
      {
        label: 'Capabilities',
        stage: '3. Capability',
        winProb: 0.20,
        phase: { 'Q4 FY26': 0.15, 'Q1 FY27': 0.55, 'Q2 FY27': 0.25, 'Q3 FY27': 0.04, 'Q4 FY27': 0.01 },
      },
      {
        label: 'Scoping',
        stage: '4. Problem Scoping',
        winProb: 0.50,
        phase: { 'Q4 FY26': 0.35, 'Q1 FY27': 0.45, 'Q2 FY27': 0.18, 'Q3 FY27': 0.02, 'Q4 FY27': 0.00 },
      },
      {
        label: 'Proposal',
        stage: '6. Commercial Proposal',
        winProb: 0.70,
        phase: { 'Q4 FY26': 0.60, 'Q1 FY27': 0.28, 'Q2 FY27': 0.11, 'Q3 FY27': 0.01, 'Q4 FY27': 0.00 },
      },
      {
        label: 'Contracting',
        stage: '5. Contracting',
        winProb: 0.80,
        phase: { 'Q4 FY26': 0.85, 'Q1 FY27': 0.12, 'Q2 FY27': 0.03, 'Q3 FY27': 0.00, 'Q4 FY27': 0.00 },
      },
    ];
    let likelihoodState = {};
    let liveLikelihoodState = {};
    let quarterTargetsState = {};
    let dashboardSettingsState = {};
    let sharedDatasetState = null;
    let activeQuarterLabels = { current: 'Current Quarter', next: 'Next Quarter' };
    let scorecardStateBySeller = {};
    let scorecardSummaryEls = {};
    let scorecardSellerLabels = [];
    let scorecardSelectedSeller = 'Overall';
    let cycleRowsState = [];
    let cycleScopeState = 'Overall';
    let cycleIntroMonthsState = [];
    let cycleIntroCutoffMonthState = null;

    let industryIntroMonthsState = [];
    let industryIntroCutoffMonthState = null;
    let wlIntroMonthsState = [];
    let wlIntroCutoffMonthState = null;
    let cycleTableState = {
      sortKey: 'days',
      sortDir: 'desc',
      filters: {
        deal: '',
        stage: '',
        industry: '',
        seller: '',
        channel: '',
        dealSize: '',
        intro: '',
        start: '',
        days: '',
        months: '',
      },
    };
    let activePopupSeller = null;
    let sharedStorePushTimer = null;
    let sharedStorePushInFlight = false;
    let sessionPassword = null;
    let versionsMetaState = [];
    let activeVersionIdState = null;
    let latestVersionIdState = null;
    let viewedVersionIdState = null;
    let versionLikelihoodState = {};
    let isHistoricalView = false;
    const AUTH_USERS_KEY = 'sales_dashboard_users_v1';
    const AUTH_SESSION_KEY = 'sales_dashboard_session_v1';
    let currentUser = null;
    let currentAuthStore = { users: {} };
    let activateTab = null;
    let chatInitialized = false;
    let chatDataRef = null;

    function normalizeUsername(value) {
      return String(value || '').trim().toLowerCase();
    }

    function chatAppend(role, text) {
      const box = document.getElementById('chat-messages');
      if (!box) return;
      const div = document.createElement('div');
      div.className = `chat-msg ${role}`;
      div.textContent = text;
      box.appendChild(div);
      box.scrollTop = box.scrollHeight;
      return div;
    }

    function chatResolveSeller(q, data) {
      const s = String(q || '').toLowerCase();
      if (s.includes('overall') || s.includes('all sellers') || s.includes('all teams')) return 'All (unique deals)';
      const sellers = (data && data.sellers) || [];
      for (const seller of sellers) {
        if (seller === 'All (unique deals)') continue;
        const low = seller.toLowerCase();
        if (s.includes(low)) return seller;
        const first = low.split(' ')[0];
        if (first && s.includes(first)) return seller;
      }
      return 'All (unique deals)';
    }

    function chatResolveStage(q) {
      const s = String(q || '').toLowerCase();
      if (s.includes('intro')) return '1. Intro';
      if (s.includes('qualification')) return '2. Qualification';
      if (s.includes('capab')) return '3. Capability';
      if (s.includes('problem scoping') || s.includes('scoping')) return '4. Problem Scoping';
      if (s.includes('contract')) return '5. Contracting';
      if (s.includes('commercial proposal') || s.includes('proposal')) return '6. Commercial Proposal';
      if (s.includes('win')) return '7. Win';
      if (s.includes('loss') || s.includes('lost')) return '8. Loss';
      if (s.includes('no show') || s.includes('reschedule')) return '10. No Show/ Reschedule';
      return null;
    }

    function chatResolveMonth(q) {
      const m = String(q || '').match(/\b(20\d{2})[-\/](0[1-9]|1[0-2])\b/);
      return m ? `${m[1]}-${m[2]}` : null;
    }

    function chatCollectDeals(data, seller, stage, month) {
      const details = buildGroupedDetails(((data.details || {})[seller]) || {});
      const stageMap = details[stage] || {};
      const out = [];
      if (month) {
        (stageMap[month] || []).forEach((d) => out.push({ deal: d, stage, month }));
      } else {
        Object.entries(stageMap).forEach(([m, deals]) => {
          deals.forEach((d) => out.push({ deal: d, stage, month: m }));
        });
      }
      return out.sort((a, b) => a.deal.localeCompare(b.deal));
    }

    function chatAnswer(question, data) {
      const q = String(question || '').trim();
      const s = q.toLowerCase();
      if (!q) return 'Ask a question about funnel counts, stage-wise deals, stuck deals, win/loss sources, or intro trends.';
      const seller = chatResolveSeller(s, data);
      const stage = chatResolveStage(s);
      const month = chatResolveMonth(s);

      if (s.includes('stuck') || s.includes('help needed')) {
        const bucketKey = seller === 'All (unique deals)' ? 'All (unique deals)' : seller;
        const kpi = (((data.scorecard || {}).sellers || {})[bucketKey] || {}).kpi_details || {};
        const stuck = kpi.stuck_proxy_2_6 || [];
        if (!stuck.length) return `${bucketKey}: no stuck/help-needed deals in current filtered data window.`;
        const top = stuck.slice(0, 12).map((r) => `${r.deal} | ${r.stage} | age ${r.age_days == null ? '-' : r.age_days}d`).join('\n');
        return `${bucketKey}: ${money.format(stuck.length)} stuck/help-needed deals.\nTop deals:\n${top}`;
      }

      if (s.includes('won') && s.includes('lost') && (s.includes('source') || s.includes('from') || s.includes('where'))) {
        const src = data.win_loss_sources || {};
        const payload = seller === 'All (unique deals)'
          ? (src.overall_unique || {})
          : ((src.sellers || {})[seller] || {});
        const rows = payload.rows || [];
        if (!rows.length) return `${seller}: no won/lost source rows available in current window.`;
        const top = rows.slice(0, 8).map((r) => `${r.industry} | ${r.logo} | ${r.function} -> Won ${r.won}, Lost ${r.lost}`).join('\n');
        return `${seller}: Won ${money.format(payload.won_total || 0)}, Lost ${money.format(payload.lost_total || 0)}, Win rate ${((Number(payload.overall_win_rate || 0)) * 100).toFixed(1)}%.\nTop sources:\n${top}`;
      }

      if (stage && (s.includes('which deals') || s.includes('list') || s.includes('show deals'))) {
        const deals = chatCollectDeals(data, seller, stage, month);
        if (!deals.length) return `${seller}: no deals found for ${stage}${month ? ` in ${month}` : ''}.`;
        const lines = deals.slice(0, 25).map((r) => `${r.deal} | ${r.month}`);
        return `${seller}: ${money.format(deals.length)} deal(s) in ${stage}${month ? ` for ${month}` : ''}.\n${lines.join('\n')}${deals.length > 25 ? `\n...and ${money.format(deals.length - 25)} more.` : ''}`;
      }

      if (stage || s.includes('count') || s.includes('how many')) {
        const grouped = buildGroupedTable((data.tables || {})[seller] || {});
        if (stage) {
          const monthMap = grouped[stage] || {};
          const count = month ? Number(monthMap[month] || 0) : Object.values(monthMap).reduce((a, b) => a + Number(b || 0), 0);
          return `${seller}: ${money.format(count)} deal(s) in ${stage}${month ? ` for ${month}` : ''}.`;
        }
        const total = Object.values(grouped).reduce((acc, monthMap) => {
          return acc + Object.values(monthMap || {}).reduce((a, b) => a + Number(b || 0), 0);
        }, 0);
        return `${seller}: total counted deals across all stages/months = ${money.format(total)}.`;
      }

      if (s.includes('funnel')) {
        const m = (((data.scorecard || {}).sellers || {})[seller] || {});
        if (!Object.keys(m).length) return `${seller}: no funnel snapshot found.`;
        return `${seller} funnel snapshot:\n1-2: ${money.format(m.stage_1_2_count || 0)}\n3-4: ${money.format(m.stage_3_4_count || 0)}\n5-6: ${money.format(m.stage_5_6_count || 0)}\n7-8: ${money.format(m.stage_7_8_count || 0)}\n1-6 total: ${money.format(m.stage_1_6_count || 0)}`;
      }

      if (s.includes('intro') && (s.includes('trend') || s.includes('peak') || s.includes('average'))) {
        const trend = data.intro_trend || {};
        const series = ((trend.series || {})[seller === 'All (unique deals)' ? 'Overall (unique)' : seller]) || {};
        const vals = Object.values(series).map((v) => Number(v || 0));
        if (!vals.length) return `${seller}: no intro trend data found.`;
        const total = vals.reduce((a, b) => a + b, 0);
        const peak = Math.max(...vals);
        const weeks = Object.keys(series);
        const idx = vals.indexOf(peak);
        return `${seller}: intro total ${money.format(total)}, average ${(total / vals.length).toFixed(1)} per bucket, peak ${money.format(peak)} at ${weeks[idx] || '-'}.`;
      }

      return `I can answer counts/lists by seller, stage, and month, plus stuck deals, funnel snapshot, intro trend, and won/lost source questions.\nTry: "Which deals are in contracting for Somya?"`;
    }

    function initChatAssistant(data) {
      chatDataRef = data;
      if (chatInitialized) return;
      chatInitialized = true;
      const fab = document.getElementById('chat-fab');
      const panel = document.getElementById('chat-panel');
      const close = document.getElementById('chat-close');
      const input = document.getElementById('chat-input');
      const send = document.getElementById('chat-send');
      const suggest = document.getElementById('chat-suggest');

      const toggle = (open) => {
        panel.classList.toggle('open', !!open);
        panel.setAttribute('aria-hidden', open ? 'false' : 'true');
        if (open) setTimeout(() => input.focus(), 40);
      };

      async function ask() {
        const q = input.value.trim();
        if (!q) return;
        chatAppend('user', q);
        const dataNow = chatDataRef || window.__salesData;
        if (!dataNow) {
          chatAppend('assistant', 'Data is not loaded yet. Please refresh the dashboard first.');
          input.value = '';
          return;
        }
        const pending = chatAppend('assistant', 'Thinking');
        try {
          const ans = await chatAskLlm(q);
          pending.textContent = ans;
        } catch (e) {
          pending.textContent = `${chatAnswer(q, dataNow)}\n\n[LLM unavailable: ${e && e.message ? e.message : 'failed'}]`;
        }
        input.value = '';
      }

      fab.addEventListener('click', () => toggle(!panel.classList.contains('open')));
      close.addEventListener('click', () => toggle(false));
      send.addEventListener('click', ask);
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') ask();
      });

      const prompts = [
        'How many deals are in contracting for Somya?',
        'Which deals are stuck for Akshay Iyer?',
        'Show won/lost sources for Overall',
        'Give me funnel snapshot for Vitor Quirino'
      ];
      prompts.forEach((p) => {
        const b = document.createElement('button');
        b.type = 'button';
        b.textContent = p;
        b.addEventListener('click', () => {
          toggle(true);
          input.value = p;
          ask();
        });
        suggest.appendChild(b);
      });

      chatAppend('assistant', 'Ask me about stage counts, deal lists, stuck deals, funnel snapshot, intro trend, or won/lost sources.');
    }

    async function chatAskLlm(question) {
      if (!currentUser || !sessionPassword) throw new Error('Not logged in');
      const url = `${SUPABASE_URL}/functions/v1/chat-analyst`;
      const payload = {
        username: currentUser.username,
        password: sessionPassword,
        question,
        // If the user is viewing a historical version, answer from that snapshot.
        version_id: viewedVersionIdState || null,
      };
      const res = await fetch(url, {
        method: 'POST',
        headers: {
          'content-type': 'application/json',
          apikey: SUPABASE_ANON_KEY,
          Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
        },
        body: JSON.stringify(payload),
      });
      const out = await res.json().catch(() => ({}));
      if (!res.ok || !out || out.ok !== true) {
        const msg = out && out.error ? String(out.error) : `HTTP ${res.status}`;
        throw new Error(msg);
      }
      const model = out.model ? ` (${out.model})` : '';
      const v = out.version_id ? ` [v=${String(out.version_id).slice(0, 8)}]` : '';
      return `${String(out.answer || '').trim() || '(no answer)'}${model}${v}`;
    }

    function dealSizeValue(raw) {
      const n = Number(raw);
      return Number.isFinite(n) ? n : 0;
    }

    function fmtDealSize(raw) {
      if (raw == null || raw === '') return '-';
      return moneyUsd.format(dealSizeValue(raw));
    }

    function bestDealSize(rec) {
      if (!rec || typeof rec !== 'object') return null;
      const keys = [
        'deal_size',
        'adj_deal_size',
        'adjusted_deal_size',
        'adjusted_contract_number',
        'adjusted_contract_value',
        'tcv',
        'contract_value',
        'value',
      ];
      for (const k of keys) {
        if (Object.prototype.hasOwnProperty.call(rec, k)) {
          const v = rec[k];
          const n = dealSizeValue(v);
          if (Number.isFinite(n) && n > 0) return n;
        }
      }
      return rec.deal_size ?? null;
    }

    function fmtTs(ts) {
      if (!ts) return '-';
      const d = new Date(ts);
      if (Number.isNaN(d.getTime())) return '-';
      return d.toLocaleString();
    }

    function loadLikelihoodState() {
      try {
        const parsed = JSON.parse(localStorage.getItem(DEAL_LIKELIHOOD_KEY) || '{}');
        if (parsed && typeof parsed === 'object') return parsed;
      } catch (_) {}
      return {};
    }

    function saveLikelihoodState() {
      localStorage.setItem(DEAL_LIKELIHOOD_KEY, JSON.stringify(likelihoodState));
    }

    function loadQuarterTargetsState() {
      try {
        const parsed = JSON.parse(localStorage.getItem(QUARTER_TARGETS_KEY) || '{}');
        if (parsed && typeof parsed === 'object') return parsed;
      } catch (_) {}
      return {};
    }

    function saveQuarterTargetsState() {
      localStorage.setItem(QUARTER_TARGETS_KEY, JSON.stringify(quarterTargetsState));
    }

    function loadDashboardSettingsState() {
      try {
        const parsed = JSON.parse(localStorage.getItem(SHARED_SETTINGS_KEY) || '{}');
        if (parsed && typeof parsed === 'object') return parsed;
      } catch (_) {}
      return {};
    }

    function saveDashboardSettingsState() {
      localStorage.setItem(SHARED_SETTINGS_KEY, JSON.stringify(dashboardSettingsState || {}));
    }

    function loadSharedDatasetCache() {
      try {
        const parsed = JSON.parse(localStorage.getItem(SHARED_DATASET_CACHE_KEY) || 'null');
        if (parsed && typeof parsed === 'object') return parsed;
      } catch (_) {}
      return null;
    }

    function saveSharedDatasetCache(dataset) {
      if (!dataset || typeof dataset !== 'object') return;
      localStorage.setItem(SHARED_DATASET_CACHE_KEY, JSON.stringify(dataset));
    }

    function persistLocalStateBundle() {
      saveAuthStore(currentAuthStore);
      saveLikelihoodState();
      saveQuarterTargetsState();
      saveDashboardSettingsState();
    }

    function applySharedStorePayload(payload) {
      const users = (payload && payload.users && typeof payload.users === 'object') ? payload.users : {};
      const likelihood = (payload && payload.likelihood && typeof payload.likelihood === 'object') ? payload.likelihood : {};
      const targets = (payload && payload.quarter_targets && typeof payload.quarter_targets === 'object') ? payload.quarter_targets : {};
      const settings = (payload && payload.settings && typeof payload.settings === 'object') ? payload.settings : {};
      const dataset = (payload && payload.dataset && typeof payload.dataset === 'object') ? payload.dataset : null;
      const versionsMeta = Array.isArray(payload && payload.versions_meta) ? payload.versions_meta : [];
      currentAuthStore = { users };
      likelihoodState = likelihood;
      liveLikelihoodState = JSON.parse(JSON.stringify(likelihood || {}));
      quarterTargetsState = targets;
      dashboardSettingsState = settings;
      sharedDatasetState = dataset;
      versionsMetaState = versionsMeta;
      activeVersionIdState = payload && payload.active_version_id ? String(payload.active_version_id) : null;
      latestVersionIdState = payload && payload.latest_version_id ? String(payload.latest_version_id) : null;
      if (dataset) saveSharedDatasetCache(dataset);
      persistLocalStateBundle();
    }

    async function supabaseRpc(fn, payload) {
      const url = `${SUPABASE_URL}/rest/v1/rpc/${fn}`;
      const res = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          apikey: SUPABASE_ANON_KEY,
          Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
        },
        body: JSON.stringify(payload || {}),
      });
      if (!res.ok) {
        const text = await res.text();
        throw new Error(`Supabase RPC ${fn} failed (${res.status}): ${text}`);
      }
      const data = await res.json();
      return Array.isArray(data) ? (data[0] || null) : data;
    }

    async function remoteLogin(username, password) {
      const out = await supabaseRpc('get_dashboard_state', {
        p_username: username,
        p_password: password,
      });
      if (!out) throw new Error('No state returned from backend login.');
      applySharedStorePayload(out);
      const u = normalizeUsername(username);
      const merged = (currentAuthStore.users || {})[u] || {};
      const role = out.role || merged.role || 'viewer';
      const currentUserObj = {
        username: u,
        role,
        last_login_at: merged.last_login_at || new Date().toISOString(),
      };
      currentAuthStore.users[u] = { ...merged, ...currentUserObj };
      persistLocalStateBundle();
      return currentUserObj;
    }

    async function loadSharedStore() {
      if (!currentUser || !sessionPassword) return;
      const fresh = await remoteLogin(currentUser.username, sessionPassword);
      currentUser = fresh;
    }

    async function pushSharedStoreNow(options = {}) {
      const throwOnError = !!options.throwOnError;
      if (!currentUser || !sessionPassword) return;
      if (sharedStorePushInFlight) return;
      sharedStorePushInFlight = true;
      try {
        const out = await supabaseRpc('save_dashboard_state', {
          p_username: currentUser.username,
          p_password: sessionPassword,
          p_likelihood: likelihoodState,
          p_quarter_targets: quarterTargetsState,
          p_users: (currentUser.role === 'admin') ? (currentAuthStore.users || {}) : null,
          p_settings: (currentUser.role === 'admin') ? (dashboardSettingsState || {}) : null,
        });
        if (out) applySharedStorePayload(out);
      } catch (e) {
        console.warn('Shared store push failed:', e.message || e);
        if (throwOnError) throw e;
      } finally {
        sharedStorePushInFlight = false;
      }
    }

    function queueSharedStorePush() {
      if (isHistoricalView) return;
      if (sharedStorePushTimer) clearTimeout(sharedStorePushTimer);
      sharedStorePushTimer = setTimeout(() => {
        pushSharedStoreNow();
      }, 220);
    }

    // (Removed) pinned industry column UI; backend resolves Industry via Accounts join.

    function normalizeQuarterLabel(raw) {
      const s = String(raw || '').trim().toUpperCase().replace(/\s+/g, '');
      const m = s.match(/^Q([1-4])'?(\d{2})$/);
      if (m) return `Q${m[1]}'${m[2]}`;
      const fy = s.match(/^Q([1-4])FY(\d{2})$/);
      if (fy) return `Q${fy[1]}'${fy[2]}`;
      return null;
    }

    function quarterTargetKey(seller, quarter) {
      return `${normalizeUsername(seller)}||${String(quarter || '').trim().toUpperCase()}`;
    }

    function getQuarterTarget(seller, quarter) {
      const key = quarterTargetKey(seller, quarter);
      const x = quarterTargetsState[key] || {};
      return {
        revenue: Number.isFinite(Number(x.revenue)) ? Number(x.revenue) : 0,
      };
    }

    function upsertQuarterTarget(seller, quarter, revenue) {
      const q = normalizeQuarterLabel(quarter);
      if (!q) throw new Error("Quarter must be in format Q4'26.");
      const s = String(seller || '').trim();
      if (!s) throw new Error('Seller is required.');
      const revenueN = Math.max(0, Number(revenue || 0));
      quarterTargetsState[quarterTargetKey(s, q)] = {
        seller: s,
        quarter: q,
        revenue: Number.isFinite(revenueN) ? revenueN : 0,
      };
      persistLocalStateBundle();
      queueSharedStorePush();
      return q;
    }

    function removeQuarterTarget(seller, quarter) {
      delete quarterTargetsState[quarterTargetKey(seller, quarter)];
      persistLocalStateBundle();
      queueSharedStorePush();
    }

    function ensureOverallForecastTargets(options = {}) {
      const persist = !!options.persist;
      let changed = false;
      Object.entries(FORECAST_DEFAULT_OVERALL_TARGETS).forEach(([fyLabel, revenue]) => {
        const qKey = FORECAST_QUARTER_KEY_MAP[fyLabel];
        const current = getQuarterTarget('Overall', qKey);
        if (Number(current.revenue || 0) > 0) return;
        quarterTargetsState[quarterTargetKey('Overall', qKey)] = {
          seller: 'Overall',
          quarter: qKey,
          revenue: Number(revenue || 0),
        };
        changed = true;
      });
      if (changed) {
        persistLocalStateBundle();
        if (persist && currentUser && currentUser.role === 'admin' && !isHistoricalView) {
          queueSharedStorePush();
        }
      }
      return changed;
    }

    function showAdminTargetMessage(message) {
      const el = document.getElementById('admin-target-msg');
      if (!el) return;
      el.textContent = message || '';
    }

    function parseQuarterColumns(raw) {
      const seen = new Set();
      const out = [];
      String(raw || '')
        .split(',')
        .map((x) => normalizeQuarterLabel(x))
        .filter(Boolean)
        .forEach((q) => {
          if (seen.has(q)) return;
          seen.add(q);
          out.push(q);
        });
      return out;
    }

    function getTargetSellers() {
      const labels = (scorecardSellerLabels || []).filter((s) => String(s || '').trim());
      const out = labels.filter((s) => s !== 'Overall');
      const base = out.length ? out : ['Somya', 'Akshay Iyer', 'Abhinav Kishore', 'Maruti Peri', 'Vitor'];
      return ['Overall', ...base];
    }

    function renderAdminTargets() {
      const quarterInput = document.getElementById('admin-target-quarters');
      const headMain = document.getElementById('admin-target-grid-head-main');
      const headSub = document.getElementById('admin-target-grid-head-sub');
      const body = document.getElementById('admin-target-grid-body');
      if (!quarterInput || !headMain || !headSub || !body) return;

      const fallback = [
        ...FORECAST_QUARTERS.map((q) => FORECAST_QUARTER_KEY_MAP[q]).filter(Boolean),
        activeQuarterLabels.current,
        activeQuarterLabels.next,
      ].filter(Boolean);
      const existing = Array.from(new Set(Object.values(quarterTargetsState || {})
        .map((x) => normalizeQuarterLabel(x && x.quarter))
        .filter(Boolean)))
        .sort();
      let quarters = parseQuarterColumns(quarterInput.value);
      if (!quarters.length) {
        quarters = existing.length ? existing : fallback;
        quarterInput.value = quarters.join(', ');
      }
      if (!quarters.length) {
        quarters = ["Q4'26", "Q1'27"];
        quarterInput.value = quarters.join(', ');
      }

      const sellers = getTargetSellers();

      headMain.innerHTML = '';
      headSub.innerHTML = '';
      // Keep the 2-row header structure but collapse to a single revenue column per quarter.
      const sellerMain = document.createElement('th');
      sellerMain.rowSpan = 2;
      sellerMain.textContent = 'Seller';
      headMain.appendChild(sellerMain);
      const sellerSub = document.createElement('th');
      sellerSub.textContent = '-';
      sellerSub.className = 'target-subhead';
      headSub.appendChild(sellerSub);
      quarters.forEach((q) => {
        const th = document.createElement('th');
        th.colSpan = 1;
        th.textContent = q;
        headMain.appendChild(th);
        const r = document.createElement('th');
        r.textContent = 'Revenue ($)';
        r.className = 'target-subhead';
        headSub.appendChild(r);
      });

      body.innerHTML = '';
      sellers.forEach((seller) => {
        const tr = document.createElement('tr');
        tr.appendChild(makeCell('td', seller));
        quarters.forEach((q) => {
          const current = getQuarterTarget(seller, q);
          const revTd = document.createElement('td');
          const revInput = document.createElement('input');
          revInput.type = 'number';
          revInput.min = '0';
          revInput.step = '1';
          revInput.value = Number(current.revenue || 0);
          revInput.dataset.seller = seller;
          revInput.dataset.quarter = q;
          revInput.dataset.metric = 'revenue';
          revTd.appendChild(revInput);
          tr.appendChild(revTd);
        });
        body.appendChild(tr);
      });
    }

    function pctText(actual, target) {
      const t = Number(target || 0);
      const a = Number(actual || 0);
      if (t <= 0) return 'n/a';
      return `${((a / t) * 100).toFixed(1)}%`;
    }

    function scorecardQuarterLabelForDate(dateLike) {
      // Returns "Q4'26" style label (FY starts April).
      if (!dateLike) return null;
      const d = parseDateOrNow(dateLike);
      if (!d || Number.isNaN(d.getTime())) return null;
      return fiscalQuarterText(fiscalQuarterLabel(d));
    }

    function stageNumber(stage) {
      const m = String(stage || '').match(/^(\d+)\./);
      return m ? Number(m[1]) : null;
    }

    function parseIsoLocalDate(dateLike) {
      const s = String(dateLike || '').trim();
      const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (!m) return null;
      const y = Number(m[1]);
      const mo = Number(m[2]) - 1;
      const d = Number(m[3]);
      const dt = new Date(y, mo, d, 12, 0, 0, 0);
      return Number.isNaN(dt.getTime()) ? null : dt;
    }

    function parseDateOrNow(dateLike) {
      if (dateLike) {
        const localIso = parseIsoLocalDate(dateLike);
        if (localIso) return localIso;
        const d = new Date(dateLike);
        if (!Number.isNaN(d.getTime())) return d;
      }
      return new Date();
    }

    function fiscalQuarterLabel(dateLike) {
      const d = parseDateOrNow(dateLike);
      const month = d.getMonth() + 1;
      const fiscalMonth = ((month - 4 + 12) % 12) + 1;
      const quarter = Math.floor((fiscalMonth - 1) / 3) + 1;
      const fiscalYear = month >= 4 ? d.getFullYear() + 1 : d.getFullYear();
      return { quarter, fiscalYear };
    }

    function nextFiscalQuarter({ quarter, fiscalYear }) {
      if (quarter < 4) return { quarter: quarter + 1, fiscalYear };
      return { quarter: 1, fiscalYear: fiscalYear + 1 };
    }

    function fiscalQuarterText(qInfo) {
      const yy = String(qInfo.fiscalYear).slice(-2);
      return `Q${qInfo.quarter}'${yy}`;
    }

    function buildQuarterLabels(referenceDate) {
      const currentInfo = fiscalQuarterLabel(referenceDate);
      const nextInfo = nextFiscalQuarter(currentInfo);
      return {
        current: fiscalQuarterText(currentInfo),
        next: fiscalQuarterText(nextInfo),
      };
    }

    function forecastQuarterFromDate(dateLike) {
      if (!dateLike) return null;
      const d = parseDateOrNow(dateLike);
      if (!d || Number.isNaN(d.getTime())) return null;
      const info = fiscalQuarterLabel(d);
      const yy = String(info.fiscalYear).slice(-2);
      return `Q${info.quarter} FY${yy}`;
    }

    function forecastQuarterFromStartDate(startDateIso) {
      return forecastQuarterFromDate(startDateIso);
    }

    function addMonthsSafe(dateObj, monthsToAdd) {
      const d = new Date(dateObj.getTime());
      const day = d.getDate();
      d.setDate(1);
      d.setMonth(d.getMonth() + monthsToAdd);
      const lastDay = new Date(d.getFullYear(), d.getMonth() + 1, 0).getDate();
      d.setDate(Math.min(day, lastDay));
      return d;
    }

    function buildDurationQuarterWeights(startDateIso, durationMonths) {
      const out = {};
      FORECAST_QUARTERS.forEach((q) => { out[q] = 0; });
      if (!startDateIso) return out;
      const start = parseDateOrNow(startDateIso);
      if (!start || Number.isNaN(start.getTime())) return out;
      const durRaw = Number(durationMonths || 0);
      const dur = Number.isFinite(durRaw) && durRaw > 0 ? Math.round(durRaw) : 1;
      for (let i = 0; i < dur; i += 1) {
        const monthDate = addMonthsSafe(start, i);
        const fq = forecastQuarterFromDate(monthDate);
        if (fq && Object.prototype.hasOwnProperty.call(out, fq)) out[fq] += 1;
      }
      FORECAST_QUARTERS.forEach((q) => { out[q] = Number(out[q] || 0) / dur; });
      return out;
    }

    function buildShiftedPhaseWeights(phaseMap, startDateIso) {
      const out = {};
      FORECAST_QUARTERS.forEach((q) => { out[q] = Number((phaseMap && phaseMap[q]) || 0); });
      if (!startDateIso) return out;
      const startQuarter = forecastQuarterFromStartDate(startDateIso);
      if (!startQuarter) return out;
      const startIdx = FORECAST_QUARTERS.indexOf(startQuarter);
      if (startIdx < 0) return out;
      const eligible = FORECAST_QUARTERS.slice(startIdx);
      const eligibleSum = eligible.reduce((acc, q) => acc + Number(out[q] || 0), 0);
      if (eligibleSum <= 0) {
        FORECAST_QUARTERS.forEach((q, idx) => { out[q] = idx === startIdx ? 1 : 0; });
        return out;
      }
      FORECAST_QUARTERS.forEach((q, idx) => {
        if (idx < startIdx) out[q] = 0;
        else out[q] = Number(out[q] || 0) / eligibleSum;
      });
      return out;
    }

    function isQ1OrLaterForecastQuarter(quarterLabel) {
      const idx = FORECAST_QUARTERS.indexOf(quarterLabel);
      return idx >= 1;
    }

    function isExcludedFromQ1PlusByDealName(dealName) {
      const d = String(dealName || '').toLowerCase();
      return FORECAST_Q1_PLUS_EXCLUDE_DEALS.some((token) => d.includes(token));
    }

    function likelihoodRecordKey(rec) {
      return [
        String(rec.deal || '').trim().toLowerCase(),
        String(rec.stage || '').trim().toLowerCase(),
        String(rec.created_month || '').trim().toLowerCase()
      ].join('||');
    }

    function buildScorecardSellerUniverse(metric) {
      const details = metric.kpi_details || {};
      const base = [...(details.stage_1_6 || []), ...(details.stage_7_8 || [])];
      const seen = new Set();
      const out = [];
      base.forEach((rec) => {
        const key = likelihoodRecordKey(rec);
        if (seen.has(key)) return;
        seen.add(key);
        out.push(rec);
      });
      return out;
    }

    function classifyLikelihoodForSeller(metric) {
      const universe = buildScorecardSellerUniverse(metric);
      const out = {
        thisQuarterDeals: [],
        nextQuarterDeals: [],
        helpNeededDeals: [],
        thisQuarterRevenue: 0,
        nextQuarterRevenue: 0,
        pendingStage3Plus: 0,
      };
      const dedupe = new Set(); // dedupe within bucket lists
      const addTo = (bucketKey, rec, size) => {
        const dkey = `${bucketKey}||${String(rec.deal || '').trim().toLowerCase()}||${String(rec.stage || '').trim().toLowerCase()}||${String(rec.start_date || '').trim()}`;
        if (dedupe.has(dkey)) return;
        dedupe.add(dkey);
        if (bucketKey === 'this') {
          out.thisQuarterDeals.push(rec);
          out.thisQuarterRevenue += size;
        } else if (bucketKey === 'next') {
          out.nextQuarterDeals.push(rec);
          out.nextQuarterRevenue += size;
        }
      };
      universe.forEach((rec) => {
        const key = likelihoodRecordKey(rec);
        const selected = likelihoodState[key] || '';
        const size = dealSizeValue(rec.deal_size);
        if (selected === LIKELIHOOD_THIS_Q) {
          addTo('this', rec, size);
        } else if (selected === LIKELIHOOD_NEXT_Q) {
          addTo('next', rec, size);
        } else if (selected === LIKELIHOOD_HELP) {
          out.helpNeededDeals.push(rec);
        }

        const stageNum = stageNumber(rec.stage);
        if (stageNum != null && stageNum >= 3 && stageNum <= 6 && !selected) out.pendingStage3Plus += 1;
      });

      // Auto-include Won deals into quarter buckets based on Start Date (no manual tagging needed).
      const details = metric.kpi_details || {};
      const wl = details.stage_7_8 || [];
      (wl || []).forEach((rec) => {
        const stage = String(rec.stage || '').toLowerCase();
        if (!stage.includes('win') && !stage.includes('won') && !stage.startsWith('7.')) return;
        const q = scorecardQuarterLabelForDate(rec.start_date);
        if (!q) return;
        const size = dealSizeValue(rec.deal_size);
        if (q === activeQuarterLabels.current) {
          addTo('this', rec, size);
        } else if (q === activeQuarterLabels.next) {
          addTo('next', rec, size);
        }
      });
      return out;
    }

    function renderLikelihoodDealLines(bodyEl, rows) {
      if (!bodyEl) return;
      bodyEl.innerHTML = '';
      if (!rows.length) {
        const tr = document.createElement('tr');
        tr.appendChild(makeCell('td', 'No deals tagged'));
        tr.appendChild(makeCell('td', '-'));
        tr.appendChild(makeCell('td', '-'));
        tr.appendChild(makeCell('td', '-'));
        bodyEl.appendChild(tr);
        return;
      }
      const sorted = [...rows].sort((a, b) => {
        const ad = String(a.deal || '').toLowerCase();
        const bd = String(b.deal || '').toLowerCase();
        if (ad !== bd) return ad.localeCompare(bd);
        return String(a.stage || '').localeCompare(String(b.stage || ''));
      });
      sorted.forEach((r) => {
        const tr = document.createElement('tr');
        tr.appendChild(makeCell('td', r.deal || '-'));
        tr.appendChild(makeCell('td', r.stage || '-'));
        tr.appendChild(makeCell('td', r.start_date || '-'));
        tr.appendChild(makeCell('td', fmtDealSize(bestDealSize(r))));
        bodyEl.appendChild(tr);
      });
    }

    function updateLikelihoodSummaryForSeller(seller) {
      const metric = scorecardStateBySeller[seller];
      const refs = scorecardSummaryEls[seller];
      if (!metric || !refs) return;
      const x = classifyLikelihoodForSeller(metric);
      const tThis = getQuarterTarget(seller, activeQuarterLabels.current);
      const tNext = getQuarterTarget(seller, activeQuarterLabels.next);
      refs.thisQuarterMeta.textContent = `${money.format(x.thisQuarterDeals.length)} deals | ${fmtDealSize(x.thisQuarterRevenue)} (T ${fmtDealSize(tThis.revenue)} | ${pctText(x.thisQuarterRevenue, tThis.revenue)})`;
      refs.nextQuarterMeta.textContent = `${money.format(x.nextQuarterDeals.length)} deals | ${fmtDealSize(x.nextQuarterRevenue)} (T ${fmtDealSize(tNext.revenue)} | ${pctText(x.nextQuarterRevenue, tNext.revenue)})`;
      refs.helpMeta.textContent = `${money.format(x.helpNeededDeals.length)} deals | Not updated (stage 3+): ${money.format(x.pendingStage3Plus)}`;
      renderLikelihoodDealLines(refs.thisQuarterLines, x.thisQuarterDeals);
      renderLikelihoodDealLines(refs.nextQuarterLines, x.nextQuarterDeals);
      renderLikelihoodDealLines(refs.helpLines, x.helpNeededDeals);
    }

    function loadAuthStore() {
      try {
        const parsed = JSON.parse(localStorage.getItem(AUTH_USERS_KEY) || '{}');
        if (parsed && parsed.users && typeof parsed.users === 'object') return parsed;
      } catch (_) {}
      return { users: {} };
    }

    function saveAuthStore(store) {
      localStorage.setItem(AUTH_USERS_KEY, JSON.stringify(store));
    }

    function loadSession() {
      try {
        const parsed = JSON.parse(sessionStorage.getItem(AUTH_SESSION_KEY) || '{}');
        if (parsed && parsed.username && parsed.password) return parsed;
      } catch (_) {}
      return null;
    }

    function saveSession(username, password, role = 'viewer') {
      sessionStorage.setItem(AUTH_SESSION_KEY, JSON.stringify({
        username,
        password,
        role,
        at: new Date().toISOString(),
      }));
    }

    function clearSession() {
      sessionStorage.removeItem(AUTH_SESSION_KEY);
    }

    function randomSalt() {
      const buf = new Uint8Array(16);
      crypto.getRandomValues(buf);
      return Array.from(buf).map((b) => b.toString(16).padStart(2, '0')).join('');
    }

    async function sha256(value) {
      const bytes = new TextEncoder().encode(value);
      const hash = await crypto.subtle.digest('SHA-256', bytes);
      return Array.from(new Uint8Array(hash)).map((b) => b.toString(16).padStart(2, '0')).join('');
    }

    async function hashPassword(password, salt) {
      return sha256(`${salt}:${password}`);
    }

    async function upsertUser(usernameInput, password, role = 'viewer', createdBy = 'system') {
      const username = normalizeUsername(usernameInput);
      if (!username) throw new Error('Username is required.');
      if (!password || password.length < 6) throw new Error('Password must be at least 6 characters.');
      const now = new Date().toISOString();
      const existing = currentAuthStore.users[username] || {};
      const salt = randomSalt();
      const passwordHash = await hashPassword(password, salt);
      currentAuthStore.users[username] = {
        username,
        role: role === 'admin' ? 'admin' : 'viewer',
        salt,
        password_hash: passwordHash,
        created_at: existing.created_at || now,
        created_by: existing.created_by || createdBy,
        updated_at: now,
        last_login_at: existing.last_login_at || null,
      };
      persistLocalStateBundle();
      await pushSharedStoreNow({ throwOnError: true });
    }

    async function verifyLogin(usernameInput, password) {
      try {
        const logged = await remoteLogin(usernameInput, password);
        return logged;
      } catch (_) {
        return null;
      }
    }

    function setAdminVisibility(isAdmin) {
      const tab = document.getElementById('tab-admin');
      const view = document.getElementById('view-admin');
      // Keep Admin tab hidden from the main nav; expose it via the profile menu instead.
      tab.style.display = 'none';
      const menu = document.getElementById('profile-admin');
      if (menu) menu.style.display = isAdmin ? '' : 'none';
      if (!isAdmin && view.classList.contains('active') && activateTab) activateTab('scorecard');
    }

    function showAuthError(message) {
      document.getElementById('auth-error').textContent = message || '';
    }

    function showAdminMessage(message) {
      const el = document.getElementById('admin-msg');
      el.textContent = message || '';
    }

    function showAdminSyncMessage(message) {
      const el = document.getElementById('admin-sync-msg');
      if (!el) return;
      el.textContent = message || '';
    }

    function renderAdminSyncStatus() {
      const el = document.getElementById('admin-sync-meta');
      if (!el) return;
      const s = dashboardSettingsState || {};
      const board = s.monday_board_name || s.monday_board_id || '-';
      const at = fmtTs(s.monday_last_sync_at);
      const by = s.monday_last_sync_by || '-';
      const rows = Number.isFinite(Number(s.monday_last_sync_rows)) ? money.format(Number(s.monday_last_sync_rows)) : '-';
      const src = s.monday_board_url || (s.monday_board_id ? `https://themathcocrmtrial.monday.com/boards/${s.monday_board_id}` : '-');
      el.textContent = `Last sync: ${at}\nBoard: ${board}\nRows pulled: ${rows}\nTriggered by: ${by}\nSource: ${src}`;
    }

    function parseBoardId(value) {
      const s = String(value || '').trim();
      if (!s) return null;
      const m = s.match(/boards\/(\d+)/i);
      if (m) return m[1];
      if (/^\d+$/.test(s)) return s;
      return null;
    }

    async function refreshFromMonday(boardValue, versionName) {
      if (!currentUser || !sessionPassword) throw new Error('Please login again.');
      const boardId = parseBoardId(boardValue);
      if (!boardId) throw new Error('Enter a valid Monday board URL or numeric board ID.');
      const url = `${SUPABASE_FUNCTIONS_URL}/sync-monday-board`;
      const res = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          apikey: SUPABASE_ANON_KEY,
          Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
        },
        body: JSON.stringify({
          username: currentUser.username,
          password: sessionPassword,
          board_id: boardId,
          version_name: String(versionName || '').trim() || null,
        }),
      });
      const body = await res.json();
      if (!res.ok) {
        throw new Error(body.error || `Monday sync failed (${res.status}).`);
      }
      if (body.state) applySharedStorePayload(body.state);
      dashboardSettingsState = {
        ...(dashboardSettingsState || {}),
        monday_board_id: boardId,
        monday_board_url: `https://themathcocrmtrial.monday.com/boards/${boardId}`,
      };
      persistLocalStateBundle();
      renderAdminSyncStatus();
      return body;
    }

    // (Removed) Monday column inspector UI; Industry is resolved via Accounts board join in backend.

    function renderAdminUsers() {
      const body = document.getElementById('admin-users-body');
      if (!body) return;
      body.innerHTML = '';
      const users = Object.values(currentAuthStore.users || {}).sort((a, b) => a.username.localeCompare(b.username));
      if (!users.length) {
        const tr = document.createElement('tr');
        tr.appendChild(makeCell('td', 'No users', ''));
        tr.appendChild(makeCell('td', '-', ''));
        tr.appendChild(makeCell('td', '-', ''));
        tr.appendChild(makeCell('td', '-', ''));
        tr.appendChild(makeCell('td', '-', ''));
        body.appendChild(tr);
        return;
      }
      users.forEach((user) => {
        const tr = document.createElement('tr');
        tr.appendChild(makeCell('td', user.username, ''));
        tr.appendChild(makeCell('td', user.role, ''));
        tr.appendChild(makeCell('td', fmtTs(user.created_at), ''));
        tr.appendChild(makeCell('td', fmtTs(user.last_login_at), ''));
        const action = document.createElement('td');
        const resetBtn = document.createElement('button');
        resetBtn.type = 'button';
        resetBtn.textContent = 'Reset Password';
        resetBtn.addEventListener('click', () => {
          const u = document.getElementById('admin-new-user');
          const p = document.getElementById('admin-new-pass');
          const r = document.getElementById('admin-new-role');
          u.value = user.username;
          p.focus();
          r.value = user.role === 'admin' ? 'admin' : 'viewer';
          showAdminMessage(`Ready to reset password for "${user.username}".`);
        });
        action.appendChild(resetBtn);
        tr.appendChild(action);
        body.appendChild(tr);
      });
    }

    function applyLoggedInState(user) {
      currentUser = user;
      document.getElementById('auth-gate').style.display = 'none';
      document.getElementById('app').style.display = 'block';
      const profile = document.getElementById('profile');
      const profileUser = document.getElementById('profile-user');
      const profileRole = document.getElementById('profile-role');
      const avatar = document.getElementById('profile-avatar');
      const btn = document.getElementById('profile-btn');
      if (profileUser) profileUser.textContent = user.username;
      if (profileRole) profileRole.textContent = user.role;
      if (avatar) avatar.textContent = String(user.username || 'U').trim().slice(0, 1).toUpperCase() || 'U';
      if (btn) btn.setAttribute('aria-expanded', 'false');
      if (profile) {
        profile.classList.remove('open');
        profile.style.display = 'inline-flex';
      }
      const isAdmin = user.role === 'admin';
      setAdminVisibility(isAdmin);
      if (isAdmin) {
        const boardInput = document.getElementById('admin-monday-board');
        if (boardInput) {
          boardInput.value = String(
            (dashboardSettingsState && (dashboardSettingsState.monday_board_url || dashboardSettingsState.monday_board_id))
            || 'https://themathcocrmtrial.monday.com/boards/6218900009'
          );
        }
        renderAdminSyncStatus();
        renderAdminUsers();
        renderAdminTargets();
      } else {
        const body = document.getElementById('admin-users-body');
        if (body) body.innerHTML = '';
        const tbody = document.getElementById('admin-target-grid-body');
        if (tbody) tbody.innerHTML = '';
      }
    }

    function showLoginOrSetup() {
      const gate = document.getElementById('auth-gate');
      const loginForm = document.getElementById('auth-login-form');
      const setupForm = document.getElementById('auth-setup-form');
      const sub = document.getElementById('auth-sub');
      gate.style.display = 'block';
      document.getElementById('app').style.display = 'none';
      showAuthError('');
      sub.textContent = 'Sign in to access the dashboard. If no users exist yet, your first login creates the admin user.';
      loginForm.style.display = 'grid';
      setupForm.style.display = 'none';
    }

    function normalizeStage(stage) {
      return STAGE_MAP[stage] || stage;
    }

    function buildGroupedTable(rawTable) {
      const grouped = {};
      Object.entries(rawTable || {}).forEach(([rawStage, monthMap]) => {
        const stage = normalizeStage(rawStage);
        if (!grouped[stage]) grouped[stage] = {};
        Object.entries(monthMap || {}).forEach(([month, value]) => {
          grouped[stage][month] = (grouped[stage][month] || 0) + Number(value || 0);
        });
      });
      return grouped;
    }

    function buildGroupedDetails(rawDetails) {
      const grouped = {};
      Object.entries(rawDetails || {}).forEach(([rawStage, monthMap]) => {
        const stage = normalizeStage(rawStage);
        if (!grouped[stage]) grouped[stage] = {};
        Object.entries(monthMap || {}).forEach(([month, deals]) => {
          if (!grouped[stage][month]) grouped[stage][month] = [];
          grouped[stage][month].push(...(deals || []));
        });
      });
      Object.keys(grouped).forEach((stage) => {
        Object.keys(grouped[stage]).forEach((month) => {
          grouped[stage][month] = [...new Set(grouped[stage][month])].sort((a, b) => a.localeCompare(b));
        });
      });
      return grouped;
    }

    function buildGroupedCarry(rawCarry) {
      const grouped = {};
      Object.entries(rawCarry || {}).forEach(([rawStage, monthMap]) => {
        const stage = normalizeStage(rawStage);
        if (!grouped[stage]) grouped[stage] = {};
        Object.entries(monthMap || {}).forEach(([month, value]) => {
          grouped[stage][month] = (grouped[stage][month] || 0) + Number(value || 0);
        });
      });
      return grouped;
    }

    function getOrderedStages(rawStages) {
      const groupedSet = new Set(rawStages.map(normalizeStage));
      const ordered = MATTER_STAGE_ORDER.filter(s => groupedSet.has(s));
      const remaining = [...groupedSet]
        .filter(s => !MATTER_STAGE_ORDER.includes(s))
        .sort((a, b) => a.localeCompare(b));
      return [...ordered, ...remaining];
    }

    function getOrderedFunnelStages(rawStages) {
      const groupedSet = new Set(rawStages.map(normalizeStage));
      const ordered = FUNNEL_ORDER.filter(s => groupedSet.has(s));
      const remaining = [...groupedSet]
        .filter(s => !FUNNEL_ORDER.includes(s))
        .sort((a, b) => a.localeCompare(b));
      return [...ordered, ...remaining];
    }

    function showError(message) {
      const e = document.getElementById('error');
      e.textContent = message;
      e.style.display = 'block';
    }

    function makeCell(tag, text, className = '') {
      const el = document.createElement(tag);
      el.textContent = text;
      if (className) el.className = className;
      return el;
    }

    function setInsight(listId, lines) {
      const ul = document.getElementById(listId);
      if (!ul) return;
      ul.innerHTML = '';
      (lines || []).forEach((line) => {
        const li = document.createElement('li');
        li.textContent = line;
        ul.appendChild(li);
      });
      if (!lines || !lines.length) {
        const li = document.createElement('li');
        li.textContent = 'No notable insight for current filter selection.';
        ul.appendChild(li);
      }
    }

    function versionLabel(v) {
      if (!v) return '-';
      const dt = fmtTs(v.created_at);
      const by = v.created_by || '-';
      const board = v.board_name || v.board_id || '-';
      const note = String(v.notes || '').trim();
      if (note) return `${note} | ${dt} | ${by} | ${board}`;
      return `${dt} | ${by} | ${board}`;
    }

    function renderVersionSelectors() {
      const main = document.getElementById('version-select');
      const left = document.getElementById('compare-left');
      const right = document.getElementById('compare-right');
      const momentumLeft = document.getElementById('momentum-left');
      const momentumRight = document.getElementById('momentum-right');
      if (!main || !left || !right || !momentumLeft || !momentumRight) return;
      const options = Array.isArray(versionsMetaState) ? versionsMetaState : [];
      const fill = (sel) => {
        sel.innerHTML = '';
        options.forEach((v) => {
          const o = document.createElement('option');
          o.value = String(v.id);
          o.textContent = versionLabel(v);
          sel.appendChild(o);
        });
      };
      fill(main);
      fill(left);
      fill(right);
      fill(momentumLeft);
      fill(momentumRight);
      const selected = viewedVersionIdState || activeVersionIdState || latestVersionIdState || (options[0] && String(options[0].id));
      if (selected) main.value = selected;
      if (selected) right.value = selected;
      if (selected) momentumRight.value = selected;
      if (!left.value && options[1]) left.value = String(options[1].id);
      if (!left.value && options[0]) left.value = String(options[0].id);
      if (!momentumLeft.value && options[1]) momentumLeft.value = String(options[1].id);
      if (!momentumLeft.value && options[0]) momentumLeft.value = String(options[0].id);
    }

    function choosePreviousVersionId(versionId) {
      const options = Array.isArray(versionsMetaState) ? versionsMetaState : [];
      const idx = options.findIndex((x) => String(x.id) === String(versionId));
      if (idx < 0) return options[1] ? String(options[1].id) : null;
      if (options[idx + 1]) return String(options[idx + 1].id);
      return options[idx - 1] ? String(options[idx - 1].id) : null;
    }

    async function fetchVersionData(versionId) {
      return supabaseRpc('get_dashboard_version', {
        p_username: currentUser.username,
        p_password: sessionPassword,
        p_version_id: versionId,
      });
    }

    async function fetchVersionCompare(leftVersionId, rightVersionId) {
      return supabaseRpc('get_dashboard_compare', {
        p_username: currentUser.username,
        p_password: sessionPassword,
        p_left_version_id: leftVersionId,
        p_right_version_id: rightVersionId,
      });
    }

    async function renameVersion(versionId, notes) {
      return supabaseRpc('rename_dashboard_version', {
        p_username: currentUser.username,
        p_password: sessionPassword,
        p_version_id: versionId,
        p_notes: String(notes || '').trim(),
      });
    }

    function renderCompareView(payload) {
      const stageBody = document.getElementById('compare-stage-body');
      const moveBody = document.getElementById('compare-move-body');
      if (!stageBody || !moveBody) return;
      stageBody.innerHTML = '';
      moveBody.innerHTML = '';
      const stageDeltas = payload.stage_deltas || [];
      stageDeltas.forEach((sellerBlock) => {
        (sellerBlock.rows || []).forEach((r) => {
          const tr = document.createElement('tr');
          tr.appendChild(makeCell('td', sellerBlock.seller || '-'));
          tr.appendChild(makeCell('td', r.stage || '-'));
          tr.appendChild(makeCell('td', money.format(Number(r.left || 0))));
          tr.appendChild(makeCell('td', money.format(Number(r.right || 0))));
          tr.appendChild(makeCell('td', money.format(Number(r.delta || 0))));
          tr.appendChild(makeCell('td', r.pct_delta == null ? '-' : `${Number(r.pct_delta).toFixed(1)}%`));
          stageBody.appendChild(tr);
        });
      });
      const movement = payload.movement || {};
      const addRows = (label, rows, fromKey, toKey) => {
        (rows || []).forEach((r) => {
          const tr = document.createElement('tr');
          tr.appendChild(makeCell('td', label));
          tr.appendChild(makeCell('td', r.deal || '-'));
          tr.appendChild(makeCell('td', r.seller || '-'));
          tr.appendChild(makeCell('td', r.intro_month || '-'));
          tr.appendChild(makeCell('td', fromKey ? (r[fromKey] || '-') : '-'));
          tr.appendChild(makeCell('td', toKey ? (r[toKey] || '-') : '-'));
          moveBody.appendChild(tr);
        });
      };
      addRows('Added', movement.added || [], null, 'stage');
      addRows('Removed', movement.removed || [], 'stage', null);
      addRows('Stage Changed', movement.stage_changed || [], 'left_stage', 'right_stage');

      const leftMeta = payload.left_version || {};
      const rightMeta = payload.right_version || {};
      const counts = (movement.counts || {});
      const stuckRows = payload.stuck_deltas || [];
      const topStuck = [...stuckRows].sort((a, b) => Math.abs(Number(b.delta || 0)) - Math.abs(Number(a.delta || 0)))[0];
      const introRows = payload.intro_deltas || [];
      const topIntro = [...introRows].sort((a, b) => Math.abs(Number(b.delta_total || 0)) - Math.abs(Number(a.delta_total || 0)))[0];
      const lines = [
        `Left: ${versionLabel(leftMeta)} | Right: ${versionLabel(rightMeta)}`,
        `Movement counts -> Added: ${money.format(Number(counts.added || 0))}, Removed: ${money.format(Number(counts.removed || 0))}, Stage changed: ${money.format(Number(counts.stage_changed || 0))}.`,
      ];
      if (topStuck) lines.push(`Largest stuck delta: ${topStuck.seller} (${money.format(Number(topStuck.delta || 0))}).`);
      if (topIntro) lines.push(`Largest intro-total delta: ${topIntro.seller} (${money.format(Number(topIntro.delta_total || 0))}).`);
      setInsight('insight-compare', lines);
    }

    function canonicalDealKey(deal, month) {
      return `${String(deal || '').trim().toLowerCase()}||${String(month || '').trim().toLowerCase()}`;
    }

    function canonicalDealStageKey(deal, month, stage) {
      return `${canonicalDealKey(deal, month)}||${String(stage || '').trim().toLowerCase()}`;
    }

    function buildSellerLookupFromDataset(dataset) {
      const out = { byStage: {}, byDealMonth: {} };
      const sellersObj = (dataset && dataset.scorecard && dataset.scorecard.sellers) || {};
      Object.entries(sellersObj).forEach(([seller, metric]) => {
        if (seller === 'All (unique deals)') return;
        const details = (metric && metric.kpi_details) || {};
        const rows = [...(details.stage_1_6 || []), ...(details.stage_7_8 || [])];
        rows.forEach((r) => {
          const deal = r && r.deal;
          const month = r && r.created_month;
          const stage = r && r.stage;
          if (!deal || !month) return;
          out.byDealMonth[canonicalDealKey(deal, month)] = seller;
          if (stage) out.byStage[canonicalDealStageKey(deal, month, stage)] = seller;
        });
      });
      return out;
    }

    function sellerFromMovementRow(row, leftLookup, rightLookup) {
      const raw = String((row && row.seller) || '').trim();
      const rawLower = raw.toLowerCase();
      if (raw && rawLower !== 'all (unique deals)' && rawLower !== 'unknown') return raw;
      const deal = row && row.deal;
      const month = (row && row.intro_month) || (row && row.created_month);
      if (!deal || !month) return raw || 'Unknown';
      const stageRight = row && (row.right_stage || row.stage);
      const stageLeft = row && (row.left_stage || row.stage);
      const tryMaps = [
        [rightLookup && rightLookup.byStage, canonicalDealStageKey(deal, month, stageRight)],
        [leftLookup && leftLookup.byStage, canonicalDealStageKey(deal, month, stageLeft)],
        [rightLookup && rightLookup.byDealMonth, canonicalDealKey(deal, month)],
        [leftLookup && leftLookup.byDealMonth, canonicalDealKey(deal, month)],
      ];
      for (const [map, key] of tryMaps) {
        if (map && key && map[key]) return map[key];
      }
      return raw || 'Unknown';
    }

    function momentumStageInScope(stage, scope) {
      const num = stageNumber(stage);
      if (num == null) return false;
      const maxStage = scope === 'all' ? MOMENTUM_ALL_STAGE_MAX : MOMENTUM_CORE_STAGE_MAX;
      return num >= 1 && num <= maxStage;
    }

    function momentumAdditionPoints(stage, scope) {
      const num = stageNumber(stage);
      if (num == null) return 0;
      if (scope === 'core' && num > MOMENTUM_CORE_STAGE_MAX) return 0;
      if (scope === 'all' && num > MOMENTUM_ALL_STAGE_MAX) return 0;
      if (num <= 2) return 1.0;
      if (num <= 4) return 1.5;
      if (num <= 6) return 1.2;
      return 0.6;
    }

    function momentumStatus(score) {
      if (score > 2) return 'Positive';
      if (score < -2) return 'Negative';
      return 'Stalled';
    }

    function collectMomentumDealRows(payload, scope, leftLookup, rightLookup) {
      const movement = payload && payload.movement ? payload.movement : {};
      const rows = [];
      (movement.stage_changed || []).forEach((r) => {
        const seller = sellerFromMovementRow(r, leftLookup, rightLookup);
        const leftN = stageNumber(r.left_stage);
        const rightN = stageNumber(r.right_stage);
        if (leftN == null || rightN == null) return;
        const maxStage = scope === 'all' ? MOMENTUM_ALL_STAGE_MAX : MOMENTUM_CORE_STAGE_MAX;
        if (leftN > maxStage || rightN > maxStage) return;
        const direction = rightN > leftN ? 'Forward' : (rightN < leftN ? 'Backward' : 'Unchanged');
        rows.push({
          deal: r.deal || '-',
          seller,
          fromStage: r.left_stage || '-',
          toStage: r.right_stage || '-',
          movement: direction,
          introMonth: r.intro_month || '-',
        });
      });
      (movement.added || []).forEach((r) => {
        if (!momentumStageInScope(r.stage, scope)) return;
        const seller = sellerFromMovementRow(r, leftLookup, rightLookup);
        rows.push({
          deal: r.deal || '-',
          seller,
          fromStage: '-',
          toStage: r.stage || '-',
          movement: 'New',
          introMonth: r.intro_month || '-',
        });
      });
      return rows;
    }

    function renderMomentumDealDetails(title, records) {
      const titleEl = document.getElementById('momentum-detail-title');
      const metaEl = document.getElementById('momentum-detail-meta');
      const body = document.getElementById('momentum-detail-body');
      if (!titleEl || !metaEl || !body) return;
      titleEl.textContent = title;
      metaEl.textContent = `${money.format(records.length)} deal(s)`;
      body.innerHTML = '';
      if (!records.length) {
        const tr = document.createElement('tr');
        tr.appendChild(makeCell('td', 'No deals found'));
        tr.appendChild(makeCell('td', '-'));
        tr.appendChild(makeCell('td', '-'));
        tr.appendChild(makeCell('td', '-'));
        tr.appendChild(makeCell('td', '-'));
        tr.appendChild(makeCell('td', '-'));
        body.appendChild(tr);
        return;
      }
      const rows = [...records].sort((a, b) => {
        const s = String(a.seller || '').localeCompare(String(b.seller || ''));
        if (s !== 0) return s;
        return String(a.deal || '').localeCompare(String(b.deal || ''));
      });
      rows.forEach((r) => {
        const tr = document.createElement('tr');
        tr.appendChild(makeCell('td', r.deal || '-'));
        tr.appendChild(makeCell('td', r.seller || '-'));
        tr.appendChild(makeCell('td', r.fromStage || '-'));
        tr.appendChild(makeCell('td', r.toStage || '-'));
        tr.appendChild(makeCell('td', r.movement || '-'));
        tr.appendChild(makeCell('td', r.introMonth || '-'));
        body.appendChild(tr);
      });
    }

    function renderMomentumSellerFilter(data) {
      const sellerSelect = document.getElementById('momentum-seller');
      if (!sellerSelect) return;
      const current = sellerSelect.value || 'Overall';
      const sellers = (data.sellers || []).filter((s) => s !== 'All (unique deals)');
      sellerSelect.innerHTML = '';
      ['Overall', ...sellers].forEach((seller) => {
        const o = document.createElement('option');
        o.value = seller;
        o.textContent = seller;
        sellerSelect.appendChild(o);
      });
      sellerSelect.value = [...sellerSelect.options].some((x) => x.value === current) ? current : 'Overall';
    }

    function computeSellerFlowFromStageRows(rows, scope) {
      const maxStage = scope === 'all' ? MOMENTUM_ALL_STAGE_MAX : MOMENTUM_CORE_STAGE_MAX;
      const normalized = (rows || [])
        .map((r) => ({
          stage: stageNumber(r.stage),
          left: Number(r.left || 0),
          right: Number(r.right || 0),
          delta: Number(r.delta || 0),
        }))
        .filter((r) => r.stage != null && r.stage >= 1 && r.stage <= maxStage)
        .sort((a, b) => a.stage - b.stage);
      const deficits = normalized.filter((r) => r.delta < 0).map((r) => ({ stage: r.stage, qty: Math.abs(r.delta) }));
      const surpluses = normalized.filter((r) => r.delta > 0).map((r) => ({ stage: r.stage, qty: r.delta }));
      let forwardPoints = 0;
      let backwardPoints = 0;
      let matchedQty = 0;
      deficits.forEach((d) => {
        while (d.qty > 0) {
          let bestIdx = -1;
          let bestDist = Number.POSITIVE_INFINITY;
          for (let i = 0; i < surpluses.length; i += 1) {
            const s = surpluses[i];
            if (!s || s.qty <= 0) continue;
            const dist = Math.abs(s.stage - d.stage);
            if (dist < bestDist) {
              bestDist = dist;
              bestIdx = i;
            }
          }
          if (bestIdx < 0) break;
          const s = surpluses[bestIdx];
          const q = Math.min(d.qty, s.qty);
          if (s.stage > d.stage) forwardPoints += q * (s.stage - d.stage);
          else if (s.stage < d.stage) backwardPoints += q * (d.stage - s.stage);
          matchedQty += q;
          d.qty -= q;
          s.qty -= q;
        }
      });
      const additions = surpluses.reduce((acc, s) => acc + Math.max(0, Number(s.qty || 0)), 0);
      const removals = deficits.reduce((acc, d) => acc + Math.max(0, Number(d.qty || 0)), 0);
      const leftTotal = normalized.reduce((acc, r) => acc + r.left, 0);
      const unchanged = Math.max(0, leftTotal - removals - matchedQty);
      return {
        forwardPoints,
        backwardPoints,
        additions,
        unchanged,
      };
    }

    function buildMomentumRows(payload, scope, knownSellers, leftLookup, rightLookup) {
      const movement = payload.movement || {};
      const stageDeltas = payload.stage_deltas || [];
      const stuckDeltas = payload.stuck_deltas || [];
      const rowsBySeller = {};
      const init = (seller) => {
        if (rowsBySeller[seller]) return rowsBySeller[seller];
        rowsBySeller[seller] = {
          seller,
          forwardPoints: 0,
          backwardPoints: 0,
          additions: 0,
          additionPoints: 0,
          unchanged: 0,
          stuckDelta: 0,
          stage56Delta: 0,
          score: 0,
          status: 'Stalled',
        };
        return rowsBySeller[seller];
      };

      (knownSellers || []).forEach((s) => init(s));

      stageDeltas.forEach((sellerBlock) => {
        const seller = String(sellerBlock.seller || '').trim();
        if (!seller) return;
        const row = init(seller);
        const flow = computeSellerFlowFromStageRows(sellerBlock.rows || [], scope);
        row.forwardPoints = flow.forwardPoints;
        row.backwardPoints = flow.backwardPoints;
        row.additions = flow.additions;
        row.unchanged = flow.unchanged;
        row.additionPoints = (sellerBlock.rows || []).reduce((acc, x) => {
          const d = Number(x.delta || 0);
          if (d <= 0) return acc;
          const stage = stageNumber(x.stage);
          if (stage == null) return acc;
          if (!momentumStageInScope(x.stage, scope)) return acc;
          return acc + (d * momentumAdditionPoints(x.stage, scope));
        }, 0);
      });

      stuckDeltas.forEach((r) => {
        const seller = String(r.seller || '').trim();
        if (!seller) return;
        const row = init(seller);
        row.stuckDelta = Number(r.delta || 0);
      });

      stageDeltas.forEach((sellerBlock) => {
        const seller = String(sellerBlock.seller || '').trim();
        if (!seller) return;
        const row = init(seller);
        const late = (sellerBlock.rows || []).filter((x) => {
          const n = stageNumber(x.stage);
          return n != null && n >= 5 && n <= 6;
        });
        row.stage56Delta = late.reduce((acc, x) => acc + Number(x.delta || 0), 0);
      });

      const rows = Object.values(rowsBySeller).map((r) => {
        const stuckPenalty = r.stuckDelta > 0 ? (r.stuckDelta * 2) : (r.stuckDelta * 1.2);
        const score = r.forwardPoints - r.backwardPoints + r.additionPoints - stuckPenalty;
        return {
          ...r,
          score,
          status: momentumStatus(score),
        };
      });
      rows.sort((a, b) => b.score - a.score || a.seller.localeCompare(b.seller));
      return rows;
    }

    function renderMomentumCards(rows, payload, scope, leftLookup, rightLookup) {
      const cards = document.getElementById('momentum-cards');
      if (!cards) return;
      cards.innerHTML = '';
      const detailRows = collectMomentumDealRows(payload, scope, leftLookup, rightLookup);
      if (!rows.length) {
        const empty = document.createElement('div');
        empty.className = 'momentum-card';
        empty.textContent = 'No momentum records for selected view.';
        cards.appendChild(empty);
        return;
      }
      rows.forEach((r) => {
        const card = document.createElement('div');
        card.className = 'momentum-card clickable';
        const head = document.createElement('div');
        head.className = 'momentum-card-head';
        const seller = document.createElement('div');
        seller.className = 'momentum-seller';
        seller.textContent = r.seller;
        const status = document.createElement('div');
        status.className = `momentum-status ${r.status.toLowerCase()}`;
        status.textContent = r.status;
        head.appendChild(seller);
        head.appendChild(status);
        card.appendChild(head);

        const kpis = document.createElement('div');
        kpis.className = 'momentum-kpis';
        const items = [
          ['Score', r.score.toFixed(1), 'all'],
          ['Forward', money.format(r.forwardPoints), 'forward'],
          ['Backward', money.format(r.backwardPoints), 'backward'],
          ['New', money.format(r.additions), 'new'],
        ];
        const sellerRows = detailRows.filter((x) => x.seller === r.seller);
        const openDetails = (mode) => {
          let filtered = sellerRows;
          if (mode === 'forward') filtered = sellerRows.filter((x) => x.movement === 'Forward');
          else if (mode === 'backward') filtered = sellerRows.filter((x) => x.movement === 'Backward');
          else if (mode === 'new') filtered = sellerRows.filter((x) => x.movement === 'New');
          renderMomentumDealDetails(`${r.seller} | ${mode === 'all' ? 'All moved deals' : mode} deals`, filtered);
        };
        items.forEach(([label, value, mode]) => {
          const box = document.createElement('div');
          box.className = 'momentum-kpi';
          const l = document.createElement('div');
          l.className = 'momentum-kpi-label';
          l.textContent = label;
          const v = document.createElement('div');
          v.className = 'momentum-kpi-value';
          v.textContent = value;
          box.appendChild(l);
          box.appendChild(v);
          box.addEventListener('click', (evt) => {
            evt.stopPropagation();
            cards.querySelectorAll('.momentum-kpi').forEach((el) => el.classList.remove('active'));
            box.classList.add('active');
            openDetails(mode);
          });
          kpis.appendChild(box);
        });
        card.appendChild(kpis);
        card.addEventListener('click', () => {
          cards.querySelectorAll('.momentum-kpi').forEach((el) => el.classList.remove('active'));
          openDetails('all');
        });
        cards.appendChild(card);
      });
    }

    function renderMomentumView(payload, data, leftLookup, rightLookup) {
      const body = document.getElementById('momentum-body');
      const sellerFilter = document.getElementById('momentum-seller');
      const scopeSel = document.getElementById('momentum-scope');
      if (!body || !sellerFilter || !scopeSel) return;
      const scope = scopeSel.value || 'core';
      const knownSellers = (data.sellers || []).filter((s) => s !== 'All (unique deals)');
      const allRows = buildMomentumRows(payload, scope, knownSellers, leftLookup, rightLookup);
      const pick = sellerFilter.value || 'Overall';
      const rows = pick === 'Overall' ? allRows : allRows.filter((x) => x.seller === pick);

      body.innerHTML = '';
      rows.forEach((r) => {
        const tr = document.createElement('tr');
        tr.appendChild(makeCell('td', r.seller));
        tr.appendChild(makeCell('td', r.status));
        tr.appendChild(makeCell('td', r.score.toFixed(1)));
        tr.appendChild(makeCell('td', money.format(r.forwardPoints)));
        tr.appendChild(makeCell('td', money.format(r.backwardPoints)));
        tr.appendChild(makeCell('td', money.format(r.additions)));
        tr.appendChild(makeCell('td', money.format(r.unchanged)));
        tr.appendChild(makeCell('td', (r.stuckDelta > 0 ? '+' : '') + money.format(r.stuckDelta)));
        tr.appendChild(makeCell('td', (r.stage56Delta > 0 ? '+' : '') + money.format(r.stage56Delta)));
        body.appendChild(tr);
      });
      if (!rows.length) {
        const tr = document.createElement('tr');
        tr.appendChild(makeCell('td', 'No rows'));
        tr.appendChild(makeCell('td', '-'));
        tr.appendChild(makeCell('td', '-'));
        tr.appendChild(makeCell('td', '-'));
        tr.appendChild(makeCell('td', '-'));
        tr.appendChild(makeCell('td', '-'));
        tr.appendChild(makeCell('td', '-'));
        tr.appendChild(makeCell('td', '-'));
        tr.appendChild(makeCell('td', '-'));
        body.appendChild(tr);
      }

      renderMomentumCards(rows, payload, scope, leftLookup, rightLookup);
      const detailRows = collectMomentumDealRows(payload, scope, leftLookup, rightLookup);
      if (pick === 'Overall') {
        renderMomentumDealDetails('Overall | All moved deals', detailRows);
      } else {
        renderMomentumDealDetails(`${pick} | All moved deals`, detailRows.filter((x) => x.seller === pick));
      }
      const positives = rows.filter((r) => r.status === 'Positive').length;
      const negatives = rows.filter((r) => r.status === 'Negative').length;
      const stalled = rows.filter((r) => r.status === 'Stalled').length;
      const top = [...rows].sort((a, b) => b.score - a.score)[0];
      const bottom = [...rows].sort((a, b) => a.score - b.score)[0];
      const scopeLabel = scope === 'all' ? '1-8' : '1-6';
      const lines = [
        `Scope ${scopeLabel}: Positive ${money.format(positives)}, Stalled ${money.format(stalled)}, Negative ${money.format(negatives)}.`,
      ];
      if (top) lines.push(`Best momentum: ${top.seller} (score ${top.score.toFixed(1)}, forward ${money.format(top.forwardPoints)}, new ${money.format(top.additions)}).`);
      if (bottom) lines.push(`Weakest momentum: ${bottom.seller} (score ${bottom.score.toFixed(1)}, backward ${money.format(bottom.backwardPoints)}, stuck delta ${(bottom.stuckDelta > 0 ? '+' : '') + money.format(bottom.stuckDelta)}).`);
      setInsight('insight-momentum', lines);
    }

    function renderDetailTable(title, records) {
      const detailTitle = document.getElementById('detail-title');
      const detailMeta = document.getElementById('detail-meta');
      const detailBody = document.getElementById('detail-body');
      detailTitle.textContent = title;
      detailMeta.textContent = `${money.format(records.length)} deal(s)`;
      detailBody.innerHTML = '';

      if (!records.length) {
        const tr = document.createElement('tr');
        tr.appendChild(makeCell('td', 'No deals found', ''));
        tr.appendChild(makeCell('td', '-', ''));
        tr.appendChild(makeCell('td', '-', ''));
        detailBody.appendChild(tr);
        return;
      }

      records.forEach((rec) => {
        const tr = document.createElement('tr');
        tr.appendChild(makeCell('td', rec.deal));
        tr.appendChild(makeCell('td', rec.stage));
        tr.appendChild(makeCell('td', rec.month));
        detailBody.appendChild(tr);
      });
    }

    function sortedRecords(records) {
      return [...records].sort((a, b) => {
        if (a.deal !== b.deal) return a.deal.localeCompare(b.deal);
        if (a.stage !== b.stage) return a.stage.localeCompare(b.stage);
        return a.month.localeCompare(b.month);
      });
    }

    function render(data, seller, selectedStages, orderedStages) {
      const months = data.months;
      const tableData = buildGroupedTable(data.tables[seller] || {});
      const detailData = buildGroupedDetails((data.details || {})[seller] || {});
      const carryData = buildGroupedCarry((data.carry_in || {})[seller] || {});
      const stages = orderedStages.filter(s => selectedStages.has(s));

      const table = document.getElementById('pivot');
      table.innerHTML = '';

      const thead = document.createElement('thead');
      const hr = document.createElement('tr');
      hr.appendChild(makeCell('th', 'Deal Stage'));
      for (const m of months) hr.appendChild(makeCell('th', m));
      hr.appendChild(makeCell('th', 'Total'));
      thead.appendChild(hr);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      const colTotals = Array(months.length).fill(0);
      let grandTotal = 0;

      for (const stage of stages) {
        const tr = document.createElement('tr');
        const stageCell = makeCell('td', stage, 'row-label');
        tr.appendChild(stageCell);
        const monthMap = tableData[stage] || {};
        const monthDeals = detailData[stage] || {};
        const monthCarry = carryData[stage] || {};

        const stageRecords = [];
        months.forEach((m) => {
          (monthDeals[m] || []).forEach((deal) => {
            stageRecords.push({ deal, stage, month: m });
          });
        });
        stageCell.addEventListener('click', () => {
          renderDetailTable(`${seller} | ${stage} | All Months`, sortedRecords(stageRecords));
        });

        let rowTotal = 0;
        months.forEach((m, idx) => {
          const v = Number(monthMap[m] || 0);
          const carry = Number(monthCarry[m] || 0);
          rowTotal += v;
          colTotals[idx] += v;
          const classes = ['clickable'];
          if (carry > 0) classes.push('carry-in');
          const td = makeCell('td', money.format(v), classes.join(' '));
          if (carry > 0) {
            td.title = `${carry} carried-in deal(s): intro date before 2024-10-01`;
          }
          td.addEventListener('click', () => {
            const records = (monthDeals[m] || []).map((deal) => ({ deal, stage, month: m }));
            renderDetailTable(`${seller} | ${stage} | ${m}`, sortedRecords(records));
          });
          tr.appendChild(td);
        });

        grandTotal += rowTotal;
        const rowTotalCell = makeCell('td', money.format(rowTotal), 'clickable');
        rowTotalCell.addEventListener('click', () => {
          renderDetailTable(`${seller} | ${stage} | All Months`, sortedRecords(stageRecords));
        });
        tr.appendChild(rowTotalCell);
        tbody.appendChild(tr);
      }

      const totalRow = document.createElement('tr');
      totalRow.className = 'total-row';
      totalRow.appendChild(makeCell('td', 'Total'));
      colTotals.forEach((v, idx) => {
        const m = months[idx];
        const td = makeCell('td', money.format(v), 'clickable');
        td.addEventListener('click', () => {
          const combined = [];
          stages.forEach((stage) => {
            const monthDeals = (detailData[stage] || {})[m] || [];
            monthDeals.forEach((deal) => combined.push({ deal, stage, month: m }));
          });
          renderDetailTable(`${seller} | All Stages | ${m}`, sortedRecords(combined));
        });
        totalRow.appendChild(td);
      });
      const grandCell = makeCell('td', money.format(grandTotal), 'clickable');
      grandCell.addEventListener('click', () => {
        const combined = [];
        stages.forEach((stage) => {
          months.forEach((m) => {
            ((detailData[stage] || {})[m] || []).forEach((deal) => combined.push({ deal, stage, month: m }));
          });
        });
        renderDetailTable(`${seller} | All Stages | All Months`, sortedRecords(combined));
      });
      totalRow.appendChild(grandCell);
      tbody.appendChild(totalRow);
      table.appendChild(tbody);

      const activeMonths = colTotals.filter(v => v > 0).length;
      const stats = document.getElementById('stats');
      stats.innerHTML = '';
      stats.appendChild(makeCell('div', `Stages: ${stages.length}`, 'chip'));
      stats.appendChild(makeCell('div', `Months active: ${activeMonths}/${months.length}`, 'chip'));
      stats.appendChild(makeCell('div', `Deals counted: ${money.format(grandTotal)}`, 'chip'));

      const stageTotals = stages.map((stage) => ({
        stage,
        total: Object.values(tableData[stage] || {}).reduce((a, b) => a + Number(b || 0), 0),
      })).sort((a, b) => b.total - a.total);
      const monthTotals = months.map((m, idx) => ({ month: m, total: colTotals[idx] })).sort((a, b) => b.total - a.total);
      const carryCount = stages.reduce((acc, stage) => {
        return acc + Object.values(carryData[stage] || {}).reduce((a, b) => a + Number(b || 0), 0);
      }, 0);
      const lines = [
        `${seller}: ${money.format(grandTotal)} total deals across ${stages.length} selected stages.`,
        stageTotals.length ? `Highest-volume stage: ${stageTotals[0].stage} (${money.format(stageTotals[0].total)} deals).` : 'No stage volume in current selection.',
        monthTotals.length ? `Most active create month: ${monthTotals[0].month} (${money.format(monthTotals[0].total)} deals).` : 'No month activity in current selection.',
      ];
      if (carryCount > 0) {
        lines.push(`${money.format(carryCount)} carried-in stage 1-6 deal(s) are present (highlighted in amber).`);
      }
      setInsight('insight-crosstab', lines);
    }

    function renderFunnel(data, selectedFunnelStages, minMonth) {
      const orderedFunnelStages = getOrderedFunnelStages(data.stages || []);
      const matterStages = orderedFunnelStages.filter((s) => selectedFunnelStages.has(s));
      const funnelWrap = document.getElementById('funnel-wrap');
      funnelWrap.innerHTML = '';

      const sellers = data.sellers.filter((s) => s !== 'All (unique deals)');
      const sellerSummaries = [];
      sellers.forEach((seller) => {
        const grouped = buildGroupedTable(data.tables[seller] || {});
        const counts = matterStages.map((stage) =>
          Object.entries(grouped[stage] || {})
            .filter(([m]) => !minMonth || m >= minMonth)
            .reduce((a, [, b]) => a + Number(b || 0), 0)
        );
        const reached = counts.map((_, idx) => counts.slice(idx).reduce((a, b) => a + b, 0));

        const card = document.createElement('div');
        card.className = 'funnel-card';

        const title = document.createElement('div');
        title.className = 'funnel-title';
        title.textContent = seller;
        card.appendChild(title);

        const table = document.createElement('table');
        table.className = 'funnel-table';
        const thead = document.createElement('thead');
        const hrow = document.createElement('tr');
        hrow.appendChild(makeCell('th', 'Stage'));
        hrow.appendChild(makeCell('th', 'Count'));
        hrow.appendChild(makeCell('th', 'Reached'));
        hrow.appendChild(makeCell('th', 'Conv to Next'));
        thead.appendChild(hrow);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        matterStages.forEach((stage, idx) => {
          const tr = document.createElement('tr');
          const curr = counts[idx];
          const reachedCurr = reached[idx] || 0;
          const conv = idx === matterStages.length - 1 ? '-' : (reachedCurr > 0 ? `${((reached[idx + 1] / reachedCurr) * 100).toFixed(1)}%` : 'n/a');
          tr.appendChild(makeCell('td', stage));
          tr.appendChild(makeCell('td', money.format(curr)));
          tr.appendChild(makeCell('td', money.format(reachedCurr)));
          tr.appendChild(makeCell('td', conv));
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        card.appendChild(table);

        const total = counts.reduce((a, b) => a + b, 0);
        const allStagesTotal = Object.entries(grouped).reduce((acc, [, monthMap]) => {
          const subtotal = Object.entries(monthMap || {})
            .filter(([m]) => !minMonth || m >= minMonth)
            .reduce((a, [, v]) => a + Number(v || 0), 0);
          return acc + subtotal;
        }, 0);
        const noShowCount = Object.entries(grouped['10. No Show/ Reschedule'] || {})
          .filter(([m]) => !minMonth || m >= minMonth)
          .reduce((a, [, v]) => a + Number(v || 0), 0);
        const foot = document.createElement('div');
        foot.className = 'funnel-foot';
        foot.innerHTML = [
          `Total across selected stages (Intro >= ${minMonth || '-'}) : <strong>${money.format(total)}</strong>`,
          `No Show/ Reschedule count: <strong>${money.format(noShowCount)}</strong>`,
          `Total across all stages: <strong>${money.format(allStagesTotal)}</strong>`
        ].join('<br/>');
        card.appendChild(foot);

        funnelWrap.appendChild(card);
        const topIdx = counts.findIndex((v) => v === Math.max(...counts, 0));
        let weakest = null;
        for (let i = 0; i < matterStages.length - 1; i++) {
          const conv = reached[i] > 0 ? (reached[i + 1] / reached[i]) : null;
          if (conv == null) continue;
          if (!weakest || conv < weakest.conv) {
            weakest = { from: matterStages[i], to: matterStages[i + 1], conv };
          }
        }
        sellerSummaries.push({
          seller,
          total,
          topStage: topIdx >= 0 ? matterStages[topIdx] : null,
          topCount: topIdx >= 0 ? counts[topIdx] : 0,
          weakest,
        });
      });
      const topSeller = [...sellerSummaries].sort((a, b) => b.total - a.total)[0];
      const weakList = sellerSummaries.filter((s) => s.weakest).sort((a, b) => a.weakest.conv - b.weakest.conv).slice(0, 2);
      const lines = [];
      if (topSeller) {
        lines.push(`Highest selected-stage volume: ${topSeller.seller} (${money.format(topSeller.total)} deals; top stage: ${topSeller.topStage || '-'}).`);
      }
      if (weakList.length) {
        lines.push(`Weakest step-off(s): ${weakList.map((w) => `${w.seller} ${w.weakest.from} -> ${w.weakest.to} (${(w.weakest.conv * 100).toFixed(1)}%)`).join(' | ')}.`);
      }
      lines.push(`Current funnel cutoff in this tab: Intro >= ${minMonth || '-'} (with stage filter applied).`);
      setInsight('insight-funnel', lines);
    }

    function setupTabs() {
      const appendixRow = document.getElementById('tabs-appendix');
      const tabCross = document.getElementById('tab-crosstab');
      const tabFunnel = document.getElementById('tab-funnel');
      const tabScore = document.getElementById('tab-scorecard');
      const tabIndustry = document.getElementById('tab-industry');
      const tabWinLoss = document.getElementById('tab-winloss');
      const tabIntroTrend = document.getElementById('tab-introtrend');
      const tabCompare = document.getElementById('tab-compare');
      const tabMomentum = document.getElementById('tab-momentum');
      const tabForecast = document.getElementById('tab-forecast');
      const tabCycleTime = document.getElementById('tab-cycletime');
      const tabAssumptions = document.getElementById('tab-assumptions');
      const tabAppendix = document.getElementById('tab-appendix');
      const tabAdmin = document.getElementById('tab-admin');
      const viewCross = document.getElementById('view-crosstab');
      const viewFunnel = document.getElementById('view-funnel');
      const viewScore = document.getElementById('view-scorecard');
      const viewIndustry = document.getElementById('view-industry');
      const viewWinLoss = document.getElementById('view-winloss');
      const viewIntroTrend = document.getElementById('view-introtrend');
      const viewCompare = document.getElementById('view-compare');
      const viewMomentum = document.getElementById('view-momentum');
      const viewForecast = document.getElementById('view-forecast');
      const viewCycleTime = document.getElementById('view-cycletime');
      const viewAssumptions = document.getElementById('view-assumptions');
      const viewAdmin = document.getElementById('view-admin');
      const appendixViews = new Set(['crosstab', 'funnel', 'industry', 'winloss', 'compare', 'momentum', 'cycletime', 'assumptions']);
      let appendixOpen = false;

      function setAppendixOpen(next) {
        appendixOpen = !!next;
        if (appendixRow) appendixRow.style.display = appendixOpen ? '' : 'none';
        if (tabAppendix) tabAppendix.setAttribute('aria-expanded', appendixOpen ? 'true' : 'false');
      }

      function activate(name) {
        const isAppendixView = appendixViews.has(name);
        tabAppendix.classList.toggle('active', isAppendixView);
        tabCross.classList.toggle('active', name === 'crosstab');
        tabFunnel.classList.toggle('active', name === 'funnel');
        tabScore.classList.toggle('active', name === 'scorecard');
        tabIndustry.classList.toggle('active', name === 'industry');
        tabWinLoss.classList.toggle('active', name === 'winloss');
        tabIntroTrend.classList.toggle('active', name === 'introtrend');
        tabCompare.classList.toggle('active', name === 'compare');
        tabMomentum.classList.toggle('active', name === 'momentum');
        tabForecast.classList.toggle('active', name === 'forecast');
        tabCycleTime.classList.toggle('active', name === 'cycletime');
        tabAssumptions.classList.toggle('active', name === 'assumptions');
        tabAdmin.classList.toggle('active', name === 'admin');
        viewCross.classList.toggle('active', name === 'crosstab');
        viewFunnel.classList.toggle('active', name === 'funnel');
        viewScore.classList.toggle('active', name === 'scorecard');
        viewIndustry.classList.toggle('active', name === 'industry');
        viewWinLoss.classList.toggle('active', name === 'winloss');
        viewIntroTrend.classList.toggle('active', name === 'introtrend');
        viewCompare.classList.toggle('active', name === 'compare');
        viewMomentum.classList.toggle('active', name === 'momentum');
        viewForecast.classList.toggle('active', name === 'forecast');
        viewCycleTime.classList.toggle('active', name === 'cycletime');
        viewAssumptions.classList.toggle('active', name === 'assumptions');
        viewAdmin.classList.toggle('active', name === 'admin');

        // Keep appendix tabs hidden unless explicitly opened or user is on an appendix view.
        if (name === 'admin' || name === 'scorecard' || name === 'introtrend' || name === 'forecast') {
          setAppendixOpen(false);
        } else if (isAppendixView) {
          setAppendixOpen(true);
        }
      }

      activateTab = activate;

      tabCross.addEventListener('click', () => activate('crosstab'));
      tabFunnel.addEventListener('click', () => activate('funnel'));
      tabScore.addEventListener('click', () => activate('scorecard'));
      tabIndustry.addEventListener('click', () => activate('industry'));
      tabWinLoss.addEventListener('click', () => activate('winloss'));
      tabIntroTrend.addEventListener('click', () => activate('introtrend'));
      tabCompare.addEventListener('click', () => activate('compare'));
      tabMomentum.addEventListener('click', () => activate('momentum'));
      tabForecast.addEventListener('click', () => activate('forecast'));
      tabCycleTime.addEventListener('click', () => activate('cycletime'));
      tabAssumptions.addEventListener('click', () => activate('assumptions'));
      tabAdmin.addEventListener('click', () => activate('admin'));
      tabAppendix.addEventListener('click', () => setAppendixOpen(!appendixOpen));

      // Initialize appendix row hidden unless we start on an appendix view.
      setAppendixOpen(false);
    }

    function pct(x) {
      return `${(Number(x || 0) * 100).toFixed(1)}%`;
    }

    function closeKpiPopup() {
      activePopupSeller = null;
      const popup = document.getElementById('kpi-popup');
      popup.classList.remove('open');
      popup.setAttribute('aria-hidden', 'true');
    }

    function openKpiPopup(title, records, summarySeller = null) {
      activePopupSeller = summarySeller;
      const popup = document.getElementById('kpi-popup');
      const body = document.getElementById('kpi-popup-body');
      document.getElementById('kpi-popup-title').textContent = `${title} (${money.format(records.length)})`;
      body.innerHTML = '';
      if (!records.length) {
        const tr = document.createElement('tr');
        tr.appendChild(makeCell('td', 'No deals found'));
        tr.appendChild(makeCell('td', '-'));
        tr.appendChild(makeCell('td', '-'));
        tr.appendChild(makeCell('td', '-'));
        tr.appendChild(makeCell('td', '-'));
        tr.appendChild(makeCell('td', '-'));
        tr.appendChild(makeCell('td', '-'));
        tr.appendChild(makeCell('td', '-'));
        body.appendChild(tr);
      } else {
        const rows = [...records].sort((a, b) => {
          const ad = (a.deal || '').toLowerCase();
          const bd = (b.deal || '').toLowerCase();
          if (ad !== bd) return ad.localeCompare(bd);
          return (a.stage || '').localeCompare(b.stage || '');
        });
        rows.forEach((r) => {
          const tr = document.createElement('tr');
          tr.appendChild(makeCell('td', r.deal || '-'));
          tr.appendChild(makeCell('td', r.stage || '-'));
          tr.appendChild(makeCell('td', r.created_month || '-'));
          tr.appendChild(makeCell('td', r.start_date || '-'));
          tr.appendChild(makeCell('td', r.age_days == null ? '-' : money.format(r.age_days)));
          tr.appendChild(makeCell('td', fmtDealSize(r.deal_size)));
          tr.appendChild(makeCell('td', r.reason || '-'));
          const selTd = document.createElement('td');
          const select = document.createElement('select');
          select.className = 'popup-likelihood-select';
          const options = [
            ['', '-- Select --'],
            [LIKELIHOOD_THIS_Q, activeQuarterLabels.current],
            [LIKELIHOOD_NEXT_Q, activeQuarterLabels.next],
            [LIKELIHOOD_HELP, 'Help Needed / Stuck'],
          ];
          options.forEach(([value, label]) => {
            const opt = document.createElement('option');
            opt.value = value;
            opt.textContent = label;
            select.appendChild(opt);
          });
          const key = likelihoodRecordKey(r);
          select.value = likelihoodState[key] || '';
          if (isHistoricalView) {
            select.disabled = true;
            select.title = 'Read-only in historical version view';
          } else {
            select.addEventListener('change', () => {
              if (select.value) likelihoodState[key] = select.value;
              else delete likelihoodState[key];
              persistLocalStateBundle();
              queueSharedStorePush();
              if (activePopupSeller) updateLikelihoodSummaryForSeller(activePopupSeller);
              else if (r.seller) updateLikelihoodSummaryForSeller(r.seller);
            });
          }
          selTd.appendChild(select);
          tr.appendChild(selTd);
          body.appendChild(tr);
        });
      }
      popup.classList.add('open');
      popup.setAttribute('aria-hidden', 'false');
    }

    function renderScorecard(data) {
      const score = data.scorecard || {};
      const sellers = data.sellers.filter((s) => s !== 'All (unique deals)');
      scorecardSellerLabels = ['Overall', ...sellers];
      const wrap = document.getElementById('score-wrap');
      wrap.innerHTML = '';
      wrap.style.gridTemplateColumns = '1fr';
      activeQuarterLabels = buildQuarterLabels(score.as_of_date);
      scorecardStateBySeller = {};
      scorecardSummaryEls = {};

      const scorecardSellerSelect = document.getElementById('scorecard-seller');
      if (scorecardSellerSelect) {
        const curr = scorecardSelectedSeller;
        scorecardSellerSelect.innerHTML = '';
        scorecardSellerLabels.forEach((name) => {
          const o = document.createElement('option');
          o.value = name;
          o.textContent = name;
          scorecardSellerSelect.appendChild(o);
        });
        if (scorecardSellerLabels.includes(curr)) scorecardSellerSelect.value = curr;
        else {
          scorecardSelectedSeller = 'Overall';
          scorecardSellerSelect.value = 'Overall';
        }
      }

      const picked = scorecardSelectedSeller;
      const renderEntries = [];
      if (picked === 'Overall') {
        renderEntries.push({ label: 'Overall', metric: (score.sellers || {})['All (unique deals)'] || {} });
      } else {
        renderEntries.push({ label: picked, metric: (score.sellers || {})[picked] || {} });
      }

      renderEntries.forEach(({ label: seller, metric: m }) => {
        scorecardStateBySeller[seller] = m;
        const card = document.createElement('div');
        card.className = 'score-card';

        const head = document.createElement('div');
        head.className = 'score-head';
        const name = document.createElement('div');
        name.className = 'score-name';
        name.textContent = seller;
        const asof = document.createElement('div');
        asof.className = 'detail-meta';
        asof.textContent = `As of ${score.as_of_date || '-'}`;
        head.appendChild(name);
        head.appendChild(asof);
        card.appendChild(head);

        const mid = document.createElement('div');
        mid.className = 'score-mid';

        const kpis = document.createElement('div');
        kpis.className = 'score-kpis';
        const details = m.kpi_details || {};
        const entries = [
          ['Stage 1-6 Total', money.format(m.stage_1_6_count || 0), 'stage_1_6'],
          ['Stage 1-2', money.format(m.stage_1_2_count || 0), 'stage_1_2'],
          ['Stage 3-4', money.format(m.stage_3_4_count || 0), 'stage_3_4'],
          ['Stage 5-6', money.format(m.stage_5_6_count || 0), 'stage_5_6'],
          ['Won/Lost (7-8)', money.format(m.stage_7_8_count || 0), 'stage_7_8'],
        ];
        entries.forEach(([label, value, detailKey]) => {
          const box = document.createElement('div');
          box.className = 'kpi clickable-kpi';
          const l = document.createElement('div');
          l.className = 'kpi-label';
          l.textContent = label;
          const v = document.createElement('div');
          v.className = 'kpi-value';
          v.textContent = value;
          box.appendChild(l);
          box.appendChild(v);
          box.addEventListener('click', () => {
            openKpiPopup(`${seller} | ${label}`, details[detailKey] || [], seller);
          });
          kpis.appendChild(box);
        });
        mid.appendChild(kpis);

        const shape = document.createElement('div');
        shape.className = 'funnel-shape';
        const shapeTitle = document.createElement('div');
        shapeTitle.className = 'funnel-shape-title';
        shapeTitle.textContent = 'Funnel Shape (By Stage)';
        shape.appendChild(shapeTitle);
        const counts = {};
        const details2 = m.kpi_details || {};
        [...(details2.stage_1_6 || []), ...(details2.stage_7_8 || [])].forEach((r) => {
          const st = String(r.stage || '').trim() || '(blank)';
          counts[st] = (counts[st] || 0) + 1;
        });
        const stages = ['1. Intro','2. Qualification','3. Capability','4. Problem Scoping','5. Contracting','6. Commercial Proposal','7. Win','8. Loss'];
        const maxV = Math.max(1, ...stages.map((s) => Number(counts[s] || 0)));
        stages.forEach((label) => {
          const value = Number(counts[label] || 0);
          const row = document.createElement('div');
          row.className = 'funnel-shape-row';
          const l = document.createElement('div');
          l.className = 'funnel-shape-label';
          l.textContent = label;
          const track = document.createElement('div');
          track.className = 'funnel-shape-track';
          const fill = document.createElement('div');
          fill.className = 'funnel-shape-fill';
          const widthPct = Math.max(4, Math.min(100, (value / maxV) * 100));
          fill.style.width = `${widthPct}%`;
          track.appendChild(fill);
          const v = document.createElement('div');
          v.className = 'funnel-shape-value';
          v.textContent = money.format(value);
          row.appendChild(l);
          row.appendChild(track);
          row.appendChild(v);
          shape.appendChild(row);
        });
        mid.appendChild(shape);
        card.appendChild(mid);

        const likelihoodGrid = document.createElement('div');
        likelihoodGrid.className = 'likelihood-grid';

        function makeLikelihoodCard(title) {
          const shell = document.createElement('div');
          shell.className = 'likelihood-table-card';
          const head2 = document.createElement('div');
          head2.className = 'likelihood-table-head';
          const t = document.createElement('div');
          t.className = 'likelihood-table-title';
          t.textContent = title;
          const meta2 = document.createElement('div');
          meta2.className = 'likelihood-table-meta';
          meta2.textContent = '0 deals';
          head2.appendChild(t);
          head2.appendChild(meta2);
          shell.appendChild(head2);
          const wrap2 = document.createElement('div');
          wrap2.className = 'likelihood-table-wrap';
          const table2 = document.createElement('table');
          table2.className = 'likelihood-mini-table';
          const thead2 = document.createElement('thead');
          const hr = document.createElement('tr');
          hr.appendChild(makeCell('th', 'Deal'));
          hr.appendChild(makeCell('th', 'Stage'));
          hr.appendChild(makeCell('th', 'Start'));
          hr.appendChild(makeCell('th', 'Size'));
          thead2.appendChild(hr);
          table2.appendChild(thead2);
          const body2 = document.createElement('tbody');
          table2.appendChild(body2);
          wrap2.appendChild(table2);
          shell.appendChild(wrap2);
          return { shell, meta: meta2, lines: body2 };
        }

        const thisCard = makeLikelihoodCard(`Closures in ${activeQuarterLabels.current}`);
        const nextCard = makeLikelihoodCard(`Closures in ${activeQuarterLabels.next}`);
        const helpCard = makeLikelihoodCard('Help Needed / Stuck');
        likelihoodGrid.appendChild(thisCard.shell);
        likelihoodGrid.appendChild(nextCard.shell);
        likelihoodGrid.appendChild(helpCard.shell);
        card.appendChild(likelihoodGrid);
        scorecardSummaryEls[seller] = {
          thisQuarterMeta: thisCard.meta,
          nextQuarterMeta: nextCard.meta,
          helpMeta: helpCard.meta,
          thisQuarterLines: thisCard.lines,
          nextQuarterLines: nextCard.lines,
          helpLines: helpCard.lines,
        };

        wrap.appendChild(card);
        updateLikelihoodSummaryForSeller(seller);
      });

      const lines = [];
      if (picked === 'Overall') {
        const rows = sellers.map((seller) => ({ seller, m: (score.sellers || {})[seller] || {} }));
        const topVol = [...rows].sort((a, b) => (b.m.stage_1_6_count || 0) - (a.m.stage_1_6_count || 0))[0];
        const topLate = [...rows].sort((a, b) => (b.m.stage_5_6_count || 0) - (a.m.stage_5_6_count || 0))[0];
        const topWL = [...rows].sort((a, b) => (b.m.stage_7_8_count || 0) - (a.m.stage_7_8_count || 0))[0];
        if (topVol) lines.push(`Largest active funnel (1-6): ${topVol.seller} with ${money.format(topVol.m.stage_1_6_count || 0)} deals.`);
        if (topLate) lines.push(`Most late-stage volume (5-6): ${topLate.seller} with ${money.format(topLate.m.stage_5_6_count || 0)} deals.`);
        if (topWL) lines.push(`Most won/lost outcomes (7-8): ${topWL.seller} with ${money.format(topWL.m.stage_7_8_count || 0)} deals.`);
      } else {
        const m = (score.sellers || {})[picked] || {};
        lines.push(`${picked}: Stage 1-6 = ${money.format(m.stage_1_6_count || 0)}, Stage 5-6 = ${money.format(m.stage_5_6_count || 0)}, Won/Lost = ${money.format(m.stage_7_8_count || 0)}.`);
      }
      setInsight('insight-scorecard', lines);
    }

    function topPills(obj, topN = 4) {
      return Object.entries(obj || {})
        .sort((a, b) => (b[1] - a[1]) || a[0].localeCompare(b[0]))
        .slice(0, topN);
    }

    function renderIndustryAction(data) {
      const root = document.getElementById('industry-wrap');
      root.innerHTML = '';
      const sellers = (data.sellers || []).filter((s) => s !== 'All (unique deals)');
      const deals = Array.isArray(data.all_deals_rows) ? data.all_deals_rows : [];

      const cutoffMonth = industryIntroCutoffMonthState || null;
      const tok = (v) => {
        const s = String(v || '').trim();
        return s ? s : '(blank)';
      };
      const passIntroCutoff = (introDate) => {
        if (!cutoffMonth) return true;
        const m = String(introDate || '').slice(0, 7);
        return !m || m >= cutoffMonth;
      };
      const stageN = (s) => stageNumber(String(s || ''));
      const isStage1to6 = (s) => {
        const n = stageN(s);
        return n != null && n >= 1 && n <= 6;
      };

      function computeForSeller(seller) {
        const acc = { total: 0, industries: {} };
        deals.forEach((r) => {
          const matched = Array.isArray(r.matched_sellers) ? r.matched_sellers : [];
          if (!matched.includes(seller)) return;
          if (!passIntroCutoff(r.intro_date)) return;
          if (!isStage1to6(r.stage)) return;
          const industry = tok(r.industry);
          const logo = tok(r.logo);
          const fn = tok(r.function);
          acc.total += 1;
          if (!acc.industries[industry]) acc.industries[industry] = { total: 0, logos: {}, functions: {} };
          const bucket = acc.industries[industry];
          bucket.total += 1;
          bucket.logos[logo] = (bucket.logos[logo] || 0) + 1;
          bucket.functions[fn] = (bucket.functions[fn] || 0) + 1;
        });
        const industries = Object.entries(acc.industries)
          .map(([industry, p]) => ({ industry, total: p.total, logos: p.logos, functions: p.functions }))
          .sort((a, b) => (b.total - a.total) || String(a.industry).localeCompare(String(b.industry)));
        return { total: acc.total, industries };
      }

      sellers.forEach((seller) => {
        const payload = computeForSeller(seller);
        const card = document.createElement('div');
        card.className = 'industry-card';

        const head = document.createElement('div');
        head.className = 'industry-head';
        const nm = document.createElement('div');
        nm.className = 'industry-name';
        nm.textContent = seller;
        const meta = document.createElement('div');
        meta.className = 'detail-meta';
        meta.textContent = `${money.format(payload.total || 0)} deals`;
        head.appendChild(nm);
        head.appendChild(meta);
        card.appendChild(head);

        const table = document.createElement('table');
        table.className = 'industry-table';
        const thead = document.createElement('thead');
        const hr = document.createElement('tr');
        hr.appendChild(makeCell('th', 'Industry'));
        hr.appendChild(makeCell('th', 'Deals'));
        hr.appendChild(makeCell('th', 'Top Logos'));
        hr.appendChild(makeCell('th', 'Top Business Functions'));
        thead.appendChild(hr);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        const industries = payload.industries || [];
        if (!industries.length) {
          const tr = document.createElement('tr');
          tr.appendChild(makeCell('td', 'No data'));
          tr.appendChild(makeCell('td', '0'));
          tr.appendChild(makeCell('td', '-'));
          tr.appendChild(makeCell('td', '-'));
          tbody.appendChild(tr);
        } else {
          industries.forEach((row) => {
            const tr = document.createElement('tr');
            tr.appendChild(makeCell('td', row.industry || '(blank)'));
            tr.appendChild(makeCell('td', money.format(row.total || 0)));

            const logosTd = document.createElement('td');
            const logosWrap = document.createElement('div');
            logosWrap.className = 'pill-list';
            topPills(row.logos, 4).forEach(([k, v]) => {
              const span = document.createElement('span');
              span.className = 'pill';
              span.textContent = `${k}: ${v}`;
              logosWrap.appendChild(span);
            });
            logosTd.appendChild(logosWrap);
            tr.appendChild(logosTd);

            const fnTd = document.createElement('td');
            const fnWrap = document.createElement('div');
            fnWrap.className = 'pill-list';
            const fnEntries = topPills(row.functions, 4);
            if (!fnEntries.length) {
              const span = document.createElement('span');
              span.className = 'pill';
              span.textContent = '-';
              fnWrap.appendChild(span);
            } else {
              fnEntries.forEach(([k, v]) => {
                const span = document.createElement('span');
                span.className = 'pill';
                span.textContent = `${k}: ${v}`;
                fnWrap.appendChild(span);
              });
            }
            fnTd.appendChild(fnWrap);
            tr.appendChild(fnTd);

            tbody.appendChild(tr);
          });
        }
        table.appendChild(tbody);
        card.appendChild(table);
        root.appendChild(card);
      });
      const topBySeller = sellers.map((seller) => {
        const payload = computeForSeller(seller);
        const top = (payload.industries || [])[0];
        return { seller, total: payload.total || 0, top };
      }).filter((x) => x.top);
      const lines = [];
      if (topBySeller.length) {
        lines.push(`Top industry by seller: ${topBySeller.map((x) => `${x.seller} -> ${x.top.industry} (${x.top.total})`).join(' | ')}.`);
      }
      const mostActiveSeller = [...topBySeller].sort((a, b) => b.total - a.total)[0];
      if (mostActiveSeller) {
        lines.push(`Highest overall industry activity: ${mostActiveSeller.seller} (${money.format(mostActiveSeller.total)} deals).`);
      }
      setInsight('insight-industry', lines);
    }

    function renderWinLoss(data, scope) {
      const deals = Array.isArray(data.all_deals_rows) ? data.all_deals_rows : [];
      const cutoffMonth = wlIntroCutoffMonthState || null;
      const tok = (v) => {
        const s = String(v || '').trim();
        return s ? s : '(blank)';
      };
      const passIntroCutoff = (introDate) => {
        if (!cutoffMonth) return true;
        const m = String(introDate || '').slice(0, 7);
        return !m || m >= cutoffMonth;
      };
      const stageNorm = (s) => String(s || '').trim().toLowerCase();
      const isWon = (s) => {
        const x = stageNorm(s);
        return x === '7. win' || x === 'won' || x === 'win';
      };
      const isLost = (s) => {
        const x = stageNorm(s);
        return x === '8. loss' || x === 'lost' || x === 'loss';
      };
      const matchesScope = (r) => {
        if (scope === 'Overall (unique)') return true;
        const matched = Array.isArray(r.matched_sellers) ? r.matched_sellers : [];
        return matched.includes(scope);
      };

      const combos = {};
      let won_total = 0;
      let lost_total = 0;
      deals.forEach((r) => {
        if (!matchesScope(r)) return;
        if (!passIntroCutoff(r.intro_date)) return;
        const st = r.stage;
        const won = isWon(st);
        const lost = isLost(st);
        if (!won && !lost) return;
        const industry = tok(r.industry);
        const logo = tok(r.logo);
        const fn = tok(r.function);
        const key = `${industry}||${logo}||${fn}`;
        if (!combos[key]) combos[key] = { won: 0, lost: 0 };
        if (won) { combos[key].won += 1; won_total += 1; }
        if (lost) { combos[key].lost += 1; lost_total += 1; }
      });
      const rowsAll = Object.entries(combos).map(([k, v]) => {
        const [industry, logo, fn] = String(k).split('||');
        const total = Number(v.won || 0) + Number(v.lost || 0);
        return {
          industry,
          logo,
          function: fn,
          won: Number(v.won || 0),
          lost: Number(v.lost || 0),
          total,
          win_rate: total ? (Number(v.won || 0) / total) : 0,
          loss_rate: total ? (Number(v.lost || 0) / total) : 0,
        };
      }).sort((a, b) => (b.total - a.total) || (b.lost - a.lost) || String(a.industry).localeCompare(String(b.industry)));
      const total = won_total + lost_total;
      const payload = {
        rows: rowsAll,
        won_total,
        lost_total,
        total,
        overall_win_rate: total ? (won_total / total) : 0,
      };

      const stats = document.getElementById('wl-stats');
      stats.innerHTML = '';
      stats.appendChild(makeCell('div', `Won: ${money.format(payload.won_total || 0)}`, 'chip'));
      stats.appendChild(makeCell('div', `Lost: ${money.format(payload.lost_total || 0)}`, 'chip'));
      stats.appendChild(makeCell('div', `Total: ${money.format(payload.total || 0)}`, 'chip'));
      stats.appendChild(makeCell('div', `Win Rate: ${(Number(payload.overall_win_rate || 0) * 100).toFixed(1)}%`, 'chip'));

      const body = document.getElementById('wl-body');
      body.innerHTML = '';
      const rows = (payload.rows || []).slice(0, 50);
      if (!rows.length) {
        const tr = document.createElement('tr');
        tr.appendChild(makeCell('td', 'No won/lost deals in current scope'));
        tr.appendChild(makeCell('td', '-'));
        tr.appendChild(makeCell('td', '-'));
        tr.appendChild(makeCell('td', '0'));
        tr.appendChild(makeCell('td', '0'));
        tr.appendChild(makeCell('td', '0'));
        tr.appendChild(makeCell('td', '-'));
        tr.appendChild(makeCell('td', '-'));
        body.appendChild(tr);
        return;
      }

      rows.forEach((r) => {
        const tr = document.createElement('tr');
        tr.appendChild(makeCell('td', r.industry || '(blank)'));
        tr.appendChild(makeCell('td', r.logo || '(blank)'));
        tr.appendChild(makeCell('td', r.function || '(blank)'));
        tr.appendChild(makeCell('td', money.format(r.won || 0)));
        tr.appendChild(makeCell('td', money.format(r.lost || 0)));
        tr.appendChild(makeCell('td', money.format(r.total || 0)));
        tr.appendChild(makeCell('td', `${(Number(r.win_rate || 0) * 100).toFixed(1)}%`));
        const focusTd = document.createElement('td');
        const highVolume = (r.total || 0) >= 3;
        const highLoss = (r.loss_rate || 0) >= 0.6;
        const highWin = (r.win_rate || 0) >= 0.6;
        if (highVolume && highLoss) {
          const b = document.createElement('span');
          b.className = 'focus-badge';
          b.textContent = 'Fix';
          focusTd.appendChild(b);
        } else if (highVolume && highWin) {
          const b = document.createElement('span');
          b.className = 'watch-badge';
          b.textContent = 'Scale';
          focusTd.appendChild(b);
        } else {
          focusTd.textContent = '-';
        }
        tr.appendChild(focusTd);
        body.appendChild(tr);
      });
      const topSource = rows[0];
      const topLoss = [...rows].sort((a, b) => (b.lost || 0) - (a.lost || 0))[0];
      const topWin = [...rows].sort((a, b) => (b.won || 0) - (a.won || 0))[0];
      const lines = [];
      lines.push(`${scope}: ${money.format(payload.total || 0)} won/lost outcomes in current filter window (Win rate ${(Number(payload.overall_win_rate || 0) * 100).toFixed(1)}%).`);
      if (topSource) lines.push(`Largest source combo: ${topSource.industry} / ${topSource.logo} / ${topSource.function} (${topSource.total} outcomes).`);
      if (topLoss) lines.push(`Highest-loss source: ${topLoss.industry} / ${topLoss.logo} / ${topLoss.function} (${topLoss.lost} lost).`);
      if (topWin) lines.push(`Highest-win source: ${topWin.industry} / ${topWin.logo} / ${topWin.function} (${topWin.won} won).`);
      setInsight('insight-winloss', lines);
    }

    function computeIntroMonthsFromDeals(deals) {
      const set = new Set();
      (deals || []).forEach((r) => {
        const m = String(r.intro_date || '').slice(0, 7);
        if (m && /^\d{4}-\d{2}$/.test(m)) set.add(m);
      });
      return Array.from(set).sort();
    }

    function initMonthSlider(sliderEl, valueEl, months, cutoffStateGetter, cutoffStateSetter, onChange) {
      if (!sliderEl || !valueEl) return;
      const ms = months || [];
      if (!ms.length) {
        sliderEl.min = '0';
        sliderEl.max = '0';
        sliderEl.value = '0';
        valueEl.textContent = '-';
        return;
      }
      sliderEl.min = '0';
      sliderEl.max = String(ms.length - 1);

      const desired = cutoffStateGetter();
      let idx = desired ? ms.indexOf(desired) : -1;
      if (idx < 0) {
        // Default to 2024-10 if present, else earliest month available.
        idx = Math.max(0, ms.indexOf('2024-10'));
      }
      sliderEl.value = String(idx);
      cutoffStateSetter(ms[idx] || null);
      valueEl.textContent = ms[idx] || '-';

      sliderEl.addEventListener('input', () => {
        const i = Math.max(0, Math.min(ms.length - 1, Number(sliderEl.value || 0)));
        cutoffStateSetter(ms[i] || null);
        valueEl.textContent = ms[i] || '-';
        onChange();
      });
    }

    function buildIntroSeries(data, scope, granularity) {
      const intro = data.intro_trend || {};
      const weeks = intro.weeks || [];
      const seriesMap = intro.series || {};
      const series = seriesMap[scope] || {};
      if (granularity === 'month') {
        const monthAgg = {};
        weeks.forEach((w) => {
          const m = (w || '').slice(0, 7);
          monthAgg[m] = (monthAgg[m] || 0) + Number(series[w] || 0);
        });
        const labels = Object.keys(monthAgg).sort();
        const points = labels.map((m) => Number(monthAgg[m] || 0));
        return { labels, points, target: 16, targetLabel: 'Target 16 / month' };
      }
      return {
        labels: weeks,
        points: weeks.map((w) => Number(series[w] || 0)),
        target: 4,
        targetLabel: 'Target 4 / week (16 / month)',
      };
    }

    function buildIntroDetailSeries(data, scope, granularity) {
      const intro = data.intro_trend || {};
      const weeks = intro.weeks || [];
      const detailMap = (intro.details || {})[scope] || {};
      if (granularity === 'month') {
        const agg = {};
        weeks.forEach((w) => {
          const m = (w || '').slice(0, 7);
          if (!agg[m]) agg[m] = [];
          agg[m].push(...(detailMap[w] || []));
        });
        Object.keys(agg).forEach((k) => {
          const seen = new Set();
          agg[k] = agg[k].filter((r) => {
            const key = `${r.deal}|${r.intro_date}|${r.stage}|${r.seller}`;
            if (seen.has(key)) return false;
            seen.add(key);
            return true;
          });
        });
        return agg;
      }
      const out = {};
      weeks.forEach((w) => {
        out[w] = detailMap[w] || [];
      });
      return out;
    }

    function renderIntroDetailTable(title, records) {
      const t = document.getElementById('intro-detail-title');
      const m = document.getElementById('intro-detail-meta');
      const b = document.getElementById('intro-detail-body');
      t.textContent = title;
      m.textContent = `${money.format(records.length)} deal(s)`;
      b.innerHTML = '';
      if (!records.length) {
        const tr = document.createElement('tr');
        tr.appendChild(makeCell('td', 'No deals found'));
        tr.appendChild(makeCell('td', '-'));
        tr.appendChild(makeCell('td', '-'));
        tr.appendChild(makeCell('td', '-'));
        b.appendChild(tr);
        return;
      }
      const rows = [...records].sort((a, z) => {
        const da = (a.deal || '').toLowerCase();
        const dz = (z.deal || '').toLowerCase();
        if (da !== dz) return da.localeCompare(dz);
        return (a.intro_date || '').localeCompare(z.intro_date || '');
      });
      rows.forEach((r) => {
        const tr = document.createElement('tr');
        tr.appendChild(makeCell('td', r.deal || '-'));
        tr.appendChild(makeCell('td', r.intro_date || '-'));
        tr.appendChild(makeCell('td', r.stage || '-'));
        tr.appendChild(makeCell('td', r.seller || '-'));
        b.appendChild(tr);
      });
    }

    function renderIntroTrend(data, scope, granularity) {
      const { labels, points, target, targetLabel } = buildIntroSeries(data, scope, granularity);
      const detailSeries = buildIntroDetailSeries(data, scope, granularity);
      const total = points.reduce((a, b) => a + b, 0);
      const peak = points.length ? Math.max(...points) : 0;
      const peakIdx = points.indexOf(peak);
      const peakLabel = peakIdx >= 0 ? labels[peakIdx] : '-';
      const avg = points.length ? total / points.length : 0;

      const stats = document.getElementById('intro-stats');
      stats.innerHTML = '';
      stats.appendChild(makeCell('div', `${granularity === 'month' ? 'Months' : 'Weeks'}: ${money.format(labels.length)}`, 'chip'));
      stats.appendChild(makeCell('div', `Intro calls: ${money.format(total)}`, 'chip'));
      stats.appendChild(makeCell('div', `${granularity === 'month' ? 'Monthly' : 'Weekly'} avg: ${avg.toFixed(1)}`, 'chip'));
      stats.appendChild(makeCell('div', `Peak: ${money.format(peak)} (${peakLabel})`, 'chip'));

      const svg = document.getElementById('intro-chart');
      svg.innerHTML = '';
      const tooltip = document.getElementById('chart-tooltip');
      const W = 1000, H = 360, L = 68, R = 26, T = 18, B = 78;
      const pw = W - L - R;
      const ph = H - T - B;
      const roughMax = Math.max(peak, target, 1);
      const yStep = roughMax <= 10 ? 2 : roughMax <= 30 ? 5 : roughMax <= 60 ? 10 : Math.ceil((roughMax / 6) / 5) * 5;
      const yMax = Math.max(yStep, Math.ceil(roughMax / yStep) * yStep);
      const xStep = labels.length > 0 ? pw / labels.length : 0;
      const barW = Math.max(6, Math.min(34, xStep * 0.72));

      const plotBg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      plotBg.setAttribute('x', String(L));
      plotBg.setAttribute('y', String(T));
      plotBg.setAttribute('width', String(pw));
      plotBg.setAttribute('height', String(ph));
      plotBg.setAttribute('fill', '#fcfdff');
      plotBg.setAttribute('rx', '8');
      svg.appendChild(plotBg);

      const axisX = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      axisX.setAttribute('x1', String(L));
      axisX.setAttribute('y1', String(H - B));
      axisX.setAttribute('x2', String(W - R));
      axisX.setAttribute('y2', String(H - B));
      axisX.setAttribute('class', 'chart-axis');
      svg.appendChild(axisX);

      const axisY = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      axisY.setAttribute('x1', String(L));
      axisY.setAttribute('y1', String(T));
      axisY.setAttribute('x2', String(L));
      axisY.setAttribute('y2', String(H - B));
      axisY.setAttribute('class', 'chart-axis');
      svg.appendChild(axisY);

      // Y-axis ticks, labels, and horizontal gridlines
      const yTicks = [];
      for (let v = 0; v <= yMax; v += yStep) yTicks.push(v);
      yTicks.forEach((tv) => {
        const y = T + (ph * (1 - (tv / yMax)));
        const grid = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        grid.setAttribute('x1', String(L));
        grid.setAttribute('y1', String(y));
        grid.setAttribute('x2', String(W - R));
        grid.setAttribute('y2', String(y));
        grid.setAttribute('class', 'chart-grid');
        svg.appendChild(grid);

        const tick = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        tick.setAttribute('x1', String(L - 4));
        tick.setAttribute('y1', String(y));
        tick.setAttribute('x2', String(L));
        tick.setAttribute('y2', String(y));
        tick.setAttribute('class', 'chart-axis');
        svg.appendChild(tick);

        const lbl = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        lbl.setAttribute('x', String(L - 8));
        lbl.setAttribute('y', String(y + 4));
        lbl.setAttribute('text-anchor', 'end');
        lbl.setAttribute('class', 'chart-label');
        lbl.textContent = String(tv);
        svg.appendChild(lbl);
      });

      const targetY = T + (ph * (1 - (target / yMax)));
      const targetLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      targetLine.setAttribute('x1', String(L));
      targetLine.setAttribute('y1', String(targetY));
      targetLine.setAttribute('x2', String(W - R));
      targetLine.setAttribute('y2', String(targetY));
      targetLine.setAttribute('class', 'chart-target');
      svg.appendChild(targetLine);

      const targetTxt = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      targetTxt.setAttribute('x', String(W - R - 4));
      targetTxt.setAttribute('y', String(Math.max(T + 10, targetY - 4)));
      targetTxt.setAttribute('text-anchor', 'end');
      targetTxt.setAttribute('class', 'chart-target-label');
      targetTxt.textContent = targetLabel;
      svg.appendChild(targetTxt);

      if (labels.length) {
        points.forEach((v, i) => {
          const x = L + (i * xStep) + ((xStep - barW) / 2);
          const h = ph * (v / yMax);
          const y = T + (ph - h);
          const bar = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
          bar.setAttribute('x', String(x));
          bar.setAttribute('y', String(y));
          bar.setAttribute('width', String(barW));
          bar.setAttribute('height', String(Math.max(1, h)));
          bar.setAttribute('rx', '2');
          const now = new Date();
          const weekStart = new Date(now);
          weekStart.setDate(now.getDate() - ((now.getDay() + 6) % 7));
          const yPart = weekStart.getFullYear();
          const mPart = String(weekStart.getMonth() + 1).padStart(2, '0');
          const dPart = String(weekStart.getDate()).padStart(2, '0');
          const currentWeekLabel = `${yPart}-${mPart}-${dPart}`;
          const currentMonthLabel = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
          const isCurrent = (granularity === 'week' && labels[i] === currentWeekLabel) || (granularity === 'month' && labels[i] === currentMonthLabel);
          bar.setAttribute('class', isCurrent ? 'chart-bar chart-bar-current' : 'chart-bar');
          bar.addEventListener('mouseenter', (evt) => {
            tooltip.style.display = 'block';
            tooltip.innerHTML = `<strong>${labels[i]}</strong><br/>Intro calls: ${money.format(v)}`;
            const mx = evt.clientX + 12;
            const my = evt.clientY - 10;
            tooltip.style.left = `${mx}px`;
            tooltip.style.top = `${my}px`;
          });
          bar.addEventListener('mousemove', (evt) => {
            tooltip.style.left = `${evt.clientX + 12}px`;
            tooltip.style.top = `${evt.clientY - 10}px`;
          });
          bar.addEventListener('mouseleave', () => {
            tooltip.style.display = 'none';
          });
          bar.addEventListener('click', () => {
            const recs = detailSeries[labels[i]] || [];
            renderIntroDetailTable(`${scope} | ${granularity === 'month' ? 'Month' : 'Week'} ${labels[i]}`, recs);
          });
          svg.appendChild(bar);

          const showValues = labels.length <= 24 || granularity === 'month';
          if (showValues && v > 0) {
            const vLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            vLabel.setAttribute('x', String(x + (barW / 2)));
            vLabel.setAttribute('y', String(Math.max(T + 10, y - 5)));
            vLabel.setAttribute('text-anchor', 'middle');
            vLabel.setAttribute('class', 'chart-value-label');
            vLabel.textContent = String(v);
            svg.appendChild(vLabel);
          }
        });

        const maxXTicks = granularity === 'month' ? 10 : 12;
        const tickEvery = Math.max(1, Math.ceil(labels.length / maxXTicks));
        const tickIdxs = [];
        for (let i = 0; i < labels.length; i += tickEvery) tickIdxs.push(i);
        if (tickIdxs[tickIdxs.length - 1] !== labels.length - 1) tickIdxs.push(labels.length - 1);
        const rotate = labels.length > maxXTicks || xStep < 42;
        const labelFormatter = (raw) => {
          if (granularity === 'month') {
            const d = new Date(`${raw}-01T00:00:00`);
            return Number.isNaN(d.getTime()) ? raw : d.toLocaleDateString(undefined, { month: 'short', year: '2-digit' });
          }
          const d = new Date(`${raw}T00:00:00`);
          return Number.isNaN(d.getTime()) ? raw : d.toLocaleDateString(undefined, { month: 'numeric', day: 'numeric' });
        };
        tickIdxs.forEach((i) => {
          if (i < 0 || i >= labels.length) return;
          const x = L + (i * xStep) + (xStep / 2);
          const txt = document.createElementNS('http://www.w3.org/2000/svg', 'text');
          txt.setAttribute('x', String(x));
          txt.setAttribute('y', String(H - (rotate ? 22 : 16)));
          txt.setAttribute('text-anchor', rotate ? 'end' : 'middle');
          if (rotate) txt.setAttribute('transform', `rotate(-28 ${x} ${H - 22})`);
          txt.setAttribute('class', 'chart-label');
          txt.textContent = labelFormatter(labels[i]);
          svg.appendChild(txt);
        });
      }

      // Axis titles
      const xTitle = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      xTitle.setAttribute('x', String(L + (pw / 2)));
      xTitle.setAttribute('y', String(H - 6));
      xTitle.setAttribute('text-anchor', 'middle');
      xTitle.setAttribute('class', 'chart-label');
      xTitle.textContent = granularity === 'month' ? 'Month' : 'Week';
      svg.appendChild(xTitle);

      const yTitle = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      yTitle.setAttribute('x', '12');
      yTitle.setAttribute('y', String(T + (ph / 2)));
      yTitle.setAttribute('text-anchor', 'middle');
      yTitle.setAttribute('transform', `rotate(-90 12 ${T + (ph / 2)})`);
      yTitle.setAttribute('class', 'chart-label');
      yTitle.textContent = 'Intro Calls';
      svg.appendChild(yTitle);

      const lines = [
        `${scope}: ${money.format(total)} intro calls across ${money.format(labels.length)} ${granularity}(s).`,
        `Peak ${granularity}: ${peakLabel} with ${money.format(peak)} intro call(s).`,
        `Average ${granularity} intro calls: ${avg.toFixed(1)} (target ${target} per ${granularity}).`,
        `Intro trend window: Intro Date >= 2024-10-01.`
      ];
      setInsight('insight-introtrend', lines);
      renderIntroDetailTable('Intro Deals', []);
    }

    function forecastNumberText(value, withDollar = false) {
      const n = Number(value || 0);
      if (Math.abs(n) < 0.5) return '-';
      if (withDollar) return `$ ${money.format(Math.round(n))}`;
      return money.format(Math.round(n));
    }

    function forecastTargetForScope(scope, quarterLabel) {
      const qKey = FORECAST_QUARTER_KEY_MAP[quarterLabel];
      if (!qKey) return 0;
      const target = getQuarterTarget(scope, qKey);
      if (Number(target.revenue || 0) > 0) return Number(target.revenue || 0);
      if (scope === 'Overall') return Number(FORECAST_DEFAULT_OVERALL_TARGETS[quarterLabel] || 0);
      return 0;
    }

    function renderForecastDealDetails(title, rows) {
      const titleEl = document.getElementById('forecast-detail-title');
      const metaEl = document.getElementById('forecast-detail-meta');
      const body = document.getElementById('forecast-detail-body');
      if (!titleEl || !metaEl || !body) return;
      titleEl.textContent = title;
      const aggregatedMap = {};
      (rows || []).forEach((r) => {
        const dealNorm = String(r.deal || '')
          .toLowerCase()
          .replace(/\s+/g, ' ')
          .replace(/[^\w\s]/g, '')
          .trim();
        const key = [
          dealNorm,
          String(r.stage || '').trim().toLowerCase(),
          String(r.startDate || '').trim().slice(0, 10),
        ].join('||');
        if (!aggregatedMap[key]) {
          aggregatedMap[key] = { ...r, quarterContribution: Number(r.quarterContribution || 0) };
        } else {
          aggregatedMap[key].quarterContribution += Number(r.quarterContribution || 0);
        }
      });
      const aggregatedRows = Object.values(aggregatedMap);
      metaEl.textContent = `${money.format(aggregatedRows.length)} contributing deal(s)`;
      body.innerHTML = '';
      if (!aggregatedRows.length) {
        const tr = document.createElement('tr');
        tr.appendChild(makeCell('td', 'No contributing deals'));
        tr.appendChild(makeCell('td', '-'));
        tr.appendChild(makeCell('td', '-'));
        tr.appendChild(makeCell('td', '-'));
        tr.appendChild(makeCell('td', '-'));
        tr.appendChild(makeCell('td', '-'));
        tr.appendChild(makeCell('td', '-'));
        body.appendChild(tr);
        return;
      }
      const sorted = [...aggregatedRows].sort((a, b) => Number(b.quarterContribution || 0) - Number(a.quarterContribution || 0) || String(a.deal || '').localeCompare(String(b.deal || '')));
      sorted.forEach((r) => {
        const tr = document.createElement('tr');
        tr.appendChild(makeCell('td', r.deal || '-'));
        tr.appendChild(makeCell('td', r.stage || '-'));
        tr.appendChild(makeCell('td', r.startDate || '-'));
        tr.appendChild(makeCell('td', r.durationMonths == null ? '-' : String(r.durationMonths)));
        tr.appendChild(makeCell('td', fmtDealSize(r.dealSize)));
        tr.appendChild(makeCell('td', fmtDealSize(r.quarterContribution)));
        tr.appendChild(makeCell('td', r.basis || '-'));
        body.appendChild(tr);
      });
    }

    function renderForecast(data, scope) {
      const head = document.getElementById('forecast-head-row');
      const body = document.getElementById('forecast-body');
      if (!head || !body) return;

      head.innerHTML = '';
      body.innerHTML = '';
      head.appendChild(makeCell('th', 'Stage'));
      FORECAST_QUARTERS.forEach((q) => head.appendChild(makeCell('th', q)));

      const sellerKey = scope === 'Overall' ? 'All (unique deals)' : scope;
      const metric = (((data.scorecard || {}).sellers || {})[sellerKey] || {});
      const stageRows = ((metric.kpi_details || {}).stage_1_6 || []);
      const wonRows = ((metric.kpi_details || {}).stage_7_8 || []).filter((r) => {
        const s = String(r.stage || '').trim().toLowerCase();
        return s === '7. win' || s === 'won';
      });
      const detailMap = {};

      const stageQuarterValues = {};
      const quarterTotals = {};
      FORECAST_QUARTERS.forEach((q) => { quarterTotals[q] = 0; });

      FORECAST_STAGE_CONFIG.forEach((cfg) => {
        const perQuarter = {};
        FORECAST_QUARTERS.forEach((q) => { perQuarter[q] = 0; });
        const isDetailStage = cfg.label === 'Proposal' || cfg.label === 'Contracting';
        const useDurationSplit = cfg.label === 'Proposal' || cfg.label === 'Contracting';
        const stageDeals = stageRows
          .filter((r) => String(r.stage || '') === cfg.stage)
          .map((r) => {
            const stageNum = stageNumber(r.stage);
            const baseAmount = (stageNum != null && stageNum <= 4) ? 100000 : dealSizeValue(r.deal_size);
            const dealEv = baseAmount * cfg.winProb;
            return {
              deal: r.deal || '-',
              stage: cfg.label,
              startDate: r.start_date || null,
              durationMonths: r.duration_months == null ? null : Number(r.duration_months || 0),
              dealSize: baseAmount,
              dealEv,
            };
          });
        FORECAST_QUARTERS.forEach((q) => { detailMap[`${cfg.label}||${q}`] = []; });
        stageDeals.forEach((d) => {
          const isQ1PlusExcludedDeal = isExcludedFromQ1PlusByDealName(d.deal);
          // For Proposal/Contracting: allocate by Start Date + Duration (months) if Start Date exists.
          // This prevents over-counting early quarters (a known issue with phase renormalization).
          const weights = (useDurationSplit && d.startDate)
            ? buildDurationQuarterWeights(d.startDate, d.durationMonths)
            : buildShiftedPhaseWeights(cfg.phase || {}, null);
          FORECAST_QUARTERS.forEach((q) => {
            const w = Number(weights[q] || 0);
            const blockedByQ1Rule = isQ1PlusExcludedDeal && isQ1OrLaterForecastQuarter(q);
            const contrib = blockedByQ1Rule ? 0 : (d.dealEv * w);
            perQuarter[q] += contrib;
            if (isDetailStage && contrib > 0) {
              detailMap[`${cfg.label}||${q}`].push({
                deal: d.deal,
                stage: cfg.label,
                startDate: d.startDate,
                durationMonths: d.durationMonths,
                dealSize: d.dealSize,
                quarterContribution: contrib,
                basis: (useDurationSplit && d.startDate)
                  ? `EV (${Math.round(cfg.winProb * 100)}%) x duration split`
                  : `EV (${Math.round(cfg.winProb * 100)}%) x phase`,
              });
            }
          });
        });
        FORECAST_QUARTERS.forEach((q) => {
          quarterTotals[q] += perQuarter[q];
        });
        stageQuarterValues[cfg.label] = perQuarter;

        const tr = document.createElement('tr');
        tr.appendChild(makeCell('td', cfg.label));
        FORECAST_QUARTERS.forEach((q) => {
          const td = makeCell('td', forecastNumberText(perQuarter[q], false));
          if (isDetailStage) {
            td.classList.add('forecast-clickable');
            td.addEventListener('click', () => {
              renderForecastDealDetails(`${scope} | ${cfg.label} | ${q}`, detailMap[`${cfg.label}||${q}`] || []);
            });
          }
          tr.appendChild(td);
        });
        body.appendChild(tr);
      });

      const wonQuarterTotals = {};
      FORECAST_QUARTERS.forEach((q) => { wonQuarterTotals[q] = 0; });
      let wonUnphased = 0;
      wonRows.forEach((r) => {
        const amount = Math.max(0, Number(r.deal_size || 0));
        if (!amount) return;
        const isQ1PlusExcludedDeal = isExcludedFromQ1PlusByDealName(r.deal);
        const start = r.start_date ? parseDateOrNow(r.start_date) : null;
        if (!start || Number.isNaN(start.getTime())) {
          wonUnphased += amount;
          return;
        }
        const durationRaw = Number(r.duration_months || 0);
        const durationMonths = Number.isFinite(durationRaw) && durationRaw > 0 ? Math.round(durationRaw) : 1;
        const monthlyAmount = amount / durationMonths;
        let phasedAny = false;
        for (let i = 0; i < durationMonths; i += 1) {
          const monthDate = addMonthsSafe(start, i);
          const fq = forecastQuarterFromDate(monthDate);
          if (fq && Object.prototype.hasOwnProperty.call(wonQuarterTotals, fq)) {
            if (isQ1PlusExcludedDeal && isQ1OrLaterForecastQuarter(fq)) {
              // Intentionally excluded from Q1 onward for selected client names.
              phasedAny = true;
              continue;
            }
            wonQuarterTotals[fq] += monthlyAmount;
            const key = `Won (Start Date)||${fq}`;
            if (!detailMap[key]) detailMap[key] = [];
            detailMap[key].push({
              deal: r.deal || '-',
              stage: 'Won',
              startDate: r.start_date || null,
              durationMonths,
              dealSize: amount,
              quarterContribution: monthlyAmount,
              basis: 'Deal size / duration months',
            });
            phasedAny = true;
          }
        }
        if (!phasedAny) {
          wonUnphased += amount;
        }
      });
      const wonRow = document.createElement('tr');
      wonRow.appendChild(makeCell('td', 'Won (Start Date)'));
      FORECAST_QUARTERS.forEach((q) => {
        const v = wonQuarterTotals[q] || 0;
        quarterTotals[q] += v;
        const td = makeCell('td', forecastNumberText(v, false));
        td.classList.add('forecast-clickable');
        td.addEventListener('click', () => {
          renderForecastDealDetails(`${scope} | Won (Start Date) | ${q}`, detailMap[`Won (Start Date)||${q}`] || []);
        });
        wonRow.appendChild(td);
      });
      body.appendChild(wonRow);

      const riskRow = document.createElement('tr');
      riskRow.className = 'risk-row';
      riskRow.appendChild(makeCell('td', 'RISK-ADJ EV'));
      FORECAST_QUARTERS.forEach((q) => riskRow.appendChild(makeCell('td', forecastNumberText(quarterTotals[q], true))));
      body.appendChild(riskRow);

      const targets = {};
      const targetRow = document.createElement('tr');
      targetRow.className = 'target-row';
      targetRow.appendChild(makeCell('td', 'TARGET'));
      FORECAST_QUARTERS.forEach((q) => {
        const t = forecastTargetForScope(scope, q);
        targets[q] = t;
        targetRow.appendChild(makeCell('td', forecastNumberText(t, true)));
      });
      body.appendChild(targetRow);

      const gapRow = document.createElement('tr');
      gapRow.className = 'gap-row';
      gapRow.appendChild(makeCell('td', 'GAP'));
      FORECAST_QUARTERS.forEach((q) => {
        const gap = Number(targets[q] || 0) - Number(quarterTotals[q] || 0);
        const td = makeCell('td', forecastNumberText(gap, true));
        if (Math.abs(gap) < 0.5 || Number(targets[q] || 0) <= 0) {
          td.textContent = '-';
        } else if (gap > 0) {
          td.classList.add('gap-pos');
        } else {
          td.classList.add('gap-neg');
        }
        gapRow.appendChild(td);
      });
      body.appendChild(gapRow);

      const strongestQuarter = [...FORECAST_QUARTERS].sort((a, b) => Number(quarterTotals[b] || 0) - Number(quarterTotals[a] || 0))[0];
      const widestGapQuarter = [...FORECAST_QUARTERS]
        .map((q) => ({ q, gap: Number(targets[q] || 0) - Number(quarterTotals[q] || 0) }))
        .sort((a, b) => b.gap - a.gap)[0];
      const lines = [
        `${scope}: total risk-adjusted EV across shown quarters = ${forecastNumberText(FORECAST_QUARTERS.reduce((acc, q) => acc + Number(quarterTotals[q] || 0), 0), true)}.`,
      ];
      const wonTotalPhased = FORECAST_QUARTERS.reduce((acc, q) => acc + Number(wonQuarterTotals[q] || 0), 0);
      if (wonTotalPhased > 0 || wonUnphased > 0) {
        lines.push(`Won contribution (100% value): ${forecastNumberText(wonTotalPhased, true)} phased by Start Date${wonUnphased > 0 ? `; ${forecastNumberText(wonUnphased, true)} not phased (missing/out-of-range start date).` : '.'}`);
      }
      if (strongestQuarter) {
        lines.push(`Highest EV quarter: ${strongestQuarter} (${forecastNumberText(quarterTotals[strongestQuarter], true)}).`);
      }
      if (widestGapQuarter && Number(targets[widestGapQuarter.q] || 0) > 0) {
        lines.push(`Largest target gap: ${widestGapQuarter.q} (${forecastNumberText(widestGapQuarter.gap, true)}).`);
      }
      setInsight('insight-forecast', lines);
      renderForecastDealDetails(`${scope} | Proposal | ${FORECAST_QUARTERS[0]}`, detailMap[`Proposal||${FORECAST_QUARTERS[0]}`] || []);
    }

    function normalizeChannelUi(sourceOfLead, revenueSource, existingChannel) {
      const pre = String(existingChannel || '').trim();
      if (pre) return pre;
      const raw = `${String(sourceOfLead || '').trim()} | ${String(revenueSource || '').trim()}`.toLowerCase();
      if (!raw.replace(/\|/g, '').trim()) return '(blank)';
      if (raw.includes('refer')) return 'Reference';
      if (raw.includes('partner') || raw.includes('alliance')) return 'Partner';
      if (raw.includes('inbound') || raw.includes('website') || raw.includes('conference') || raw.includes('event') || raw.includes('webinar') || raw.includes('newsletter')) return 'Inbound/Marketing';
      if (raw.includes('existing') || raw.includes('upsell') || raw.includes('cross sell') || raw.includes('cross-sell') || raw.includes('renewal')) return 'Existing Account';
      if (raw.includes('outbound') || raw.includes('cold') || raw.includes('prospecting') || raw.includes('sdr') || raw.includes('bdr')) return 'Cold/Outbound';
      return 'Other';
    }

    function cycleSortCompare(a, b, key, dir) {
      const factor = dir === 'asc' ? 1 : -1;
      if (key === 'days' || key === 'months' || key === 'dealSize') {
        const av = Number(a[key] == null ? -Infinity : a[key]);
        const bv = Number(b[key] == null ? -Infinity : b[key]);
        if (av !== bv) return (av - bv) * factor;
      } else if (key === 'intro' || key === 'start') {
        const av = String(a[key] || '');
        const bv = String(b[key] || '');
        if (av !== bv) return av.localeCompare(bv) * factor;
      } else {
        const av = String(a[key] || '').toLowerCase();
        const bv = String(b[key] || '').toLowerCase();
        if (av !== bv) return av.localeCompare(bv) * factor;
      }
      return String(a.deal || '').localeCompare(String(b.deal || ''));
    }

    function cyclePassNumericFilter(value, exprRaw) {
      const expr = String(exprRaw || '').trim();
      if (!expr) return true;
      const m = expr.match(/^(<=|>=|=|<|>)\s*(-?\d+(\.\d+)?)$/);
      if (!m) return String(value == null ? '' : value).includes(expr);
      const op = m[1];
      const rhs = Number(m[2]);
      const lhs = Number(value);
      if (!Number.isFinite(lhs)) return false;
      if (op === '<') return lhs < rhs;
      if (op === '>') return lhs > rhs;
      if (op === '<=') return lhs <= rhs;
      if (op === '>=') return lhs >= rhs;
      return lhs === rhs;
    }

    function cyclePassesFilters(r) {
      const f = cycleTableState.filters || {};
      const txt = (v) => String(v == null ? '' : v).toLowerCase();
      if (cycleIntroCutoffMonthState) {
        const m = String(r.intro || '').match(/^(\d{4}-\d{2})/);
        const introMonth = m ? m[1] : null;
        if (introMonth && introMonth < cycleIntroCutoffMonthState) return false;
      }
      if (f.deal && !txt(r.deal).includes(String(f.deal).toLowerCase())) return false;
      if (f.stage && !txt(r.stage).includes(String(f.stage).toLowerCase())) return false;
      if (f.industry && !txt(r.industry).includes(String(f.industry).toLowerCase())) return false;
      if (f.seller && !txt(r.seller).includes(String(f.seller).toLowerCase())) return false;
      if (f.channel && !txt(r.channel).includes(String(f.channel).toLowerCase())) return false;
      if (f.intro && !txt(r.intro).includes(String(f.intro).toLowerCase())) return false;
      if (f.start && !txt(r.start).includes(String(f.start).toLowerCase())) return false;
      if (!cyclePassNumericFilter(r.dealSize, f.dealSize)) return false;
      if (!cyclePassNumericFilter(r.days, f.days)) return false;
      if (!cyclePassNumericFilter(r.months, f.months)) return false;
      return true;
    }

    function updateCycleSortHeaders() {
      document.querySelectorAll('[data-cycle-sort]').forEach((el) => {
        const key = el.getAttribute('data-cycle-sort');
        const active = key === cycleTableState.sortKey;
        el.classList.toggle('active', active);
        const arrow = active ? (cycleTableState.sortDir === 'asc' ? ' ' : ' ') : '';
        const base = el.textContent.replace(/\s[]$/, '');
        el.textContent = `${base}${arrow}`;
      });
    }

    function renderCycleDealsBody(rows) {
      const dealsBody = document.getElementById('cycle-deals-body');
      if (!dealsBody) return;
      dealsBody.innerHTML = '';
      if (!rows.length) {
        const tr = document.createElement('tr');
        tr.appendChild(makeCell('td', 'No rows match current cycle-time filters'));
        tr.appendChild(makeCell('td', '-'));
        tr.appendChild(makeCell('td', '-'));
        tr.appendChild(makeCell('td', '-'));
        tr.appendChild(makeCell('td', '-'));
        tr.appendChild(makeCell('td', '-'));
        tr.appendChild(makeCell('td', '-'));
        tr.appendChild(makeCell('td', '-'));
        tr.appendChild(makeCell('td', '-'));
        tr.appendChild(makeCell('td', '-'));
        dealsBody.appendChild(tr);
        return;
      }
      rows.forEach((r) => {
        const tr = document.createElement('tr');
        tr.appendChild(makeCell('td', r.deal));
        tr.appendChild(makeCell('td', r.stage));
        tr.appendChild(makeCell('td', r.industry));
        tr.appendChild(makeCell('td', r.seller));
        tr.appendChild(makeCell('td', r.channel));
        tr.appendChild(makeCell('td', fmtDealSize(r.dealSize)));
        tr.appendChild(makeCell('td', r.intro));
        tr.appendChild(makeCell('td', r.start));
        tr.appendChild(makeCell('td', r.days == null ? '-' : money.format(r.days)));
        tr.appendChild(makeCell('td', r.months == null ? '-' : r.months.toFixed(1)));
        dealsBody.appendChild(tr);
      });
    }

    function syncCycleCutoffControls(rows) {
      const slider = document.getElementById('cycle-time-slider');
      const valueEl = document.getElementById('cycle-time-value');
      if (!slider || !valueEl) return;
      const months = Array.from(new Set((rows || [])
        .map((r) => String(r.intro || ''))
        .map((v) => (v.match(/^(\d{4}-\d{2})/) || [])[1])
        .filter(Boolean)))
        .sort();
      cycleIntroMonthsState = months;
      if (!months.length) {
        slider.min = '0';
        slider.max = '0';
        slider.value = '0';
        cycleIntroCutoffMonthState = null;
        valueEl.textContent = '-';
        return;
      }
      if (!cycleIntroCutoffMonthState || !months.includes(cycleIntroCutoffMonthState)) {
        cycleIntroCutoffMonthState = months[0];
      }
      const idx = Math.max(0, months.indexOf(cycleIntroCutoffMonthState));
      slider.min = '0';
      slider.max = String(Math.max(0, months.length - 1));
      slider.value = String(idx);
      valueEl.textContent = cycleIntroCutoffMonthState;
    }

    function applyCycleTableView() {
      const filtered = cycleRowsState.filter(cyclePassesFilters);
      const sorted = filtered.slice().sort((a, b) => cycleSortCompare(a, b, cycleTableState.sortKey, cycleTableState.sortDir));
      renderCycleDealsBody(sorted);
      renderCycleSummaryTable('cycle-industry-body', summarizeCycle(sorted, (r) => r.industry));
      renderCycleSummaryTable('cycle-seller-body', summarizeCycle(sorted, (r) => r.seller));
      renderCycleSummaryTable('cycle-channel-body', summarizeCycle(sorted, (r) => r.channel));
      updateCycleSortHeaders();

      const validDurRows = sorted.filter((r) => Number.isFinite(r.days));
      const med = medianValue(validDurRows.map((r) => r.days));
      const avg = validDurRows.length ? validDurRows.reduce((a, b) => a + b.days, 0) / validDurRows.length : null;
      const fastest = validDurRows.length ? validDurRows[validDurRows.length - 1] : null;
      const slowest = validDurRows.length ? validDurRows[0] : null;
      const lines = [];
      lines.push(`${cycleScopeState}: ${money.format(sorted.length)} of ${money.format(cycleRowsState.length)} rows match current filters.`);
      lines.push(`Intro cutoff: ${cycleIntroCutoffMonthState || '-'} (rows with blank intro date remain included).`);
      lines.push(`Average days: ${avg == null ? '-' : avg.toFixed(1)} | Median days: ${med == null ? '-' : med.toFixed(1)} (computed on rows with both Intro and Start).`);
      if (slowest) lines.push(`Slowest: ${slowest.deal} (${money.format(slowest.days)} days, ${slowest.channel}).`);
      if (fastest) lines.push(`Fastest: ${fastest.deal} (${money.format(fastest.days)} days, ${fastest.channel}).`);
      setInsight('insight-cycletime', lines);
    }

    function initCycleTableControls() {
      document.querySelectorAll('[data-cycle-sort]').forEach((el) => {
        el.addEventListener('click', () => {
          const key = el.getAttribute('data-cycle-sort');
          if (!key) return;
          if (cycleTableState.sortKey === key) cycleTableState.sortDir = cycleTableState.sortDir === 'asc' ? 'desc' : 'asc';
          else {
            cycleTableState.sortKey = key;
            cycleTableState.sortDir = (key === 'days' || key === 'dealSize' || key === 'months') ? 'desc' : 'asc';
          }
          applyCycleTableView();
        });
      });
      document.querySelectorAll('[data-cycle-filter]').forEach((input) => {
        input.addEventListener('input', () => {
          const key = input.getAttribute('data-cycle-filter');
          if (!key) return;
          cycleTableState.filters[key] = input.value || '';
          applyCycleTableView();
        });
      });
      const slider = document.getElementById('cycle-time-slider');
      const valueEl = document.getElementById('cycle-time-value');
      if (slider && valueEl) {
        slider.addEventListener('input', () => {
          const idx = Number(slider.value || 0);
          cycleIntroCutoffMonthState = cycleIntroMonthsState[idx] || cycleIntroMonthsState[0] || null;
          valueEl.textContent = cycleIntroCutoffMonthState || '-';
          applyCycleTableView();
        });
      }
    }

    function parseCycleIntroDate(rec) {
      const introRaw = String(rec && rec.intro_date || '').trim();
      const introDirect = parseIsoLocalDate(introRaw);
      if (introDirect) return introDirect;
      const cm = String(rec && rec.created_month || '').trim();
      const m = cm.match(/^(\d{4})-(\d{2})$/);
      if (!m) return null;
      return new Date(Number(m[1]), Number(m[2]) - 1, 1, 12, 0, 0, 0);
    }

    function medianValue(values) {
      const arr = values.filter((x) => Number.isFinite(x)).slice().sort((a, b) => a - b);
      const n = arr.length;
      if (!n) return null;
      const mid = Math.floor(n / 2);
      if (n % 2 === 1) return arr[mid];
      return (arr[mid - 1] + arr[mid]) / 2;
    }

    function summarizeCycle(rows, keyGetter) {
      const map = new Map();
      rows.forEach((r) => {
        const key = keyGetter(r) || '(blank)';
        if (!map.has(key)) map.set(key, []);
        map.get(key).push(r.days);
      });
      return Array.from(map.entries()).map(([key, days]) => {
        const count = days.length;
        const valid = days.filter((x) => Number.isFinite(x));
        const avg = valid.length ? (valid.reduce((a, b) => a + b, 0) / valid.length) : null;
        const med = medianValue(valid);
        return { key, count, avg, median: med };
      }).sort((a, b) => b.count - a.count || (b.avg || 0) - (a.avg || 0) || a.key.localeCompare(b.key));
    }

    function renderCycleSummaryTable(tbodyId, rows) {
      const body = document.getElementById(tbodyId);
      if (!body) return;
      body.innerHTML = '';
      if (!rows.length) {
        const tr = document.createElement('tr');
        tr.appendChild(makeCell('td', 'No data'));
        tr.appendChild(makeCell('td', '0'));
        tr.appendChild(makeCell('td', '-'));
        tr.appendChild(makeCell('td', '-'));
        body.appendChild(tr);
        return;
      }
      rows.forEach((r) => {
        const tr = document.createElement('tr');
        tr.appendChild(makeCell('td', r.key));
        tr.appendChild(makeCell('td', money.format(r.count)));
        tr.appendChild(makeCell('td', r.avg == null ? '-' : r.avg.toFixed(1)));
        tr.appendChild(makeCell('td', r.median == null ? '-' : r.median.toFixed(1)));
        body.appendChild(tr);
      });
    }

    function renderCycleTime(data, scope) {
      const sellerBlocks = ((data.scorecard || {}).sellers || {});
      const hasCycleRows = Array.isArray(data.cycle_time_rows);
      let stageRows = [];
      if (hasCycleRows) {
        stageRows = data.cycle_time_rows.slice();
        if (scope !== 'Overall') {
          const target = String(scope || '').toLowerCase();
          stageRows = stageRows.filter((r) => {
            const ms = Array.isArray(r.matched_sellers) ? r.matched_sellers : [];
            if (ms.some((x) => String(x || '').toLowerCase() === target)) return true;
            return String(r.seller || '').toLowerCase().includes(target);
          });
        }
      } else if (scope === 'Overall') {
        Object.keys(sellerBlocks)
          .filter((k) => k !== 'All (unique deals)')
          .forEach((k) => {
            const m = sellerBlocks[k] || {};
            stageRows.push(...(((m.kpi_details || {}).stage_7_8 || [])));
          });
      } else {
        const metric = sellerBlocks[scope] || {};
        stageRows = ((metric.kpi_details || {}).stage_7_8 || []);
      }
      const rowMap = new Map();
      stageRows.forEach((r) => {
        const stage = String(r.stage || '').trim();
        const intro = parseCycleIntroDate(r);
        const start = parseIsoLocalDate(r.start_date);
        let days = null;
        let months = null;
        if (intro && start) {
          const d = Math.round((start.getTime() - intro.getTime()) / 86400000);
          if (Number.isFinite(d) && d >= 0) {
            days = d;
            months = Number((d / 30.44).toFixed(1));
          }
        }
        const deal = String(r.deal || '').trim() || '(blank)';
        const introKey = intro ? intro.toISOString().slice(0, 10) : (String(r.intro_date || '').trim() || '-');
        const startKey = start ? start.toISOString().slice(0, 10) : (String(r.start_date || '').trim() || '-');
        const key = `${deal}||${stage}||${introKey}||${startKey}`;
        const sellerLabel = String(r.seller || '').trim() || (scope === 'Overall' ? '(blank)' : scope);
        if (!rowMap.has(key)) {
          rowMap.set(key, {
            sellerSet: new Set([sellerLabel]),
            row: {
              deal,
              stage,
              industry: String(r.industry || '').trim() || '(blank)',
              channel: normalizeChannelUi(r.source_of_lead, r.revenue_source_mapping, r.channel),
              dealSize: r.deal_size,
              intro: intro ? intro.toISOString().slice(0, 10) : (String(r.intro_date || '').trim() || '-'),
              start: start ? start.toISOString().slice(0, 10) : (String(r.start_date || '').trim() || '-'),
              days,
              months,
            },
          });
        } else {
          rowMap.get(key).sellerSet.add(sellerLabel);
        }
      });
      const rows = Array.from(rowMap.values()).map(({ sellerSet, row }) => ({
        ...row,
        seller: Array.from(sellerSet).sort().join(', '),
      }));
      syncCycleCutoffControls(rows);
      cycleRowsState = rows;
      cycleScopeState = scope;
      applyCycleTableView();
    }

    async function boot() {
      try {
        const versionEl = document.getElementById('profile-version');
        if (versionEl) versionEl.textContent = APP_VERSION;
        const cached = loadSharedDatasetCache();
        let data = cached;
        if (!data) {
          const res = await fetch('./crosstab_data.json', { cache: 'no-store' });
          if (!res.ok) throw new Error(`Failed to load crosstab_data.json (HTTP ${res.status})`);
          data = await res.json();
        }

        const sellerSelect = document.getElementById('seller');
        const wlSellerSelect = document.getElementById('wl-seller');
        const introSellerSelect = document.getElementById('intro-seller');
        const introGranularity = document.getElementById('intro-granularity');
        const stageOptions = document.getElementById('stage-options');
        const funnelOptions = document.getElementById('funnel-options');
        const funnelTimeSlider = document.getElementById('funnel-time-slider');
        const funnelTimeValue = document.getElementById('funnel-time-value');
        const scorecardSellerSelect = document.getElementById('scorecard-seller');
        const loginForm = document.getElementById('auth-login-form');
        const setupForm = document.getElementById('auth-setup-form');
        const profile = document.getElementById('profile');
        const profileBtn = document.getElementById('profile-btn');
        const profilePop = document.getElementById('profile-pop');
        const profileLogout = document.getElementById('profile-logout');
        const profileAdmin = document.getElementById('profile-admin');
        const adminUserForm = document.getElementById('admin-user-form');
        const adminTargetForm = document.getElementById('admin-target-form');
        const adminSyncForm = document.getElementById('admin-sync-form');
        const versionSelect = document.getElementById('version-select');
        const compareLeft = document.getElementById('compare-left');
        const compareRight = document.getElementById('compare-right');
        const compareRun = document.getElementById('compare-run');
        const comparePrev = document.getElementById('compare-prev');
        const momentumLeft = document.getElementById('momentum-left');
        const momentumRight = document.getElementById('momentum-right');
        const momentumSeller = document.getElementById('momentum-seller');
        const momentumScope = document.getElementById('momentum-scope');
        const momentumRun = document.getElementById('momentum-run');
        const momentumPrev = document.getElementById('momentum-prev');
        const forecastSellerSelect = document.getElementById('forecast-seller');
        const cycleSellerSelect = document.getElementById('cycle-seller');
        const orderedStages = getOrderedStages(data.stages);
        const selectedStages = new Set(orderedStages);
        const orderedFunnelStages = getOrderedFunnelStages(data.stages || []);
        const selectedFunnelStages = new Set(orderedFunnelStages);
        const funnelMonths = [...(data.months || [])];
        let funnelMinMonth = funnelMonths[0] || null;
        likelihoodState = loadLikelihoodState();
        quarterTargetsState = loadQuarterTargetsState();
        dashboardSettingsState = loadDashboardSettingsState();
        currentAuthStore = loadAuthStore();
        ensureOverallForecastTargets({ persist: false });
        window.__salesData = data;
        initChatAssistant(data);
        renderMomentumSellerFilter(data);

        // Industry Action + Won/Lost tabs use their own intro cutoffs (client-side recompute).
        const allDealsForSliders = Array.isArray(data.all_deals_rows) ? data.all_deals_rows : [];
        industryIntroMonthsState = computeIntroMonthsFromDeals(allDealsForSliders);
        wlIntroMonthsState = computeIntroMonthsFromDeals(allDealsForSliders);
        initMonthSlider(
          document.getElementById('industry-time-slider'),
          document.getElementById('industry-time-value'),
          industryIntroMonthsState,
          () => industryIntroCutoffMonthState,
          (v) => { industryIntroCutoffMonthState = v; },
          () => renderIndustryAction(data),
        );
        initMonthSlider(
          document.getElementById('wl-time-slider'),
          document.getElementById('wl-time-value'),
          wlIntroMonthsState,
          () => wlIntroCutoffMonthState,
          (v) => { wlIntroCutoffMonthState = v; },
          () => renderWinLoss(data, (document.getElementById('wl-seller') || {}).value || 'Overall (unique)'),
        );

        function rerenderAllViews() {
          render(data, sellerSelect.value, selectedStages, orderedStages);
          renderFunnel(data, selectedFunnelStages, funnelMinMonth);
          renderScorecard(data);
          renderAdminTargets();
          renderIndustryAction(data);
          renderWinLoss(data, wlSellerSelect.value);
          renderIntroTrend(data, introSellerSelect.value, introGranularity.value);
          renderVersionSelectors();
          renderMomentumSellerFilter(data);
          renderForecast(data, (forecastSellerSelect && forecastSellerSelect.value) || 'Overall');
          renderCycleTime(data, (cycleSellerSelect && cycleSellerSelect.value) || 'Overall');
        }

        async function runCompare() {
          const leftId = compareLeft && compareLeft.value;
          const rightId = compareRight && compareRight.value;
          if (!leftId || !rightId) {
            setInsight('insight-compare', ['Select two versions to compare.']);
            return;
          }
          try {
            const payload = await fetchVersionCompare(leftId, rightId);
            renderCompareView(payload || {});
          } catch (e) {
            setInsight('insight-compare', [e.message || 'Failed to load comparison.']);
          }
        }

        async function runMomentumCompare() {
          const leftId = momentumLeft && momentumLeft.value;
          const rightId = momentumRight && momentumRight.value;
          if (!leftId || !rightId) {
            setInsight('insight-momentum', ['Select two versions to run momentum analysis.']);
            return;
          }
          try {
            const [payload, leftVer, rightVer] = await Promise.all([
              fetchVersionCompare(leftId, rightId),
              fetchVersionData(leftId),
              fetchVersionData(rightId),
            ]);
            const leftLookup = buildSellerLookupFromDataset(leftVer && leftVer.dataset);
            const rightLookup = buildSellerLookupFromDataset(rightVer && rightVer.dataset);
            renderMomentumView(payload || {}, data, leftLookup, rightLookup);
          } catch (e) {
            setInsight('insight-momentum', [e.message || 'Failed to load momentum analysis.']);
          }
        }

        function updateFromCheckboxes() {
          selectedStages.clear();
          stageOptions.querySelectorAll('input[type="checkbox"]').forEach((box) => {
            if (box.checked) selectedStages.add(box.value);
          });
          render(data, sellerSelect.value, selectedStages, orderedStages);
        }

        function setMatterOnly() {
          stageOptions.querySelectorAll('input[type="checkbox"]').forEach((box) => {
            box.checked = MATTER_STAGE_ORDER.includes(box.value);
          });
          updateFromCheckboxes();
        }

        function setAllStages() {
          stageOptions.querySelectorAll('input[type="checkbox"]').forEach((box) => {
            box.checked = true;
          });
          updateFromCheckboxes();
        }

        function updateFunnelFromCheckboxes() {
          selectedFunnelStages.clear();
          funnelOptions.querySelectorAll('input[type="checkbox"]').forEach((box) => {
            if (box.checked) selectedFunnelStages.add(box.value);
          });
          renderFunnel(data, selectedFunnelStages, funnelMinMonth);
        }

        function setFunnelCore() {
          funnelOptions.querySelectorAll('input[type="checkbox"]').forEach((box) => {
            box.checked = FUNNEL_CORE_SET.has(box.value);
          });
          updateFunnelFromCheckboxes();
        }

        function setFunnelAll() {
          funnelOptions.querySelectorAll('input[type="checkbox"]').forEach((box) => {
            box.checked = true;
          });
          updateFunnelFromCheckboxes();
        }

        function updateFunnelMonth() {
          const idx = Number(funnelTimeSlider.value || 0);
          funnelMinMonth = funnelMonths[idx] || funnelMonths[0] || null;
          funnelTimeValue.textContent = funnelMinMonth || '-';
          renderFunnel(data, selectedFunnelStages, funnelMinMonth);
        }

        orderedStages.forEach((stage) => {
          const label = document.createElement('label');
          label.className = 'stage-option';
          const input = document.createElement('input');
          input.type = 'checkbox';
          input.value = stage;
          input.checked = true;
          input.addEventListener('change', updateFromCheckboxes);
          label.appendChild(input);
          label.appendChild(document.createTextNode(stage));
          stageOptions.appendChild(label);
        });
        orderedFunnelStages.forEach((stage) => {
          const label = document.createElement('label');
          label.className = 'funnel-option';
          const input = document.createElement('input');
          input.type = 'checkbox';
          input.value = stage;
          input.checked = true;
          input.addEventListener('change', updateFunnelFromCheckboxes);
          label.appendChild(input);
          label.appendChild(document.createTextNode(stage));
          funnelOptions.appendChild(label);
        });
        funnelTimeSlider.min = '0';
        funnelTimeSlider.max = String(Math.max(0, funnelMonths.length - 1));
        funnelTimeSlider.value = '0';
        funnelTimeSlider.addEventListener('input', updateFunnelMonth);
        funnelTimeValue.textContent = funnelMinMonth || '-';

        document.getElementById('stage-matter').addEventListener('click', setMatterOnly);
        document.getElementById('stage-all').addEventListener('click', setAllStages);
        document.getElementById('funnel-core').addEventListener('click', setFunnelCore);
        document.getElementById('funnel-all').addEventListener('click', setFunnelAll);
        document.getElementById('kpi-popup-close').addEventListener('click', closeKpiPopup);
        document.getElementById('kpi-popup').addEventListener('click', (evt) => {
          if (evt.target.id === 'kpi-popup') closeKpiPopup();
        });
        document.addEventListener('keydown', (evt) => {
          if (evt.key === 'Escape') closeKpiPopup();
        });

        data.sellers.forEach(s => {
          const o = document.createElement('option');
          o.value = s;
          o.textContent = s;
          sellerSelect.appendChild(o);
        });
        ['Overall (unique)', ...data.sellers.filter(s => s !== 'All (unique deals)')].forEach((s) => {
          const o = document.createElement('option');
          o.value = s;
          o.textContent = s;
          wlSellerSelect.appendChild(o);
        });
        ['Overall (unique)', ...data.sellers.filter(s => s !== 'All (unique deals)')].forEach((s) => {
          const o = document.createElement('option');
          o.value = s;
          o.textContent = s;
          introSellerSelect.appendChild(o);
        });
        ['Overall', ...data.sellers.filter(s => s !== 'All (unique deals)')].forEach((s) => {
          const o = document.createElement('option');
          o.value = s;
          o.textContent = s;
          forecastSellerSelect.appendChild(o);
        });
        ['Overall', ...data.sellers.filter(s => s !== 'All (unique deals)')].forEach((s) => {
          const o = document.createElement('option');
          o.value = s;
          o.textContent = s;
          cycleSellerSelect.appendChild(o);
        });

        sellerSelect.value = 'All (unique deals)';
        sellerSelect.addEventListener('change', () => render(data, sellerSelect.value, selectedStages, orderedStages));
        wlSellerSelect.value = 'Overall (unique)';
        wlSellerSelect.addEventListener('change', () => renderWinLoss(data, wlSellerSelect.value));
        introSellerSelect.value = 'Overall (unique)';
        introGranularity.value = 'week';
        forecastSellerSelect.value = 'Overall';
        cycleSellerSelect.value = 'Overall';
        introSellerSelect.addEventListener('change', () => renderIntroTrend(data, introSellerSelect.value, introGranularity.value));
        introGranularity.addEventListener('change', () => renderIntroTrend(data, introSellerSelect.value, introGranularity.value));
        forecastSellerSelect.addEventListener('change', () => renderForecast(data, forecastSellerSelect.value || 'Overall'));
        cycleSellerSelect.addEventListener('change', () => renderCycleTime(data, cycleSellerSelect.value || 'Overall'));
        scorecardSellerSelect.addEventListener('change', () => {
          scorecardSelectedSeller = scorecardSellerSelect.value || 'Overall';
          renderScorecard(data);
        });
        versionSelect.addEventListener('change', async () => {
          const versionId = versionSelect.value;
          if (!versionId) return;
          try {
            const out = await fetchVersionData(versionId);
            if (!out || !out.dataset) return;
            data = out.dataset;
            window.__salesData = data;
            viewedVersionIdState = String(out.version_id || versionId);
            versionLikelihoodState = (out.likelihood && typeof out.likelihood === 'object') ? out.likelihood : {};
            isHistoricalView = !!latestVersionIdState && String(viewedVersionIdState) !== String(latestVersionIdState);
            likelihoodState = isHistoricalView
              ? JSON.parse(JSON.stringify(versionLikelihoodState))
              : JSON.parse(JSON.stringify(liveLikelihoodState || {}));
            rerenderAllViews();
            if (currentUser && currentUser.role === 'admin') {
              try {
                await supabaseRpc('save_dashboard_state', {
                  p_username: currentUser.username,
                  p_password: sessionPassword,
                  p_active_version_id: viewedVersionIdState,
                });
                activeVersionIdState = viewedVersionIdState;
              } catch (_) {}
            }
            const prevId = choosePreviousVersionId(viewedVersionIdState);
            if (compareRight) compareRight.value = viewedVersionIdState;
            if (compareLeft && prevId) compareLeft.value = prevId;
            if (momentumRight) momentumRight.value = viewedVersionIdState;
            if (momentumLeft && prevId) momentumLeft.value = prevId;
            runMomentumCompare();
          } catch (e) {
            showError(e.message || 'Failed to switch version.');
          }
        });
        compareRun.addEventListener('click', runCompare);
        comparePrev.addEventListener('click', () => {
          const rightId = (compareRight && compareRight.value) || viewedVersionIdState || activeVersionIdState || latestVersionIdState;
          const leftId = choosePreviousVersionId(rightId);
          if (compareRight && rightId) compareRight.value = rightId;
          if (compareLeft && leftId) compareLeft.value = leftId;
          runCompare();
        });
        momentumRun.addEventListener('click', runMomentumCompare);
        momentumPrev.addEventListener('click', () => {
          const rightId = (momentumRight && momentumRight.value) || viewedVersionIdState || activeVersionIdState || latestVersionIdState;
          const leftId = choosePreviousVersionId(rightId);
          if (momentumRight && rightId) momentumRight.value = rightId;
          if (momentumLeft && leftId) momentumLeft.value = leftId;
          runMomentumCompare();
        });
        momentumSeller.addEventListener('change', runMomentumCompare);
        momentumScope.addEventListener('change', runMomentumCompare);

        setMatterOnly();
        setFunnelCore();
        updateFunnelMonth();
        rerenderAllViews();
        setupTabs();
        initCycleTableControls();
        renderDetailTable('Details', []);
        if (compareRight && (viewedVersionIdState || activeVersionIdState || latestVersionIdState)) {
          const rightId = viewedVersionIdState || activeVersionIdState || latestVersionIdState;
          const leftId = choosePreviousVersionId(rightId);
          compareRight.value = rightId;
          if (leftId) compareLeft.value = leftId;
          if (leftId && rightId) runCompare();
          if (momentumRight) momentumRight.value = rightId;
          if (leftId && momentumLeft) momentumLeft.value = leftId;
          if (leftId && rightId) runMomentumCompare();
        }
        loginForm.addEventListener('submit', async (evt) => {
          evt.preventDefault();
          showAuthError('');
          const user = document.getElementById('auth-login-user').value;
          const pass = document.getElementById('auth-login-pass').value;
          const logged = await verifyLogin(user, pass);
          if (!logged) {
            showAuthError('Invalid username or password.');
            return;
          }
          sessionPassword = pass;
          saveSession(logged.username, pass, logged.role || 'viewer');
          applyLoggedInState(logged);
          renderVersionSelectors();
          viewedVersionIdState = activeVersionIdState || latestVersionIdState || viewedVersionIdState;
          if (viewedVersionIdState) {
            try {
              const out = await fetchVersionData(viewedVersionIdState);
              if (out && out.dataset) {
                data = out.dataset;
                window.__salesData = data;
                versionLikelihoodState = (out.likelihood && typeof out.likelihood === 'object') ? out.likelihood : {};
              }
            } catch (_) {}
          }
          isHistoricalView = !!latestVersionIdState && String(viewedVersionIdState || '') !== String(latestVersionIdState || '');
          likelihoodState = isHistoricalView
            ? JSON.parse(JSON.stringify(versionLikelihoodState || {}))
            : JSON.parse(JSON.stringify(liveLikelihoodState || {}));
          if (currentUser && currentUser.role === 'admin') {
            ensureOverallForecastTargets({ persist: !isHistoricalView });
          }
          rerenderAllViews();
          runMomentumCompare();
          document.getElementById('auth-login-user').value = '';
          document.getElementById('auth-login-pass').value = '';
        });

        function closeProfileMenu() {
          if (!profile) return;
          profile.classList.remove('open');
          if (profileBtn) profileBtn.setAttribute('aria-expanded', 'false');
        }

        function toggleProfileMenu(forceOpen) {
          if (!profile) return;
          const isOpen = profile.classList.contains('open');
          const next = (forceOpen == null) ? !isOpen : !!forceOpen;
          profile.classList.toggle('open', next);
          if (profileBtn) profileBtn.setAttribute('aria-expanded', next ? 'true' : 'false');
        }

        if (profileBtn) {
          profileBtn.addEventListener('click', (evt) => {
            evt.preventDefault();
            toggleProfileMenu();
          });
        }
        document.addEventListener('click', (evt) => {
          if (!profile || !profilePop || !profileBtn) return;
          if (profile.contains(evt.target)) return;
          closeProfileMenu();
        });
        document.addEventListener('keydown', (evt) => {
          if (evt.key === 'Escape') closeProfileMenu();
        });

        if (profileAdmin) {
          profileAdmin.addEventListener('click', () => {
            closeProfileMenu();
            if (activateTab) activateTab('admin');
          });
        }

        const renameBtn = document.getElementById('admin-version-rename-btn');
        if (renameBtn) {
          renameBtn.addEventListener('click', async () => {
            showAdminSyncMessage('');
            if (!currentUser || currentUser.role !== 'admin') {
              showAdminSyncMessage('Only admin users can rename versions.');
              return;
            }
            const versionId = (document.getElementById('version-select') && document.getElementById('version-select').value) || viewedVersionIdState || activeVersionIdState || latestVersionIdState;
            if (!versionId) {
              showAdminSyncMessage('No version selected.');
              return;
            }
            const notes = document.getElementById('admin-version-rename') ? document.getElementById('admin-version-rename').value : '';
            if (!String(notes || '').trim()) {
              showAdminSyncMessage('Enter a name to save.');
              return;
            }
            try {
              renameBtn.disabled = true;
              const out = await renameVersion(versionId, notes);
              if (out) applySharedStorePayload(out);
              renderVersionSelectors();
              showAdminSyncMessage('Version renamed.');
            } catch (e) {
              showAdminSyncMessage(e.message || 'Rename failed.');
            } finally {
              renameBtn.disabled = false;
            }
          });
        }

        profileLogout.addEventListener('click', () => {
          clearSession();
          currentUser = null;
          if (profile) profile.style.display = 'none';
          showLoginOrSetup();
        });

        adminUserForm.addEventListener('submit', async (evt) => {
          evt.preventDefault();
          showAdminMessage('');
          if (!currentUser || currentUser.role !== 'admin') {
            showAdminMessage('Only admin users can create credentials.');
            return;
          }
          const newUser = document.getElementById('admin-new-user').value;
          const newPass = document.getElementById('admin-new-pass').value;
          const newRole = document.getElementById('admin-new-role').value;
          try {
            await upsertUser(newUser, newPass, newRole, currentUser.username);
            renderAdminUsers();
            showAdminMessage(`Saved credentials for "${normalizeUsername(newUser)}".`);
            document.getElementById('admin-new-pass').value = '';
          } catch (e) {
            showAdminMessage(e.message || 'Unable to save user.');
          }
        });

        adminSyncForm.addEventListener('submit', async (evt) => {
          evt.preventDefault();
          showAdminSyncMessage('');
          if (!currentUser || currentUser.role !== 'admin') {
            showAdminSyncMessage('Only admin users can refresh Monday data.');
            return;
          }
          const btn = document.getElementById('admin-sync-btn');
          const boardInput = document.getElementById('admin-monday-board');
          const nameInput = document.getElementById('admin-monday-version-name');
          const boardRaw = boardInput ? boardInput.value : '';
          const versionName = nameInput ? nameInput.value : '';
          const boardId = parseBoardId(boardRaw);
          if (!boardId) {
            showAdminSyncMessage('Enter a valid Monday board URL/ID.');
            return;
          }
          dashboardSettingsState = {
            ...(dashboardSettingsState || {}),
            monday_board_id: boardId,
            monday_board_url: `https://themathcocrmtrial.monday.com/boards/${boardId}`,
          };
          persistLocalStateBundle();
          try {
            if (btn) btn.disabled = true;
            showAdminSyncMessage('Refreshing from Monday.com...');
            const out = await refreshFromMonday(boardRaw, versionName);
            showAdminSyncMessage(`Sync complete. Pulled ${money.format(Number(out.item_count || 0))} items from board ${out.board_name || boardId}. Reloading...`);
            setTimeout(() => window.location.reload(), 600);
          } catch (e) {
            showAdminSyncMessage(e.message || 'Sync failed.');
          } finally {
            if (btn) btn.disabled = false;
          }
        });

        const adminTargetQuarterInput = document.getElementById('admin-target-quarters');
        adminTargetQuarterInput.addEventListener('change', () => {
          renderAdminTargets();
          showAdminTargetMessage('Quarter columns updated. Edit values and click Save All Targets.');
        });

        adminTargetForm.addEventListener('submit', (evt) => {
          evt.preventDefault();
          showAdminTargetMessage('');
          if (!currentUser || currentUser.role !== 'admin') {
            showAdminTargetMessage('Only admin users can configure targets.');
            return;
          }
          const quarterInput = document.getElementById('admin-target-quarters');
          const quarters = parseQuarterColumns(quarterInput.value);
          if (!quarters.length) {
            showAdminTargetMessage("Enter at least one quarter, e.g., Q4'26, Q1'27.");
            return;
          }
          quarterInput.value = quarters.join(', ');
          const newState = {};
          const sellers = getTargetSellers();
          const gridInputs = Array.from(document.querySelectorAll('#admin-target-grid-body input[data-seller][data-quarter][data-metric]'));
          const valueFor = (seller, quarter, metric) => {
            const match = gridInputs.find((x) => x.dataset.seller === seller && x.dataset.quarter === quarter && x.dataset.metric === metric);
            return match ? match.value : '';
          };
          sellers.forEach((seller) => {
            quarters.forEach((quarter) => {
              const revenue = Math.max(0, Number(valueFor(seller, quarter, 'revenue') || 0));
              if (revenue > 0) {
                newState[quarterTargetKey(seller, quarter)] = {
                  seller,
                  quarter,
                  revenue: Number.isFinite(revenue) ? revenue : 0,
                };
              }
            });
          });
          quarterTargetsState = newState;
          persistLocalStateBundle();
          pushSharedStoreNow({ throwOnError: true }).then(() => {
            renderAdminTargets();
            if (window.__salesData) {
              renderScorecard(window.__salesData);
              renderForecast(window.__salesData, (document.getElementById('forecast-seller') && document.getElementById('forecast-seller').value) || 'Overall');
            }
            showAdminTargetMessage(`Saved targets for ${money.format(sellers.length)} seller(s) across ${money.format(quarters.length)} quarter(s).`);
          }).catch((e) => {
            showAdminTargetMessage(e.message || 'Unable to save target.');
          });
        });

        // (Removed) inspector wiring.

        const savedSession = loadSession();
        if (savedSession) {
          const logged = await verifyLogin(savedSession.username, savedSession.password);
          if (logged) {
            sessionPassword = savedSession.password;
            saveSession(logged.username, sessionPassword, logged.role || 'viewer');
            applyLoggedInState(logged);
            renderVersionSelectors();
            viewedVersionIdState = activeVersionIdState || latestVersionIdState || viewedVersionIdState;
            if (viewedVersionIdState) {
              try {
                const out = await fetchVersionData(viewedVersionIdState);
                if (out && out.dataset) {
                  data = out.dataset;
                  window.__salesData = data;
                  versionLikelihoodState = (out.likelihood && typeof out.likelihood === 'object') ? out.likelihood : {};
                }
              } catch (_) {}
            }
            isHistoricalView = !!latestVersionIdState && String(viewedVersionIdState || '') !== String(latestVersionIdState || '');
            likelihoodState = isHistoricalView
              ? JSON.parse(JSON.stringify(versionLikelihoodState || {}))
              : JSON.parse(JSON.stringify(liveLikelihoodState || {}));
            if (currentUser && currentUser.role === 'admin') {
              ensureOverallForecastTargets({ persist: !isHistoricalView });
            }
            rerenderAllViews();
          } else {
            clearSession();
            showLoginOrSetup();
          }
        } else {
          showLoginOrSetup();
        }
      } catch (err) {
        showError(err.message + '. Run a local server from this folder (for example: `python3 -m http.server 8000`).');
      }
    }

    boot();
  </script>
</body>
</html>
